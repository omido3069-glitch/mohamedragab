<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0"> 
<title>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª - ØªØ®Ø²ÙŠÙ† Ù…Ø­Ù„ÙŠ ÙˆØ±ÙØ¹ Ø¥Ù„Ù‰ Firebase</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">

<style>
    :root {
        --primary-bg: #e0f7fa; 
        --form-bg: #b2ebf2;     
        --input-bg: #ffffff; 
        --input-border: #cccccc; 
        --text-color: #333333; 
        --button-color: #ffc107; 
        --button-text-color: #000000; 
        --entry-color: #4CAF50;  
        --exit-color: #FF5252;   
        --warning-color: #FF9800; 
        --label-gradient: linear-gradient(90deg, #ffc107, #ff6f00, #ffc107);
    }

    body {
        font-family: 'Cairo', sans-serif;
        margin: 0;
        padding: 0; 
        color: var(--text-color);
        direction: rtl;
        text-align: right;
        min-height: 100vh;
        background: #f5f5f5; 
    }
    
    @keyframes textGradientMove {
        0% { background-position: 0% 50%; }
        100% { background-position: 100% 50%; }
    }

    .form-container {
        max-width: 600px; 
        margin: 0 auto;
        padding: 30px 15px; 
        background: none; 
    }

    .header-with-upload {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
    }

    .header-with-upload h2 {
        margin: 0;
        text-align: right;
        flex-grow: 1;
        font-size: 24px;
        font-weight: bold;
        color: var(--text-color);
    }

    #uploadBtn {
        width: 40px; 
        height: 40px; 
        padding: 0;
        margin: 0;
        font-size: 0; 
        display: flex;
        justify-content: center;
        align-items: center;
        background: var(--entry-color); 
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
        transition: background-color 0.3s;
    }

    #uploadBtn:hover {
        background: #45a049;
    }

    .upload-icon {
        width: 24px; 
        height: 24px;
    }


    .row-group {
        display: flex; 
        gap: 15px; 
        margin-bottom: 25px;
    }

    .row-group > .field-group {
        flex: 1; 
        margin-bottom: 0;
        min-width: 130px; 
    }
    
    .field-group {
        position: relative; 
        margin-bottom: 25px; 
    }

    label {
        font-size: 16px; 
        font-weight: 700;
        display: block;
        margin-bottom: 10px;
        text-align: center; 
        background: var(--label-gradient);
        background-size: 200% auto; 
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent; 
        animation: textGradientMove 15s linear infinite alternate; 
    }

    input, select, textarea {
        width: 100%;
        padding: 14px 15px; 
        background: var(--input-bg); 
        border: 2px solid var(--input-border);
        border-radius: 8px; 
        font-size: 18px; 
        color: var(--text-color);
        outline: none;
        transition: border-color 0.3s, box-shadow 0.3s;
        box-sizing: border-box; 
    }
    
    .search-filter-controls {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        padding: 0 15px;
        max-width: 100%;
        box-sizing: border-box;
    }
    
    #searchInput {
        flex-grow: 1;
        font-size: 16px;
        padding: 10px 15px;
    }
    
    #dateFilter {
        flex-shrink: 0; 
        width: 180px; 
        font-size: 16px;
        padding: 10px 15px;
        color: var(--text-color); 
        background: var(--input-bg); 
        -webkit-appearance: none; 
        appearance: none;
        cursor: pointer;
    }
    
    #number {
        font-size: 20px; 
        padding: 16px 15px; 
    }

    input:focus, select:focus, textarea:focus {
        border-color: var(--button-color); 
        box-shadow: 0 0 0 4px rgba(255, 193, 7, 0.3);
    }
    
    textarea {
        resize: vertical;
        height: 60px !important; 
    }

    button {
        width: 100%;
        padding: 15px;
        background: var(--button-color);
        border: none;
        border-radius: 8px;
        font-size: 20px;
        color: var(--button-text-color);
        font-weight: bold;
        cursor: pointer;
        margin-top: 20px;
        transition: background-color 0.3s, transform 0.1s;
    }

    button:hover {
        background: #f0b800;
    }
    
    /* Ø£Ù†Ù…Ø§Ø· Ø§Ù„ÙƒØ±ÙˆØª (Suggestions Cards) */
    #suggestionsContainer {
        position: absolute;
        bottom: 100%; 
        right: 0;
        left: 0;
        margin-bottom: 10px; 
        z-index: 99; 
        padding: 10px;
        background-color: transparent;
        max-height: 100px; 
        overflow-x: auto; 
        overflow-y: hidden;
        display: flex; 
        gap: 8px;
        pointer-events: none; 
    }

    .suggestion-card {
        flex-shrink: 0; 
        padding: 8px 12px;
        background-color: #ffffff; 
        border: 1px solid #ffc107; 
        border-radius: 6px;
        font-size: 14px;
        font-weight: bold;
        color: var(--text-color);
        cursor: pointer;
        transition: background-color 0.2s, transform 0.1s;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        white-space: nowrap; 
        text-align: center;
    }

    .suggestion-card:hover {
        background-color: #ffeb3b; 
        transform: translateY(-2px);
    }

    .suggestion-card-name {
        display: block;
        font-size: 10px;
        font-weight: normal;
        color: #666;
        margin-top: 2px;
    }

    /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
    .table-section {
        max-width: 100%;
        margin: 30px 0;
    }
    
    .table-container {
        overflow-x: hidden; 
        border-radius: 10px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
        margin: 0 15px; 
    }

    table {
        min-width: 100%; 
        width: 100%;
        border-collapse: collapse;
        text-align: right;
        background: none; 
        table-layout: fixed; 
    }
    
    .date-separator {
        background: #d0f8ff; 
        color: var(--button-color);
        font-weight: bold;
        text-align: center;
        font-size: 14px;
    }
    .date-separator td {
        padding: 10px;
        border: none;
        border-bottom: 2px solid #ffc107; 
    }

    th {
        background: #e0e0e0; 
        color: var(--button-color);
        font-weight: 700;
        font-size: 12px; 
        padding: 8px 4px; 
        border-bottom: 1px solid #aaaaaa;
        text-align: center;
        white-space: normal; 
        text-shadow: 0 0 3px rgba(0, 0, 0, 0.5); 
    }
    
    th, td {
        border-left: 1px solid #cccccc; 
        padding: 8px 4px; 
        text-align: center;
        font-size: 11px; 
        border-bottom: 1px solid #aaaaaa;
        color: var(--text-color);
        white-space: normal; 
        word-wrap: break-word; 
    }
    
    .entry-time {
        color: var(--entry-color) !important;
        font-weight: bold;
    }
    
    td:last-child, th:last-child {
        border-left: none;
    }

    .exit-btn {
        background: #dc3545; 
        padding: 4px 6px; 
        border: none;
        color: white;
        border-radius: 6px;
        cursor: pointer;
        font-size: 12px; 
        transition: background-color 0.3s;
        width: auto; 
    }

    .exit-btn:hover {
        background: #c82333;
    }

    .exited {
        background: #ffebee;
        color: var(--exit-color) !important; 
        font-weight: bold;
        display: block; 
        padding: 4px 0;
        border-radius: 6px;
    }
    
    #toast {
        visibility: hidden; 
        min-width: 250px; 
        background-color: #333; 
        color: #fff; 
        text-align: center; 
        border-radius: 12px; 
        padding: 16px; 
        position: fixed; 
        z-index: 10; 
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%); 
        font-size: 17px;
        font-weight: bold;
        box-shadow: 0 0 15px rgba(0,0,0,0.5); 
        transition: opacity 0.5s, visibility 0.5s;
        opacity: 0;
    }

    #toast.success {
        background-color: var(--entry-color); 
    }
    #toast.danger {
        background-color: var(--exit-color); 
    }

    #toast.warning {
        background-color: var(--warning-color); 
    }

    #toast.show {
        visibility: visible; 
        opacity: 1;
    }
    
</style>
</head>
<body>

<div id="toast"></div>
<div class="form-container">
    
    <div class="header-with-upload">
        <h2>ØªØ³Ø¬ÙŠÙ„ ÙŠÙˆÙ…ÙŠ Ù„Ù„Ø³ÙŠØ§Ø±Ø§Øª</h2>
        <button id="uploadBtn" onclick="uploadCarsToFirebase()" title="Ø±ÙØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø¥Ù„Ù‰ Firebase">
            <svg class="upload-icon" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L6.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
            </svg>
        </button>
    </div>

    <form id="carForm">
        
        <div class="row-group">
            <div class="field-group">
                <label for="name">Ø§Ù„Ø§Ø³Ù… / Ø§Ù„Ø³Ø§Ø¦Ù‚</label>
                <input id="name" type="text" required placeholder="Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚">
            </div>

            <div class="field-group">
                <label for="gate">Ø¬Ù‡Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„</label>
                <input id="gate" type="text" required placeholder="Ø§Ø¯Ø®Ù„ Ø¬Ù‡Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„">
            </div>
        </div>
        
        <div class="field-group">
            <label for="notes">Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
            <textarea id="notes" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø­ÙˆÙ„ Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ø£Ùˆ Ø§Ù„Ø²ÙŠØ§Ø±Ø©"></textarea>
        </div>

        <div class="field-group">
            <label for="number">Ø±Ù‚Ù… Ø§Ù„Ø³ÙŠØ§Ø±Ø© (Ø§Ù„Ù„ÙˆØ­Ø©)</label>
            <div id="suggestionsContainer"></div> 
            <input id="number" type="text" required placeholder="Ø§Ø¯Ø®Ù„ Ø±Ù‚Ù… Ù„ÙˆØ­Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø©" oninput="displaySuggestions()"> 
        </div>
        
        <button type="button" onclick="addCar()">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¢Ù†</button>
    </form>
</div>

<div class="table-section">
    <div class="search-filter-controls">
        <input type="text" id="searchInput" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø©..." onkeyup="filterTable()">
        
        <select id="dateFilter" onchange="startRealtimeListener()">
            <option value="">ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® (Ø§Ù„ÙŠÙˆÙ…)</option> 
        </select>
    </div>
    
    <div class="table-container">
        <table id="carsTable">
            <thead>
                <tr>
                    <th>Ø§Ù„Ø§Ø³Ù…</th>
                    <th>Ø±Ù‚Ù… Ø§Ù„Ø³ÙŠØ§Ø±Ø©</th>
                    <th>Ø¯Ø®ÙˆÙ„</th>
                    <th>Ø¬Ù‡Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„</th> 
                    <th>Ø®Ø±ÙˆØ¬</th> 
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
// ØªÙ‡ÙŠØ¦Ø© Firebase - Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ
const firebaseConfig = {
  apiKey: "AIzaSyDxZnTzssVZWtGR5iD6feE5d3BUFX3T5E0",
  authDomain: "companies-4bcc8.firebaseapp.com",
  databaseURL: "https://companies-4bcc8-default-rtdb.firebaseio.com",
  projectId: "companies-4bcc8",
  storageBucket: "companies-4bcc8.firebasestorage.app",
  messagingSenderId: "688630422572",
  appId: "1:688630422572:web:580391a664b0193383c589",
  measurementId: "G-KPHEF2BY6M"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const carsDayRef = db.ref('cars day'); // Reference for daily records
const carsDataRef = db.ref('cars'); // Reference for master suggestions data

// Ù…ÙØ§ØªÙŠØ­ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ
const LOCAL_ENTRIES_KEY = 'carDailyRecords';
const LOCAL_MASTER_KEY = 'masterCarDetails';

// Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù„Ù…ÙŠØ© Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹
let masterCarData = {}; 
let carEntries = [];    
let firebaseRecords = {}; // ØªØ®Ø²ÙŠÙ† Ø³Ø¬Ù„Ø§Øª Firebase Ø§Ù„ØªÙŠ ØªÙ… Ø¬Ù„Ø¨Ù‡Ø§ Ø¢Ø®Ø± Ù…Ø±Ø©

// Ù…ØªØºÙŠØ± Ù„ØªØ®Ø²ÙŠÙ† Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ù†Ø´Ø· (Ù„Ø¥ÙŠÙ‚Ø§ÙÙ‡ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„ØªØ§Ø±ÙŠØ®)
let activeListenerRef = null; 

// =================================================================================
// ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ (Local Storage Utilities)
// =================================================================================

function loadLocalRecords() {
    const data = localStorage.getItem(LOCAL_ENTRIES_KEY);
    carEntries = data ? JSON.parse(data) : [];
}

function saveLocalRecords() {
    localStorage.setItem(LOCAL_ENTRIES_KEY, JSON.stringify(carEntries));
}

function loadLocalMasterData() {
    const data = localStorage.getItem(LOCAL_MASTER_KEY);
    masterCarData = data ? JSON.parse(data) : {};
}

function saveLocalMasterData(carNumber, details) {
    masterCarData[carNumber] = details;
    localStorage.setItem(LOCAL_MASTER_KEY, JSON.stringify(masterCarData));
}

// =================================================================================
// Ø¯Ø§Ù„Ø©: ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª (Master Data) Ù…Ù† Firebase Ø£ÙˆÙ„Ø§Ù‹
// =================================================================================
function loadMasterCarData() {
    carsDataRef.once('value', snapshot => {
        let firebaseData = {};
        
        if (snapshot.exists()) {
            snapshot.forEach(childSnapshot => {
                const val = childSnapshot.val();
                const carNumber = val.carNumber ? val.carNumber.trim() : null; 
                
                if (carNumber) {
                    firebaseData[carNumber] = {
                        name: val.ownerName || '', 
                        gate: val.entrance || '',
                        notes: val.notes || ''
                    };
                }
            });
            
            masterCarData = firebaseData;
            localStorage.setItem(LOCAL_MASTER_KEY, JSON.stringify(masterCarData));
            showToast("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ù…Ù† Firebase Ø¨Ù†Ø¬Ø§Ø­.", 'success');

        } else {
            loadLocalMasterData(); 
            showToast("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª ÙÙŠ Firebase. ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©.", 'warning');
        }
        
    }, error => {
        console.error("Firebase fetch error, loading local suggestions:", error);
        loadLocalMasterData();
        showToast("ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Firebase. ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ø§Ù„Ù…Ø®Ø²Ù†Ø© Ù…Ø­Ù„ÙŠØ§Ù‹.", 'danger');
    });
}
// =================================================================================
// ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¹Ø±Ø¶ ÙˆØ§Ù„Ù…Ù†Ø·Ù‚
// =================================================================================

function getCurrentDateTimeParts() {
    let d = new Date();
    // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù„ÙŠÙƒÙˆÙ† Ù…ØªÙˆØ§ÙÙ‚Ø§Ù‹ Ù…Ø¹ Ù…ÙØ§ØªÙŠØ­ Firebase (YYYY-MM-DD)
    const dateOnly = d.toLocaleDateString('en-CA', { year: 'numeric', month: '2-digit', day: '2-digit' }); 
    // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙˆÙ‚Øª Ù„Ù„Ø¹Ø±Ø¶
    const timeOnly = d.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit', hour12: true }); 

    return { date: dateOnly, time: timeOnly, timestamp: d.getTime() };
}

function showToast(message, type = 'default') {
    let toast = document.getElementById("toast");
    toast.textContent = message;
    
    toast.className = ''; 
    toast.classList.add('show');
    toast.classList.add(type);

    setTimeout(function(){ 
        toast.classList.remove('show');
    }, 3000); 
}


function displaySuggestions() {
    const numberInput = document.getElementById('number');
    const container = document.getElementById('suggestionsContainer');
    const searchTerm = numberInput.value.toUpperCase().trim(); 
    
    container.innerHTML = '';
    
    let suggestionCount = 0;
    
    for (const carNumber in masterCarData) {
        if (searchTerm.length === 0 || 
            carNumber.toUpperCase().includes(searchTerm) || 
            masterCarData[carNumber].name.toUpperCase().includes(searchTerm)) {
            
            if (suggestionCount >= 5) { 
                break;
            }
            
            const data = masterCarData[carNumber];
            const card = document.createElement('div');
            
            card.classList.add('suggestion-card');
            card.setAttribute('onclick', `fillCarDetails('${carNumber}')`);
            
            card.innerHTML = `
                ${carNumber}
                <span class="suggestion-card-name">${data.name}</span>
            `;
            
            container.appendChild(card);
            suggestionCount++;
        }
    }
    
    if (suggestionCount > 0) {
        container.style.pointerEvents = 'auto'; 
    } else {
        container.style.pointerEvents = 'none';
    }
}


function fillCarDetails(carNumber) {
    const numberInput = document.getElementById('number');
    const container = document.getElementById('suggestionsContainer');
    
    if (masterCarData[carNumber]) {
        const data = masterCarData[carNumber];
        
        numberInput.value = carNumber; 
        document.getElementById('name').value = data.name;
        document.getElementById('gate').value = data.gate;
        document.getElementById('notes').value = data.notes;
        
        container.innerHTML = '';
        container.style.pointerEvents = 'none';
        
        showToast(`ØªÙ… Ù…Ù„Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ø±Ù‚Ù… ${carNumber}`, 'success');
    }
}

function checkIfCarIsInside(carNumber) {
    // 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© ØºÙŠØ± Ø§Ù„Ù…Ø±ÙÙˆØ¹Ø©
    const isLocalInside = carEntries.some(car => car.number === carNumber && !car.exitTime);

    // 2. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø±ÙÙˆØ¹Ø© (Firebase) Ù„Ù„ÙŠÙˆÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ
    // Ù†Ø³ØªØ®Ø¯Ù… firebaseRecords Ø§Ù„Ù…Ø®Ø²Ù†Ø© ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø§Ù„ÙŠ
    const isFirebaseInside = Object.values(firebaseRecords).some(entry => 
        entry.number === carNumber && !entry.exitTime
    );

    return isLocalInside || isFirebaseInside;
}

/**
 * ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø³ÙŠØ§Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø©: ÙŠØªÙ… ØªØ®Ø²ÙŠÙ†Ù‡Ø§ Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙ‚Ø·.
 */
function addCar() {
    let name = document.getElementById("name").value;
    let number = document.getElementById("number").value.trim(); 
    let gate = document.getElementById("gate").value;
    let notes = document.getElementById("notes").value; 
    
    if (!name || !number || !gate) {
        showToast("âš ï¸ Ù…Ù† ÙØ¶Ù„Ùƒ Ø£ÙƒÙ…Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©", 'warning');
        return;
    }
    
    let dateTime = getCurrentDateTimeParts();
    const normalizedNumber = number.toUpperCase().replace(/\s/g, '');
    const uniqueKey = `${normalizedNumber}--${dateTime.timestamp}`; 

    if (checkIfCarIsInside(number)) {
        showToast(`âŒ Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ø±Ù‚Ù… ${number} Ù…Ø³Ø¬Ù„Ø© Ø¨Ø§Ù„ÙØ¹Ù„ Ø¯Ø®ÙˆÙ„ Ø§Ù„ÙŠÙˆÙ… ÙˆÙ„Ù… ØªØ®Ø±Ø¬ Ø¨Ø¹Ø¯.`, 'warning');
        return;
    }

    // 1. Ø¥Ù†Ø´Ø§Ø¡ ÙƒØ§Ø¦Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯
    const newCarEntry = {
        uniqueKey: uniqueKey, 
        name: name,
        number: number,
        gate: gate,
        notes: notes,
        entryTime: dateTime.time,
        entryDate: dateTime.date, 
        timestamp: dateTime.timestamp, 
        isUploaded: false // ØªÙ… ØªØ¹ÙŠÙŠÙ†Ù‡Ø§ false Ù„ØªØ¸Ù‡Ø± ÙÙŠ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø±ÙØ¹
    };

    // 2. Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø¬Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ù…ØµÙÙˆÙØ© Ø§Ù„Ù…Ø­Ù„ÙŠØ© ÙˆØ­ÙØ¸Ù‡Ø§
    carEntries.unshift(newCarEntry); 
    saveLocalRecords(); 

    // 3. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø«Ø§Ø¨ØªØ© Ù„Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹
    saveLocalMasterData(normalizedNumber, {
        name: name,
        gate: gate,
        notes: notes 
    });
    
    // 4. Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„ (Ù„Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Firebase + Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©)
    // Ù„Ø§ Ù†Ø­ØªØ§Ø¬ Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ loadCars Ù‡Ù†Ø§ Ù„Ø£Ù† startRealtimeListener Ø´ØºØ§Ù„Ø© ÙˆØªØ­Ø¯Ø« Ù†ÙØ³Ù‡Ø§
    // ÙˆÙ„ÙƒÙ† Ù†Ø­ØªØ§Ø¬Ù‡Ø§ Ù„Ø¯Ù…Ø¬ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø­Ù„ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯
    renderTable(); 

    // 5. Ù…Ø³Ø­ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ÙˆØ§Ù„Ø¥Ø´Ø¹Ø§Ø±
    document.getElementById('suggestionsContainer').innerHTML = '';
    document.getElementById('suggestionsContainer').style.pointerEvents = 'none';
    showToast(`âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ø±Ù‚Ù… ${number} Ù…Ø­Ù„ÙŠØ§Ù‹`, 'success');
    document.getElementById("carForm").reset();
}

/**
 * Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø©: ØªØ¬Ù„Ø¨ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø±ÙÙˆØ¹ Ù…Ù† Firebase Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„ÙØ±ÙŠØ¯.
 */
function getFirebaseEntry(uniqueKey) {
    const entry = firebaseRecords[uniqueKey];
    if (entry) {
        // Ù†Ø¶Ù…Ù† Ø£Ù† Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„ÙØ±ÙŠØ¯ Ù…ÙˆØ¬ÙˆØ¯ ÙˆØ£Ù†Ù‡Ø§ Ù…Ø¹Ù„Ù…Ø© ÙƒÙ…Ø±ÙÙˆØ¹Ø©
        return { ...entry, uniqueKey: uniqueKey, isUploaded: true };
    }
    return null;
}


/**
 * ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬: ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¬Ù„ ÙÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ ÙÙ‚Ø·ØŒ Ø£Ùˆ Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ Ø®Ø±ÙˆØ¬ Ù…Ø¤Ù‚Øª.
 */
function exitCar(btn, uniqueKey) { 
    let dateTime = getCurrentDateTimeParts();
    let entryIndex = carEntries.findIndex(entry => entry.uniqueKey === uniqueKey);
    let originalEntry = null;

    if (entryIndex !== -1) {
        // 1. Ø§Ù„Ø³Ø¬Ù„ Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø­Ù„ÙŠØ§Ù‹ (ØºÙŠØ± Ù…Ø±ÙÙˆØ¹)
        carEntries[entryIndex].exitTime = dateTime.time;
        carEntries[entryIndex].isUploaded = false; 
        
        showToast(`ğŸ‘‹ ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø­Ù„ÙŠ Ø¨Ù†Ø¬Ø§Ø­. Ø§Ø¶ØºØ· Ø±ÙØ¹!`, 'danger');

    } else {
        // 2. Ø§Ù„Ø³Ø¬Ù„ Ù…Ø±ÙÙˆØ¹ Ø¹Ù„Ù‰ Firebase (ÙŠØ¬Ø¨ Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ Ù…Ø­Ù„ÙŠ Ø¬Ø¯ÙŠØ¯ Ø¨Ø§Ù„Ø®Ø±ÙˆØ¬)
        originalEntry = getFirebaseEntry(uniqueKey);

        if (originalEntry && !originalEntry.exitTime) {
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ Ù…Ø­Ù„ÙŠ Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø®Ø±ÙˆØ¬
            const newLocalExitEntry = {
                ...originalEntry,
                exitTime: dateTime.time,
                isUploaded: false, // ÙŠØ¬Ø¨ Ø±ÙØ¹ Ù‡Ø°Ø§ Ø§Ù„ØªØ­Ø¯ÙŠØ«
                // Ù„ÙƒÙŠ Ù„Ø§ ÙŠØ¸Ù‡Ø± Ø³Ø¬Ù„Ø§Ù† Ù„Ù†ÙØ³ Ø§Ù„Ø³ÙŠØ§Ø±Ø©ØŒ Ù†Ø­Ø°Ù Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„
                name: originalEntry.name, 
                number: originalEntry.number,
            };

            // Ù†Ø­ØªØ§Ø¬ Ù„ÙÙ„ØªØ±Ø© carEntries Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ù…Ø­Ù„ÙŠ Ù‚Ø¯ÙŠÙ… Ù„Ù†ÙØ³ Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„ÙØ±ÙŠØ¯
            carEntries = carEntries.filter(entry => entry.uniqueKey !== uniqueKey);
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ø§Ù„Ù…Ø­Ø¯Ø«) Ø¥Ù„Ù‰ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
            carEntries.unshift(newLocalExitEntry); 
            showToast(`ğŸ‘‹ ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬. Ø§Ø¶ØºØ· Ø±ÙØ¹ Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¥Ù„Ù‰ Firebase.`, 'danger');
            
        } else if (originalEntry && originalEntry.exitTime) {
             showToast(`âŒ Ø§Ù„Ø³ÙŠØ§Ø±Ø© ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬Ù‡Ø§ Ù…Ø³Ø¨Ù‚Ø§Ù‹ ÙÙŠ Firebase.`, 'warning');
             return;
        } else {
             showToast(`âŒ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¬Ù„ Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬.`, 'warning');
             return;
        }
    }
    
    saveLocalRecords();
    renderTable(); // Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù„ÙŠØ¹ÙƒØ³ Ø§Ù„ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø­Ù„ÙŠ
}

/**
 * Ø¯Ø§Ù„Ø© Ø§Ù„Ø±ÙØ¹: ØªØ±Ø³Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª ØºÙŠØ± Ø§Ù„Ù…Ø±ÙÙˆØ¹Ø© Ø«Ù… ØªØ­Ø°ÙÙ‡Ø§ Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ.
 */
function uploadCarsToFirebase() {
    // 1. ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªÙŠ ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø±ÙØ¹ (isUploaded: false)
    const recordsToUpload = carEntries.filter(entry => !entry.isUploaded);

    if (recordsToUpload.length === 0) {
        showToast("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø±ÙØ¹.", 'warning');
        return;
    }

    showToast(`Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ ${recordsToUpload.length} Ø³Ø¬Ù„... Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±`, 'warning');
    document.getElementById('uploadBtn').disabled = true;

    const updates = {};
    const masterUpdates = {};

    recordsToUpload.forEach(entry => {
        const entryDate = entry.entryDate;
        const key = entry.uniqueKey; 
        const normalizedNumber = entry.number.toUpperCase().replace(/\s/g, '');

        // 2. ØªØ­Ø¯ÙŠØ« Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„ÙŠÙˆÙ…ÙŠ (cars day/DATE/KEY)
        updates[`cars day/${entryDate}/${key}`] = {
            name: entry.name,
            number: entry.number,
            gate: entry.gate,
            notes: entry.notes || '',
            entryTime: entry.entryTime,
            entryDate: entry.entryDate,
            timestamp: entry.timestamp,
            exitTime: entry.exitTime || null 
        };

        // 3. ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ø§Ù„Ø«Ø§Ø¨ØªØ© (cars/NORMALIZED_NUMBER)
        masterUpdates[`cars/${normalizedNumber}`] = {
            carNumber: entry.number,
            ownerName: entry.name,
            entrance: entry.gate,
            notes: entry.notes || ''
        };
    });
    
    // 4. Ø¥Ø±Ø³Ø§Ù„ ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©
    db.ref().update(updates)
        .then(() => {
            // 5. Ø¥Ø±Ø³Ø§Ù„ ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø«Ø§Ø¨ØªØ© (Ù„Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª)
            return db.ref().update(masterUpdates);
        })
        .then(() => {
            // ***** Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø±ÙÙˆØ¹Ø© Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ *****
            const uploadedKeys = recordsToUpload.map(e => e.uniqueKey);
            
            // ØªØµÙÙŠØ© carEntries Ù„Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªÙŠ Ù„Ù… ÙŠØªÙ… Ø±ÙØ¹Ù‡Ø§
            carEntries = carEntries.filter(entry => !uploadedKeys.includes(entry.uniqueKey));
            
            // 6. Ø­ÙØ¸ Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµÙÙˆÙØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù…Ø­Ù„ÙŠØ§Ù‹
            saveLocalRecords();
            
            showToast(`âœ… ØªÙ… Ø±ÙØ¹ ${recordsToUpload.length} Ø³Ø¬Ù„ ÙˆØ­Ø°ÙÙ‡Ø§ Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ!`, 'success');
            
            // 7. Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Firebase listener Ø³ÙŠÙ‚ÙˆÙ… Ø¨Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØŒ Ù„ÙƒÙ† Ù†Ø­ØªØ§Ø¬ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª)
            loadMasterCarData(); 
        })
        .catch(error => {
            // 8. ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ØŒ Ù„Ø§ ÙŠØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ
            showToast(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø±ÙØ¹. Ù„Ù… ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©. ${error.message}`, 'danger');
        })
        .finally(() => {
            document.getElementById('uploadBtn').disabled = false;
        });
}


/**
 * Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©: ØªØ¨Ø¯Ø£ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„ÙØ¹Ù„ÙŠ Ù„ØªØ§Ø±ÙŠØ® Ù…Ø­Ø¯Ø¯.
 */
function startRealtimeListener() {
    
    // 1. ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® Ø§Ù„ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„ÙŠ
    const todayDate = getCurrentDateTimeParts().date;
    let selectedDate = document.getElementById('dateFilter').value;
    
    if (!selectedDate) {
        selectedDate = todayDate; 
        document.getElementById('dateFilter').value = selectedDate;
    }

    // 2. Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ù„Ù…Ù†Ø¹ ØªØ¶Ø§Ø±Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    if (activeListenerRef) {
        activeListenerRef.off();
    }
    
    // 3. ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙˆØ¨Ø¯Ø¡ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹
    const datePath = `cars day/${selectedDate}`;
    const newListenerRef = db.ref(datePath);
    activeListenerRef = newListenerRef;

    showToast(`Ø¬Ø§Ø±Ù Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª ${selectedDate}...`, 'default');

    newListenerRef.on('value', snapshot => {
        
        firebaseRecords = snapshot.val() || {}; // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ
        
        // Ø¨Ù…Ø¬Ø±Ø¯ ÙˆØµÙˆÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©ØŒ Ù†Ù‚ÙˆÙ… Ø¨Ø±Ø³Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ù…Ø¬Ø©
        renderTable(); 
        
        // showToast(`ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§!`, 'success'); 

    }, error => {
        console.error("Firebase Realtime Listener Error:", error);
        showToast("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù€ Firebase. Ø­Ø§ÙˆÙ„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©.", 'danger');
    });
    
    // Ù„Ø¶Ù…Ø§Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„ÙÙ„ØªØ± ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
    populateDateFilter([]); 
}


/**
 * Ø¯Ø§Ù„Ø© Ù…ÙØ­Ø¯Ù‘ÙØ«Ø©: Ø±Ø³Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© Ø­Ø§Ù„ÙŠØ§Ù‹ ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø©.
 */
function renderTable() {
    loadLocalRecords();
    const tableBody = document.getElementById("carsTable").querySelector("tbody");
    tableBody.innerHTML = ""; 

    const selectedDate = document.getElementById('dateFilter').value;
    
    // 1. Ø¯Ù…Ø¬ Ø³Ø¬Ù„Ø§Øª Firebase ÙˆØ³Ø¬Ù„Ø§Øª Local (Ù„Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø­Ø¯Ø¯ ÙÙ‚Ø·)
    let finalCombinedEntriesMap = new Map();
    
    // Ø£. Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„Ø§Øª Firebase Ø£ÙˆÙ„Ø§Ù‹
    Object.keys(firebaseRecords).forEach(key => {
        const entry = firebaseRecords[key];
        // ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø±ÙÙˆØ¹Ø© ØªØ­Ù…Ù„ Ù†ÙØ³ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø®ØªØ§Ø±
        if (entry.entryDate === selectedDate) { 
            entry.uniqueKey = key; 
            entry.isUploaded = true; 
            finalCombinedEntriesMap.set(entry.uniqueKey, entry);
        }
    });
    
    // Ø¨. Ø¥Ø¶Ø§ÙØ©/ØªØ­Ø¯ÙŠØ« Ø³Ø¬Ù„Ø§Øª Local ØºÙŠØ± Ø§Ù„Ù…Ø±ÙÙˆØ¹Ø© (ØªØ¹Ø·ÙŠ Ø£ÙˆÙ„ÙˆÙŠØ© Ø¹Ù„Ù‰ Ø³Ø¬Ù„Ø§Øª Firebase Ø¨Ù†ÙØ³ Ø§Ù„Ù…ÙØªØ§Ø­)
    const unsyncedLocalEntries = carEntries.filter(entry => 
        !entry.isUploaded && entry.entryDate === selectedDate
    );
    
    unsyncedLocalEntries.forEach(entry => finalCombinedEntriesMap.set(entry.uniqueKey, entry));
    
    // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¥Ù„Ù‰ Ù…ØµÙÙˆÙØ© Ù„Ù„ÙØ±Ø² ÙˆØ§Ù„Ø¹Ø±Ø¶
    let finalEntriesArray = Array.from(finalCombinedEntriesMap.values());
    
    // 2. ÙØ±Ø² Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ù…Ø¬Ø©
    finalEntriesArray.sort((a, b) => b.timestamp - a.timestamp);

    // 3. Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ù…Ø¬Ø©
    let lastDate = "";
    finalEntriesArray.forEach(entry => {
        const entryDate = entry.entryDate;
        const isLocalUnsynced = !entry.isUploaded;

        if (entryDate !== lastDate) {
            let separatorRow = document.createElement("tr");
            separatorRow.classList.add('date-separator');
            
            const dateParts = new Date(entryDate).toLocaleDateString('ar-EG', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            
            separatorRow.innerHTML = `<td colspan="5">${dateParts}</td>`; 
            separatorRow.setAttribute('data-separator-date', entryDate); 
            tableBody.appendChild(separatorRow);
            lastDate = entryDate;
        }

        let exitContent;
        if (entry.exitTime) {
            exitContent = `<span class="exited">${entry.exitTime}</span>`;
        } else {
             // Ø²Ø± Ø§Ù„Ø®Ø±ÙˆØ¬ ÙŠØ¸Ù‡Ø± Ù„ÙƒÙ„ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª Ø§Ù„ØªÙŠ Ù„Ù… ØªØ³Ø¬Ù„ Ø®Ø±ÙˆØ¬
            exitContent = `<button class="exit-btn" onclick="exitCar(this, '${entry.uniqueKey}')">Ø®Ø±ÙˆØ¬</button>`;
        }
                
        // Ø¥Ø¶Ø§ÙØ© Ø¹Ù„Ø§Ù…Ø© Ø¨ØµØ±ÙŠØ© Ù„Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© ØºÙŠØ± Ø§Ù„Ù…Ø±ÙÙˆØ¹Ø©
        const nameContent = isLocalUnsynced ? `<span style="color:red; font-weight: bold;">(Ù„Ù… ÙŠØ±ÙØ¹)</span> ${entry.name}` : entry.name;
                
        let row = document.createElement("tr");
        row.innerHTML = `
            <td>${nameContent}</td>
            <td>${entry.number}</td>
            <td class="entry-time">${entry.entryTime}</td> 
            <td>${entry.gate}</td> 
            <td class="exitCell">${exitContent}</td>
        `;
        row.setAttribute('data-entry-date', entryDate); 
        row.setAttribute('data-notes', entry.notes || ''); 

        tableBody.appendChild(row);
    });
    
    // 4. ØªØ­Ø¯ÙŠØ« ÙÙ„ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ® (Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ù…Ù†ÙØµÙ„ Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ù…ØªØ§Ø­Ø©)
    updateAvailableDates();
    
    // 5. ØªØ·Ø¨ÙŠÙ‚ ÙÙ„ØªØ±Ø© Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù†ØµÙŠ
    filterTable(); 
}

/* *************************************************************************
   ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ÙÙ„ØªØ±Ø© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©
   ************************************************************************* */

/**
 * Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©: Ù„Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ù…ØªØ§Ø­Ø© ÙÙŠ Firebase Ù„Ù…Ù„Ø¡ Ø§Ù„ÙÙ„ØªØ±.
 */
function updateAvailableDates() {
    const filterSelect = document.getElementById("dateFilter");
    const currentValue = filterSelect.value;
    const firstOption = filterSelect.options[0]; 

    // Ù…Ø³Ø­ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¨Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø£ÙˆÙ„
    while (filterSelect.options.length > 1) {
        filterSelect.remove(1);
    }

    carsDayRef.once('value', snapshot => {
        const dates = new Set();
        if (snapshot.exists()) {
            snapshot.forEach(childSnapshot => {
                dates.add(childSnapshot.key);
            });
        }
        
        const sortedDates = Array.from(dates).sort((a, b) => b.localeCompare(a));
        
        // 3. Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        sortedDates.forEach(date => {
            const dateDisplay = new Date(date).toLocaleDateString('ar-EG', { year: 'numeric', month: '2-digit', day: '2-digit' });
            
            const option = document.createElement('option');
            option.value = date;
            option.textContent = dateDisplay;
            filterSelect.appendChild(option);
        });

        // 4. Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© Ø£Ùˆ ØªØ¹ÙŠÙŠÙ†Ù‡Ø§ Ù„Ù„ÙŠÙˆÙ…
        if (currentValue && sortedDates.includes(currentValue)) {
            filterSelect.value = currentValue;
        } else {
            const todayDate = getCurrentDateTimeParts().date;
             if (sortedDates.includes(todayDate)) {
                 filterSelect.value = todayDate;
             } else if (sortedDates.length > 0) {
                 filterSelect.value = sortedDates[0];
             }
        }
    });
}

function filterTable() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
    const rows = document.getElementById('carsTable').querySelector('tbody').querySelectorAll('tr');

    rows.forEach(row => {
        // Ø¥Ø°Ø§ ÙƒØ§Ù† ÙØ§ØµÙ„ ØªØ§Ø±ÙŠØ®ØŒ Ù†Ø¹Ø±Ø¶Ù‡ Ø«Ù… Ù†ØªØ¬Ø§ÙˆØ² Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù…Ù†Ø·Ù‚
        if (row.classList.contains('date-separator')) {
            row.style.display = ''; 
            return;
        } 
        
        // Ù…Ù†Ø·Ù‚ ÙÙ„ØªØ±Ø© ØµÙ Ø§Ù„Ø³ÙŠØ§Ø±Ø© (ÙÙ‚Ø· Ø¨Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù†ØµÙŠ)
        const name = row.cells[0].textContent.toLowerCase();
        const number = row.cells[1].textContent.toLowerCase();

        const matchesSearch = (name.includes(searchTerm) || number.includes(searchTerm));

        if (matchesSearch) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}


// Ø§Ù„Ø¨Ø¯Ø¡ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
document.addEventListener('DOMContentLoaded', () => {
    loadMasterCarData();      // ÙŠØ­Ù…Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©
    startRealtimeListener();  // ÙŠØ¨Ø¯Ø£ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„ÙŠÙˆÙ… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
}); 
</script>

</body>
</html>

