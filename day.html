<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù†Ø¸Ø§Ù… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª â€” Ø¬Ø§Ù…Ø¹Ø© Ø­Ù„ÙˆØ§Ù† Ø§Ù„Ø£Ù‡Ù„ÙŠØ©</title>

  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@600;800&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

  <style>
    :root{
      --blue-dark: #0d47a1;
      --blue-soft: #e7f3ff;
      --card-blue: #d8eefe;
      --accent: #1976d2;
      --black-bold: #0b0b0b;
      --danger: #d32f2f;
      --green: #2e7d32;
    }

    html,body{height:100%;margin:0}
    body{
      font-family:'Cairo',sans-serif;
      background: linear-gradient(180deg,#f8fbff 0%, #e9f7ff 100%);
      color: var(--black-bold);
      -webkit-font-smoothing:antialiased;
      -moz-osx-osx-smoothing:grayscale;
      display:flex;
      flex-direction:column;
      align-items:center;
      padding:14px;
    }
    
    /* --- NEW --- */
    /* Ø²Ø± Ø§Ù„Ø±Ø¬ÙˆØ¹ */
    .header-wrap {
      width: 100%;
      max-width: 520px;
      display: flex;
      align-items: center;
      justify-content: center; /* ÙŠØ±ÙƒØ² Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙÙŠ Ø§Ù„Ù…Ù†ØªØµÙ */
      position: relative; /* Ø¶Ø±ÙˆØ±ÙŠ Ù„ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ Ø²Ø± Ø§Ù„Ø±Ø¬ÙˆØ¹ */
      margin-top: 10px;
      margin-bottom: 4px;
    }

    .back-btn {
      position: absolute;
      right: 0; /* ÙŠØ¶Ø¹ Ø§Ù„Ø²Ø± ÙÙŠ Ø£Ù‚ØµÙ‰ Ø§Ù„ÙŠÙ…ÙŠÙ† */
      top: 50%;
      transform: translateY(-50%);
      color: var(--accent);
      font-size: 28px; /* Ø­Ø¬Ù… Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© */
      text-decoration: none;
      transition: color 0.2s ease;
    }
    .back-btn:hover {
      color: var(--blue-dark);
    }
    /* --- END NEW --- */


    /* Ø§Ù„Ø¹Ù†ÙˆØ§Ù† */
    .title {
      color: var(--blue-dark);
      font-size:24px;
      font-weight:900;
      text-align:center;
      /* ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù‡ÙˆØ§Ù…Ø´ Ù…Ù† Ù‡Ù†Ø§ ÙˆÙ†Ù‚Ù„Ù‡Ø§ Ø¥Ù„Ù‰ header-wrap */
      letter-spacing: 0.5px;
      text-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }

    /* Ø´Ø±ÙŠØ· Ø§Ù„Ø­Ø§Ù„Ø© */
    .status-wrap{
      width:100%;
      max-width:520px;
      overflow:hidden;
      border-radius:10px;
      margin-bottom:12px;
      background:linear-gradient(90deg, rgba(255,255,255,0.15), rgba(255,255,255,0.05));
      border:1px solid rgba(13,71,161,0.06);
    }
    .status {
      display:block;
      white-space:nowrap;
      padding:8px 12px;
      font-weight:700;
      color:var(--black-bold);
      background: linear-gradient(90deg, rgba(235,246,255,0.6), rgba(255,255,255,0));
      transform:translateX(100%);
      animation: slideRTL 8s linear infinite;
      font-size:14px;
    }
    @keyframes slideRTL {
      0% { transform: translateX(100%); }
      100% { transform: translateX(-100%); }
    }

    /* Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ */
    .card {
      width:100%;
      max-width:520px;
      background:#fff;
      border-radius:14px;
      padding:14px;
      box-shadow:0 8px 30px rgba(13,71,161,0.06);
      margin-bottom:12px;
      box-sizing:border-box;
    }

    label{
      display:block;
      text-align:right;
      margin:8px 0 6px;
      font-weight:800;
      color:var(--black-bold);
      font-size:15px;
    }

    /* Ø§Ù„Ø­Ù‚ÙˆÙ„ */
    .input {
      width:100%;
      padding:12px 14px;
      border-radius:12px;
      border:1px solid #d6eaf8;
      background: var(--card-blue);
      text-align:center;
      font-size:16px;
      font-weight:700;
      color:var(--black-bold);
      outline:none;
      box-sizing:border-box;
    }
    .input:focus{
      box-shadow:0 6px 18px rgba(33,150,243,0.12);
      border-color:var(--accent);
      background:#eef8ff;
    }

    textarea.input {
      min-height:60px;
      resize:vertical;
      padding-top:10px;
    }

    .row {
      display:flex;
      gap:10px;
      align-items:center;
    }
    
    .filter-bar {
        display: flex;
        gap: 8px;
        margin-bottom: 12px;
        width: 100%;
        max-width: 520px;
    }
    .filter-bar .input {
        padding: 8px 10px;
        font-size: 14px;
        font-weight: 600;
        height: 40px;
    }
    .filter-bar select.input {
        flex-shrink: 0;
        width: 140px;
        text-align: right;
        padding-right: 14px;
    }
    .filter-bar .input[type="text"] {
        flex-grow: 1;
    }

    /* Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ */
    .btn-primary {
      margin-top:12px;
      width:100%;
      padding:12px;
      border-radius:12px;
      border:none;
      background: linear-gradient(90deg,#1565c0,#42a5f5);
      color:white;
      font-weight:800;
      font-size:16px;
      cursor:pointer;
      transition:opacity 0.3s ease;
    }
    .btn-primary:active{transform:scale(.995)}
    .btn-primary:disabled{opacity:.6;cursor:not-allowed}
    
    /* Ø²Ø± Ø«Ø§Ù†ÙˆÙŠ */
    .btn-secondary {
        display: block;
        width: 100%;
        text-align: center;
        padding: 8px;
        border-radius: 12px;
        border: 1px solid var(--accent);
        background: #fff;
        color: var(--accent);
        font-weight: 800;
        font-size: 15px;
        cursor: pointer;
        transition: background 0.3s ease;
        text-decoration: none;
        box-sizing: border-box;
    }
    .btn-secondary:hover {
        background: var(--blue-soft);
    }

    /* Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª */
    .suggestions {
      margin-top:8px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      justify-content:flex-start;
    }
    .suggestion-card{
      background: linear-gradient(180deg,#e8f6ff, #d7efff);
      border-radius:12px;
      padding:10px 12px;
      min-width:96px;
      text-align:center;
      font-weight:800;
      color:var(--blue-dark);
      cursor:pointer;
      box-sizing:border-box;
      border:1px solid rgba(13,71,161,0.06);
      transition:transform .12s ease, box-shadow .12s ease;
    }
    .suggestion-card:hover{ transform:translateY(-4px); box-shadow:0 8px 20px rgba(13,71,161,0.08) }

    /* Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
    .table-wrap{
      width:100%;
      max-width:520px;
      background:#fff;
      border-radius:12px;
      overflow:auto;
      box-shadow:0 8px 20px rgba(13,71,161,0.04);
      margin-top:10px;
    }
      table {
      width:100%;
      border-collapse:collapse;
    }
    th, td{
      padding:8px; 
      text-align:center;
      border-bottom:2px solid #ccddee; 
      font-weight:700;
      color:var(--black-bold);
      font-size:10px; 
    }
    th{
      background:var(--accent);
      color:#fff;
      font-size:9px; 
      font-weight:800;
    }
    .time-in{ color:var(--green) }
    .time-out{ color:var(--danger) }

    .exit-btn{
      background:var(--danger);
      color:#fff;
      border:none;
      padding:4px 6px; 
      border-radius:6px;
      font-weight:800;
      font-size:10px; 
      cursor:pointer;
      transition:opacity 0.3s ease;
    }
    .exit-btn:disabled{
      opacity:.6;
      cursor:not-allowed;
    }

    /* footer */
    .footer { 
      margin-top:6px;
      color: #999;
      font-weight: 600;
      font-size: 12px;
      text-align: center;
      padding-bottom: 10px;
    }

    /* Loader text */
    .loading-text {
      display:inline-block;
      font-weight:800;
      color:var(--blue-dark);
      margin-left:8px;
    }
    .pulse {
      display:inline-block;
      width:8px;height:8px;border-radius:50%;
      background:var(--blue-dark); margin-left:6px;
      animation:pulse 1s infinite;
    }
    @keyframes pulse { 0%{opacity:1}50%{opacity:.3}100%{opacity:1} }

    /* Notification */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 16px;
      border-radius: 8px;
      font-weight: 700;
      font-size: 14px;
      animation: slideIn 0.3s ease;
      z-index: 1000;
    }
    .notification.success {
      background: #4caf50;
      color: white;
    }
    .notification.error {
      background: #f44336;
      color: white;
    }
    .notification.warning {
        background: #ff9800;
        color: var(--black-bold);
    }
    .notification.info {
        background: #2196F3;
        color: white;
    }

    @keyframes slideIn {
      from { transform: translateX(400px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    .notification.fade-out {
        animation: fadeOut 0.5s ease-out forwards;
    }

    @keyframes fadeOut {
        from { opacity: 1; transform: translateX(0); }
        to { opacity: 0; transform: translateX(400px); }
    }
    
    /* ÙØ§ØµÙ„ Ø§Ù„Ø£ÙŠØ§Ù… ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
    .day-separator td {
      background: var(--blue-soft);
      color: var(--blue-dark);
      font-weight: 800;
      text-align: center;
      padding: 6px; 
      border-bottom: 3px solid var(--accent);
      border-top: 3px solid var(--accent);
      font-size: 11px; 
    }

    /* responsive adjustments */
    @media (max-width:420px){
      .title{ font-size:18px }
      /* --- NEW --- */
      .back-btn { font-size: 24px; }
      /* --- END NEW --- */
      .card{ padding:12px }
      .input{ font-size:15px; padding:10px }
      .btn-primary{ padding:10px; font-size:15px }
      th,td{ padding:4px; font-size:9px } 
      .suggestion-card{ min-width:86px; padding:8px 10px; font-size:13px }
    }
  </style>
</head>
<body>

  <div style="width:100%;max-width:520px;">
    
    <!-- --- MODIFIED --- -->
    <div class="header-wrap">
      <a href="#" id="backButton" class="back-btn" title="Ø±Ø¬ÙˆØ¹">
        <i class="bi bi-arrow-right-circle-fill"></i>
      </a>
      <div class="title">ğŸš— Ù†Ø¸Ø§Ù… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª â€” Ø¬Ø§Ù…Ø¹Ø© Ø­Ù„ÙˆØ§Ù† Ø§Ù„Ø£Ù‡Ù„ÙŠØ©</div>
    </div>
    <!-- --- END MODIFIED --- -->

    <div class="footer">ØªÙ… Ø§Ù„ØªØµÙ…ÙŠÙ… Ø¨ÙˆØ§Ø³Ø·Ø© / Ù…Ø­Ù…Ø¯ Ø±Ø¬Ø¨</div>

    <div class="status-wrap" aria-hidden="true">
      <span id="status" class="status">âœ… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ù…Ø­Ù„ÙŠØ§Ù‹ (Ø¨Ø¯ÙˆÙ† Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª)</span>
    </div>
    
    <!-- Ø²Ø± Ø±ÙØ¹ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ÙŠÙˆÙ… Ø§ÙˆÙ† Ù„Ø§ÙŠÙ† -->
    <div class="card" id="uploadCard">
        <button id="uploadBtn" class="btn-secondary">â¬†ï¸ Ø±ÙØ¹ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ÙŠÙˆÙ… Ø§ÙˆÙ† Ù„Ø§ÙŠÙ†</button>
        <div id="syncStatus" style="margin-top:8px; font-size:12px; color:#666; text-align:center; display:none;"></div>
    </div>
    
    <div class="card">
      <label for="plate">Ø±Ù‚Ù… Ø§Ù„Ø³ÙŠØ§Ø±Ø©</label>
      <input id="plate" class="input" placeholder="Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ø³ÙŠØ§Ø±Ø© (Ø§ÙƒØªØ¨ Ø£ÙˆÙ„ Ø±Ù‚Ù…ÙŠÙ† Ù„ØªØ¸Ù‡Ø± Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª)" autocomplete="off" />

      <div id="suggestions" class="suggestions" aria-live="polite"></div>

      <label for="name">Ø§Ù„Ø§Ø³Ù…</label>
      <input id="name" class="input" placeholder="Ø§Ù„Ø§Ø³Ù…" />

      <label for="entryGate">Ø¬Ù‡Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„</label>
      <input id="entryGate" class="input" placeholder="Ø¬Ù‡Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„" />

      <label for="notes">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
      <textarea id="notes" class="input" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></textarea>

      <button id="loginBtn" class="btn-primary">â• ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</button>

      <div id="loadingRow" style="margin-top:10px;display:none;">
        <span class="loading-text">Ø¬Ø§Ø±Ù Ø¬Ù„Ø¨ Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª</span><span class="pulse" aria-hidden="true"></span>
      </div>
    </div>
    
    <!-- Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØµÙÙŠØ© ÙˆØ§Ù„Ø¨Ø­Ø« -->
    <div class="filter-bar">
        <select id="filterDate" class="input" title="ÙÙ„ØªØ± Ø­Ø³Ø¨ Ø§Ù„ÙŠÙˆÙ…">
            <option value="">ÙƒÙ„ Ø§Ù„Ø£ÙŠØ§Ù…</option>
        </select>
        
        <input type="text" id="searchQuery" class="input" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ø³ÙŠØ§Ø±Ø©" title="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ø³ÙŠØ§Ø±Ø©">
    </div>

    <div class="table-wrap" style="margin-top:12px;">
      <table id="recordsTable" aria-live="polite">
        <thead>
          <tr>
            <th>Ø§Ù„Ø§Ø³Ù…</th>
            <th>Ø±Ù‚Ù…</th>
            <th>Ø¬Ù‡Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„</th>
            <th>ÙˆÙ‚Øª Ø§Ù„Ø¯Ø®ÙˆÙ„</th>
            <th>ÙˆÙ‚Øª Ø§Ù„Ø®Ø±ÙˆØ¬</th>
            <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
            <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
          </tr>
        </thead>
        <tbody id="recordsBody"></tbody>
      </table>
    </div>

  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getDatabase, ref, get, child, set, onValue, update
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    // ====== Ø¥Ø¹Ø¯Ø§Ø¯ Firebase ======
    const firebaseConfig = {
      apiKey: "AIzaSyDBSiTb1m0osdrX7YOv4ADr8x-7TghSqmY",
      authDomain: "day3069-e27df.firebaseapp.com",
      databaseURL: "https://day3069-e27df-default-rtdb.firebaseio.com",
      projectId: "day3069-e27df",
      storageBucket: "day3069-e27df.firebasestorage.app",
      messagingSenderId: "110258698429",
      appId: "1:110258698429:web:fcc4114a83829756329fd4",
      measurementId: "G-Q3LN0HTXXZ"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const dbRef = ref(db);

    // ====== Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ÙÙŠ DOM ======
    const plateInput = document.getElementById('plate');
    const nameInput = document.getElementById('name');
    const entryGateInput = document.getElementById('entryGate');
    const notesInput = document.getElementById('notes');
    const loginBtn = document.getElementById('loginBtn');
    const suggestionsWrap = document.getElementById('suggestions');
    const recordsBody = document.getElementById('recordsBody');
    const statusSpan = document.getElementById('status');
    const filterDateInput = document.getElementById('filterDate');
    const searchQueryInput = document.getElementById('searchQuery');
    const uploadBtn = document.getElementById('uploadBtn');
    const syncStatus = document.getElementById('syncStatus');
    const backButton = document.getElementById('backButton'); // --- NEW ---

    // ====== Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª ======
    let carsCache = [];
    let recordsCache = [];
    let filteredRecords = [];
    let isOnline = navigator.onLine;
    let realtimeListenerActive = false;

    // ====== ÙˆØ¸Ø§Ø¦Ù Ù…Ø³Ø§Ø¹Ø¯Ø© ======

    function showNotification(message, type = 'success') {
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;
      document.body.appendChild(notification);

      setTimeout(() => {
        notification.classList.add('fade-out');
        notification.addEventListener('animationend', () => notification.remove());
      }, 3000);
    }

    function formatTime(timestamp) {
      const date = new Date(timestamp);
      const hours = date.getHours();
      const minutes = date.getMinutes();
      const ampm = hours >= 12 ? 'Ù…' : 'Øµ';
      const formattedHours = hours % 12 || 12;
      const formattedMinutes = minutes < 10 ? '0' + minutes : minutes;
      return `${formattedHours}:${formattedMinutes} ${ampm}`;
    }

    function formatDate(timestamp) {
        const date = new Date(timestamp);
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    // ====== ÙˆØ¸Ø§Ø¦Ù Local Storage ======

    function loadRecordsFromLocalStorage() {
      const records = localStorage.getItem('carRecords');
      recordsCache = records ? JSON.parse(records) : [];
      recordsCache.sort((a, b) => a.timestamp - b.timestamp);
      populateDateFilter();
      applyFilters();
    }

    function saveRecordsToLocalStorage() {
      localStorage.setItem('carRecords', JSON.stringify(recordsCache));
    }

    function loadCarsFromLocalStorage() {
      const cars = localStorage.getItem('carsCached');
      if (cars) {
        carsCache = JSON.parse(cars);
        return true;
      }
      return false;
    }

    function saveCarsToLocalStorage() {
      localStorage.setItem('carsCached', JSON.stringify(carsCache));
    }

    // ====== ÙˆØ¸ÙŠÙØ© Ù…Ù„Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØµÙÙŠØ© Ø¨Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® ======
    function populateDateFilter() {
        const uniqueDates = [...new Set(recordsCache.map(rec => formatDate(rec.timestamp)))];
        uniqueDates.sort((a, b) => new Date(b) - new Date(a));
        filterDateInput.innerHTML = '<option value="">ÙƒÙ„ Ø§Ù„Ø£ÙŠØ§Ù…</option>';
        uniqueDates.forEach(date => {
            const option = document.createElement('option');
            option.value = date;
            const formattedDate = new Date(date).toLocaleDateString('ar-EG', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            option.textContent = formattedDate;
            filterDateInput.appendChild(option);
        });
    }

    // ====== Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª Ù…Ù† Firebase ======
    async function fetchCarsData() {
      try {
        statusSpan.textContent = 'â³ Ø¬Ø§Ø±Ù Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª Ù…Ù† Firebase...';
        const snapshot = await get(child(dbRef, 'cars'));
        if (snapshot.exists()) {
          carsCache = Object.values(snapshot.val());
          saveCarsToLocalStorage();
          statusSpan.textContent = 'âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª Ø¨Ù†Ø¬Ø§Ø­.';
          isOnline = true;
          updateStatusDisplay();
          return true;
        } else {
          statusSpan.textContent = 'âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø³ÙŠØ§Ø±Ø§Øª.';
          return false;
        }
      } catch (error) {
        console.error("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª:", error);
        
        if (loadCarsFromLocalStorage()) {
          statusSpan.textContent = 'âš ï¸ ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ù…Ø­Ù„ÙŠØ§Ù‹ (Ø¨Ø¯ÙˆÙ† Ø¥Ù†ØªØ±Ù†Øª).';
          isOnline = false;
          updateStatusDisplay();
          return true;
        } else {
          statusSpan.textContent = 'âŒ ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ØªØ£ÙƒØ¯ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.';
          isOnline = false;
          updateStatusDisplay();
          return false;
        }
      }
    }

    // ====== ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø§Ù„Ø© ======
    function updateStatusDisplay() {
      if (isOnline) {
        statusSpan.textContent = 'âœ… Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª - Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ø¯Ø«Ø©';
      } else {
        statusSpan.textContent = 'ğŸ“´ Ø¨Ø¯ÙˆÙ† Ø¥Ù†ØªØ±Ù†Øª - ØªØ¹Ù…Ù„ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ù…Ø­Ù„ÙŠØ§Ù‹';
      }
    }

    // ====== Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø­ÙŠØ© (Real-time Sync) Ù…Ù† Firebase ======
    function setupRealtimeSync() {
      if (realtimeListenerActive) return;
      
      try {
        const today = formatDate(Date.now());
        const datePath = today.replace(/-/g, '');
        const recordsRef = ref(db, `records/${datePath}`);
        
        onValue(recordsRef, (snapshot) => {
          if (snapshot.exists()) {
            const firebaseRecords = snapshot.val();
            
            const newRecords = Object.values(firebaseRecords).map(rec => ({
              id: rec.id,
              name: rec.ownerName,
              plate: rec.carNumber,
              entryGate: rec.entrance,
              notes: rec.notes || '',
              inTime: rec.inTime,
              outTime: rec.outTime || '',
              timestamp: rec.timestamp,
              outTimestamp: rec.outTimestamp || null
            }));
            
            const localIds = new Set(recordsCache.map(r => r.id));
            const firebaseIds = new Set(newRecords.map(r => r.id));
            
            recordsCache = recordsCache.filter(r => firebaseIds.has(r.id) || !localIds.has(r.id));
            
            newRecords.forEach(fbRecord => {
              const existingIndex = recordsCache.findIndex(r => r.id === fbRecord.id);
              if (existingIndex >= 0) {
                recordsCache[existingIndex] = fbRecord;
              } else {
                recordsCache.push(fbRecord);
              }
            });
            
            recordsCache.sort((a, b) => a.timestamp - b.timestamp);
            saveRecordsToLocalStorage();
            
            populateDateFilter();
            applyFilters();
          }
        }, (error) => {
          console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø­ÙŠØ©:", error);
        });
        
        realtimeListenerActive = true;
      } catch (error) {
        console.error("Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø­ÙŠØ©:", error);
      }
    }

    // ====== Ø±ÙØ¹ Ø³Ø¬Ù„Ø§Øª Ø§Ù„ÙŠÙˆÙ… Ø¥Ù„Ù‰ Firebase ======
    async function uploadTodayRecords() {
        const today = formatDate(Date.now());
        const recordsToUpload = recordsCache.filter(rec => formatDate(rec.timestamp) === today);
        
        if (recordsToUpload.length === 0) {
            showNotification('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù„Ù„ÙŠÙˆÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ø±ÙØ¹Ù‡Ø§.', 'warning');
            return;
        }
        
        const recordsObject = recordsToUpload.reduce((obj, rec) => {
            obj[rec.id] = {
                id: rec.id,
                ownerName: rec.name,
                carNumber: rec.plate,
                entrance: rec.entryGate,
                notes: rec.notes,
                inTime: rec.inTime,
                outTime: rec.outTime,
                timestamp: rec.timestamp,
                outTimestamp: rec.outTimestamp
            };
            return obj;
        }, {});
        
        uploadBtn.disabled = true;
        const originalText = uploadBtn.textContent;
        uploadBtn.textContent = `â³ Ø¬Ø§Ø±Ù Ø±ÙØ¹ ${recordsToUpload.length} Ø³Ø¬Ù„...`;
        
        try {
            const datePath = today.replace(/-/g, '');
            const recordsRef = ref(db, `records/${datePath}`);
            await set(recordsRef, recordsObject);
            
            showNotification(`âœ… ØªÙ… Ø±ÙØ¹ ${recordsToUpload.length} Ø³Ø¬Ù„ Ù„Ù„ÙŠÙˆÙ… ${today} Ø¨Ù†Ø¬Ø§Ø­!`, 'success');
            isOnline = true;
            updateStatusDisplay();
            
            setupRealtimeSync();
        } catch (error) {
            console.error("Ø®Ø·Ø£ ÙÙŠ Ø±ÙØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª:", error);
            showNotification('âŒ ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª. ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.', 'error');
            isOnline = false;
            updateStatusDisplay();
        } finally {
            uploadBtn.disabled = false;
            uploadBtn.textContent = originalText;
        }
    }

    // ====== ÙˆØ¸ÙŠÙØ© ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØµÙÙŠØ© ÙˆØ§Ù„Ø¨Ø­Ø« ======
    function applyFilters() {
        const selectedDate = filterDateInput.value;
        const searchQuery = searchQueryInput.value.trim().toLowerCase();
        
        filteredRecords = recordsCache.filter(rec => {
            let passesDateFilter = true;
            let passesSearchFilter = true;
            
            if (selectedDate) {
                const recordDate = formatDate(rec.timestamp);
                passesDateFilter = recordDate === selectedDate;
            }
            
            if (searchQuery) {
                const name = (rec.name || '').toLowerCase();
                const plate = (rec.plate || '').toLowerCase();
                passesSearchFilter = name.includes(searchQuery) || plate.includes(searchQuery);
            }
            
            return passesDateFilter && passesSearchFilter;
        });
        
        renderRecords();
    }

    // ====== Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„Ø§Øª ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ======
    function renderRecords() {
      recordsBody.innerHTML = '';
      let lastDate = '';

      filteredRecords.forEach(rec => {
        const currentDate = formatDate(rec.timestamp);

        if (currentDate !== lastDate) {
            const row = recordsBody.insertRow();
            row.className = 'day-separator';
            const cell = row.insertCell();
            cell.colSpan = 7;
            cell.textContent = new Date(rec.timestamp).toLocaleDateString('ar-EG', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            lastDate = currentDate;
        }

        const row = recordsBody.insertRow();
        
        row.insertCell().textContent = rec.name;
        row.insertCell().textContent = rec.plate;
        row.insertCell().textContent = rec.entryGate;

        const inTimeCell = row.insertCell();
        inTimeCell.className = 'time-in';
        inTimeCell.textContent = rec.inTime;

        const outTimeCell = row.insertCell();
        outTimeCell.className = rec.outTime ? 'time-out' : '';
        outTimeCell.textContent = rec.outTime || 'â€”';

        row.insertCell().textContent = rec.notes || 'â€”';

        const actionCell = row.insertCell();
        if (!rec.outTime) {
          const exitBtn = document.createElement('button');
          exitBtn.className = 'exit-btn';
          exitBtn.textContent = 'Ø®Ø±ÙˆØ¬';
          exitBtn.setAttribute('data-id', rec.id);
          actionCell.appendChild(exitBtn);
        } else {
          actionCell.textContent = 'ØªÙ… Ø§Ù„Ø®Ø±ÙˆØ¬';
        }
      });
    }

    // ====== ÙˆØ¸ÙŠÙØ© Ø¹Ø±Ø¶ Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª ======
    function renderSuggestions(q) {
      suggestionsWrap.innerHTML = '';
      if (q.length < 2) return;

      const matches = carsCache.filter(c=> c.carNumber && c.carNumber.includes(q) );
      matches.slice(0,10).forEach(c=>{
        const card = document.createElement('div');
        card.className = 'suggestion-card';
        card.innerHTML = `<div style="font-size:13px;color:var(--blue-dark);">${c.carNumber}</div><div style="font-size:12px;color:#0b0b0b;margin-top:4px">${c.ownerName || ''}</div><div style="font-size:11px;color:#666;margin-top:2px">${c.entrance || ''}</div>`;
        card.addEventListener('click', ()=>{
          plateInput.value = c.carNumber || '';
          nameInput.value = c.ownerName || '';
          entryGateInput.value = c.entrance || '';
          suggestionsWrap.innerHTML = '';
        });
        suggestionsWrap.appendChild(card);
      });

      if(matches.length === 0){
        const no = document.createElement('div');
        no.style.color = '#666';
        no.style.fontWeight = '700';
        no.style.marginTop = '6px';
        no.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©';
        suggestionsWrap.appendChild(no);
      }
    }

    // ====== Ù…Ø³ØªÙ…Ø¹ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« ======
    
    // --- NEW ---
    backButton.addEventListener('click', (e) => {
        e.preventDefault(); // Ù…Ù†Ø¹ Ø§Ù„Ø³Ù„ÙˆÙƒ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ù„Ø±Ø§Ø¨Ø·
        history.back(); // Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
    });
    // --- END NEW ---
    
        plateInput.addEventListener('input', (e)=>{
      renderSuggestions(e.target.value.trim());
    });

    plateInput.addEventListener('change', ()=>{
      const val = plateInput.value.trim();
      if(!val) return;
      const found = carsCache.find(c => c.carNumber === val);
      if(found){
        nameInput.value = found.ownerName || '';
        entryGateInput.value = found.entrance || '';
      }
    });

    filterDateInput.addEventListener('change', applyFilters);
    searchQueryInput.addEventListener('input', applyFilters);
    uploadBtn.addEventListener('click', uploadTodayRecords);

    // ====== ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ ======
    loginBtn.addEventListener('click', async ()=>{
      const plate = plateInput.value.trim();
      const name = nameInput.value.trim();
      const entryGate = entryGateInput.value.trim();
      const notes = notesInput.value.trim();

      if(!plate || !name){
        showNotification('Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ø«Ù… Ø§Ø®ØªØ± Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­ Ø£Ùˆ Ø§Ù…Ù„Ø£ Ø§Ù„Ø§Ø³Ù….', 'error');
        return;
      }

      const isAlreadyIn = recordsCache.some(rec => 
        rec.plate === plate && !rec.outTime
      );

      if (isAlreadyIn) {
        const existingRecord = recordsCache.find(rec => rec.plate === plate && !rec.outTime);
        const entryTime = existingRecord ? existingRecord.inTime : 'ÙˆÙ‚Øª ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
        const entryCollege = existingRecord ? existingRecord.entryGate : 'Ø¬Ù‡Ø© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©';
        
        showNotification(`âš ï¸ Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ø±Ù‚Ù… ${plate} Ù…Ø³Ø¬Ù„Ø© Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„ÙØ¹Ù„! (Ø¬Ù‡Ø©: ${entryCollege}ØŒ ÙˆÙ‚Øª: ${entryTime})`, 'warning');
        return;
      }

      try {
        loginBtn.disabled = true;
        loginBtn.textContent = 'â³ Ø¬Ø§Ø±Ù Ø§Ù„Ø­ÙØ¸...';

        const ts = Date.now();
        const inTime = formatTime(ts);
        const id = 'rec_' + ts;

        recordsCache.push({ id, name, plate, entryGate, notes, inTime, outTime:'', timestamp:ts });
        saveRecordsToLocalStorage();
        
        populateDateFilter();
        applyFilters();

        plateInput.value = '';
        nameInput.value = '';
        entryGateInput.value = '';
        notesInput.value = '';
        suggestionsWrap.innerHTML = '';

        showNotification('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­! (Ù…Ø­ÙÙˆØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹)', 'success');
      } catch(err){
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸', err);
        showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„', 'error');
      } finally {
        loginBtn.disabled = false;
        loginBtn.textContent = 'â• ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„';
      }
    });

    // ====== ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ ======
    recordsBody.addEventListener('click', async (e)=>{
      if(e.target && e.target.classList.contains('exit-btn')){
        const id = e.target.getAttribute('data-id');
        const ts = Date.now();
        const outTime = formatTime(ts);

        try{
          e.target.disabled = true;
          e.target.textContent = 'â³...';

          const rec = recordsCache.find(r=> r.id === id);
          if(rec){ 
            rec.outTime = outTime; 
            rec.outTimestamp = ts; 
          }
          saveRecordsToLocalStorage();

          applyFilters();

          showNotification('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­! (Ù…Ø­ÙÙˆØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹)', 'success');
          
          if(isOnline && rec) {
              const recordDate = formatDate(rec.timestamp);
              const datePath = recordDate.replace(/-/g, '');
              const recordRef = ref(db, `records/${datePath}/${rec.id}`);
              
              const updateData = {
                  outTime: rec.outTime,
                  outTimestamp: rec.outTimestamp
              };
              
              try {
                  await update(recordRef, updateData);
                  showNotification('ğŸ”„ ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±.', 'info');
              } catch (updateError) {
                  console.error("ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¹Ù„Ù‰ Firebase:", updateError);
                  showNotification('âš ï¸ ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±ØŒ Ø³ÙŠØªÙ… Ø§Ù„Ø±ÙØ¹ Ù„Ø§Ø­Ù‚Ø§Ù‹.', 'warning');
              }
          }
          
        } catch(err){
          console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø®Ø±ÙˆØ¬', err);
          showNotification('ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬', 'error');
          e.target.disabled = false;
          e.target.textContent = 'Ø®Ø±ÙˆØ¬';
        }
      }
    });

    // ====== Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª ======
    window.addEventListener('online', async () => {
      isOnline = true;
      updateStatusDisplay();
      showNotification('âœ… ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª', 'success');
      await fetchCarsData();
      setupRealtimeSync();
    });

    window.addEventListener('offline', () => {
      isOnline = false;
      updateStatusDisplay();
      showNotification('ğŸ“´ ÙÙ‚Ø¯Øª Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª - ØªØ¹Ù…Ù„ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ù…Ø­Ù„ÙŠØ§Ù‹', 'warning');
    });

    // ====== Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ÙŠ ======
    async function loadInitialData() {
      const fetchSuccess = await fetchCarsData();
      
      if (!fetchSuccess) {
        loadCarsFromLocalStorage();
      }
      
      loadRecordsFromLocalStorage();
      
      if (isOnline) {
        setupRealtimeSync();
      }
    }

    // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
    loadInitialData();
  </script>
</body>
</html>

