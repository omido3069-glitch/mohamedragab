<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>نظام تسجيل السيارات — جامعة حلوان الأهلية</title>

  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@600;800&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

  <style>
    :root{
      --blue-dark: #0d47a1;
      --blue-soft: #e7f3ff;
      --card-blue: #d8eefe;
      --accent: #1976d2;
      --black-bold: #0b0b0b;
      --danger: #d32f2f;
      --green: #2e7d32;
    }

    html,body{height:100%;margin:0}
    body{
      font-family:'Cairo',sans-serif;
      background: linear-gradient(180deg,#f8fbff 0%, #e9f7ff 100%);
      color: var(--black-bold);
      -webkit-font-smoothing:antialiased;
      -moz-osx-osx-smoothing:grayscale;
      display:flex;
      flex-direction:column;
      align-items:center;
      padding:14px;
    }

    /* العنوان */
    .title {
      color: var(--blue-dark);
      font-size:24px; /* زيادة الحجم */
      font-weight:900; /* زيادة سمك الخط */
      text-align:center;
      margin-top:10px; /* زيادة الهامش العلوي */
      margin-bottom:4px; /* تقليل الهامش السفلي لتقريب التذييل */
      letter-spacing: 0.5px; /* إضافة تباعد بسيط للحروف */
      text-shadow: 0 1px 2px rgba(0,0,0,0.05); /* إضافة ظل خفيف */
    }

    /* شريط الحالة (أزرق ثابت لكن النص يتغير) — متحرك من اليمين لليسار */
    .status-wrap{
      width:100%;
      max-width:520px;
      overflow:hidden;
      border-radius:10px;
      margin-bottom:12px;
      background:linear-gradient(90deg, rgba(255,255,255,0.15), rgba(255,255,255,0.05));
      border:1px solid rgba(13,71,161,0.06);
    }
    .status {
      display:block;
      white-space:nowrap;
      padding:8px 12px;
      font-weight:700;
      color:var(--black-bold);
      background: linear-gradient(90deg, rgba(235,246,255,0.6), rgba(255,255,255,0));
      transform:translateX(100%);
      animation: slideRTL 8s linear infinite;
      font-size:14px;
    }
    @keyframes slideRTL {
      0% { transform: translateX(100%); }
      100% { transform: translateX(-100%); }
    }

    /* بطاقة النموذج */
    .card {
      width:100%;
      max-width:520px;
      background:#fff;
      border-radius:14px;
      padding:14px;
      box-shadow:0 8px 30px rgba(13,71,161,0.06);
      margin-bottom:12px;
      box-sizing:border-box;
    }

    label{
      display:block;
      text-align:right;
      margin:8px 0 6px;
      font-weight:800;
      color:var(--black-bold);
      font-size:15px;
    }

    /* الحقول - مربعات ملونة */
    .input {
      width:100%;
      padding:12px 14px;
      border-radius:12px;
      border:1px solid #d6eaf8;
      background: var(--card-blue);
      text-align:center;
      font-size:16px;
      font-weight:700;
      color:var(--black-bold);
      outline:none;
      box-sizing:border-box;
    }
    .input:focus{
      box-shadow:0 6px 18px rgba(33,150,243,0.12);
      border-color:var(--accent);
      background:#eef8ff;
    }

    textarea.input {
      min-height:60px;
      resize:vertical;
      padding-top:10px;
    }

    .row {
      display:flex;
      gap:10px;
      align-items:center;
    }
    
    /* إضافة تنسيق جديد لأدوات البحث والتصفية */
    .filter-bar {
        display: flex;
        gap: 8px;
        margin-bottom: 12px;
        width: 100%;
        max-width: 520px;
    }
    .filter-bar .input {
        padding: 8px 10px;
        font-size: 14px;
        font-weight: 600;
        height: 40px; /* لتوحيد الارتفاع */
    }
    .filter-bar select.input {
        flex-shrink: 0; /* لمنع تقلص قائمة التصفية */
        width: 140px;
        text-align: right; /* محاذاة النص لليمين */
        padding-right: 14px; /* مسافة داخلية لليمين */
    }
    .filter-bar .input[type="text"] {
        flex-grow: 1; /* للسماح لحقل البحث بأخذ المساحة المتبقية */
    }


    /* زر تسجيل دخول */
    .btn-primary {
      margin-top:12px;
      width:100%;
      padding:12px;
      border-radius:12px;
      border:none;
      background: linear-gradient(90deg,#1565c0,#42a5f5);
      color:white;
      font-weight:800;
      font-size:16px;
      cursor:pointer;
      transition:opacity 0.3s ease;
    }
    .btn-primary:active{transform:scale(.995)}
    .btn-primary:disabled{opacity:.6;cursor:not-allowed}
    
    /* زر ثانوي */
    .btn-secondary {
        display: block;
        width: 100%;
        text-align: center;
        padding: 8px;
        border-radius: 12px;
        border: 1px solid var(--accent);
        background: #fff;
        color: var(--accent);
        font-weight: 800;
        font-size: 15px;
        cursor: pointer;
        transition: background 0.3s ease;
        text-decoration: none;
        box-sizing: border-box;
    }
    .btn-secondary:hover {
        background: var(--blue-soft);
    }


    /* الاقتراحات — بطاقات مستقلة */
    .suggestions {
      margin-top:8px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      justify-content:flex-start;
    }
    .suggestion-card{
      background: linear-gradient(180deg,#e8f6ff, #d7efff);
      border-radius:12px;
      padding:10px 12px;
      min-width:96px;
      text-align:center;
      font-weight:800;
      color:var(--blue-dark);
      cursor:pointer;
      box-sizing:border-box;
      border:1px solid rgba(13,71,161,0.06);
      transition:transform .12s ease, box-shadow .12s ease;
    }
    .suggestion-card:hover{ transform:translateY(-4px); box-shadow:0 8px 20px rgba(13,71,161,0.08) }

    /* الجدول (قابل للتمرير على الموبايل) */
    .table-wrap{
      width:100%;
      max-width:520px;
      background:#fff;
      border-radius:12px;
      overflow:auto;
      box-shadow:0 8px 20px rgba(13,71,161,0.04);
      margin-top:10px;
    }
      table {
      width:100%;
      border-collapse:collapse;
      /* تم إزالة min-width: 700px للسماح للجدول بالتكيف مع العرض الكامل للشاشة */
    }
    th, td{
      padding:8px; 
      text-align:center;
      /* تم زيادة سمك وغمق لون الخط الفاصل بين السجلات */
      border-bottom:2px solid #ccddee; 
      font-weight:700;
      color:var(--black-bold);
      font-size:10px; 
    }
    th{
      background:var(--accent);
      color:#fff;
      font-size:9px; 
      font-weight:800;
    }
    .time-in{ color:var(--green) }
    .time-out{ color:var(--danger) }

    .exit-btn{
      background:var(--danger);
      color:#fff;
      border:none;
      padding:4px 6px; 
      border-radius:6px;
      font-weight:800;
      font-size:10px; 
      cursor:pointer;
      transition:opacity 0.3s ease;
    }
    .exit-btn:disabled{
      opacity:.6;
      cursor:not-allowed;
    }

    /* footer */
    .footer { 
      margin-top:6px; /* تقليل الهامش العلوي لتقريب التذييل من العنوان */
      color: #999; /* لون رمادي أفتح وأكثر هدوءًا */
      font-weight: 600; /* خط أقل سمكًا */
      font-size: 12px; /* حجم أصغر */
      text-align: center;
      padding-bottom: 10px; /* إضافة مساحة سفلية */
    }

    /* Loader text */
    .loading-text {
      display:inline-block;
      font-weight:800;
      color:var(--blue-dark);
      margin-left:8px;
    }
    .pulse {
      display:inline-block;
      width:8px;height:8px;border-radius:50%;
      background:var(--blue-dark); margin-left:6px;
      animation:pulse 1s infinite;
    }
    @keyframes pulse { 0%{opacity:1}50%{opacity:.3}100%{opacity:1} }

    /* Notification */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 16px;
      border-radius: 8px;
      font-weight: 700;
      font-size: 14px;
      animation: slideIn 0.3s ease;
      z-index: 1000;
    }
    .notification.success {
      background: #4caf50;
      color: white;
    }
    .notification.error {
      background: #f44336;
      color: white;
    }
    /* إضافة لون تحذيري جديد للميزة الجديدة */
    .notification.warning {
        background: #ff9800; /* برتقالي */
        color: var(--black-bold);
    }

    @keyframes slideIn {
      from { transform: translateX(400px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    .notification.fade-out {
        animation: fadeOut 0.5s ease-out forwards;
    }

    @keyframes fadeOut {
        from { opacity: 1; transform: translateX(0); }
        to { opacity: 0; transform: translateX(400px); }
    }
    
    /* فاصل الأيام في الجدول */
    .day-separator td {
      background: var(--blue-soft);
      color: var(--blue-dark);
      font-weight: 800;
      text-align: center;
      padding: 6px; 
      /* زيادة سمك ووضوح الخطوط العلوية والسفلية للفاصل */
      border-bottom: 3px solid var(--accent);
      border-top: 3px solid var(--accent);
      font-size: 11px; 
    }

    /* responsive adjustments */
    @media (max-width:420px){
      .title{ font-size:18px }
      .card{ padding:12px }
      .input{ font-size:15px; padding:10px }
      .btn-primary{ padding:10px; font-size:15px }
      th,td{ padding:4px; font-size:9px } 
      .suggestion-card{ min-width:86px; padding:8px 10px; font-size:13px }
    }
  </style>
</head>
<body>

  <div style="width:100%;max-width:520px;">
    <div class="title">🚗 نظام تسجيل السيارات — جامعة حلوان الأهلية</div>

    <div class="footer">تم التصميم بواسطة / محمد رجب</div>

    <div class="status-wrap" aria-hidden="true">
      <span id="status" class="status">✅ البيانات محفوظة محلياً (بدون اتصال بالإنترنت)</span>
    </div>
    
    <!-- ********************************************** -->
    <!-- زر رفع سجلات اليوم اون لاين -->
    <!-- ********************************************** -->
    <div class="card" id="uploadCard">
        <button id="uploadBtn" class="btn-secondary">⬆️ رفع سجلات اليوم اون لاين</button>
    </div>
    <!-- ********************************************** -->
    
    <div class="card">
      <label for="carNumber">رقم السيارة</label>
      <input id="carNumber" class="input" placeholder="اكتب رقم السيارة (اكتب أول رقمين لتظهر الاقتراحات)" autocomplete="off" />

      <div id="suggestions" class="suggestions" aria-live="polite"></div>

      <label for="name">الاسم</label>
		      <input id="name" class="input" placeholder="الاسم" />

      <label for="college">جهة الدخول</label>
		      <input id="college" class="input" placeholder="جهة الدخول" />

      <label for="notes">ملاحظات</label>
      <textarea id="notes" class="input" placeholder="ملاحظات (اختياري)"></textarea>

      <button id="loginBtn" class="btn-primary">➕ تسجيل دخول</button>

      <div id="loadingRow" style="margin-top:10px;display:none;">
        <span class="loading-text">جارٍ جلب الاقتراحات</span><span class="pulse" aria-hidden="true"></span>
      </div>
    </div>
    
    <!-- ********************************************** -->
    <!-- إضافة أدوات التصفية والبحث المطلوبة من المستخدم -->
    <!-- ********************************************** -->
    <div class="filter-bar">
        <!-- فلتر حسب اليوم -->
        <select id="filterDate" class="input" title="فلتر حسب اليوم">
            <option value="">كل الأيام</option>
        </select>
        
        <!-- خانة بحث بالاسم أو رقم السيارة -->
        <input type="text" id="searchQuery" class="input" placeholder="بحث بالاسم أو رقم السيارة" title="بحث بالاسم أو رقم السيارة">
    </div>
    <!-- ********************************************** -->

    <div class="table-wrap" style="margin-top:12px;">
      <table id="recordsTable" aria-live="polite">
        <thead>
          <tr>
            <th>الاسم</th>
            <th>رقم</th>
            <th>جهة الدخول</th>
            <th>وقت الدخول</th>
            <th>وقت الخروج</th>
            <th>ملاحظات</th>
            <th>إجراء</th>
          </tr>
        </thead>
        <tbody id="recordsBody"></tbody>
      </table>
    </div>

  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getDatabase, ref, get, child, set // إضافة set لرفع البيانات
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    // ====== إعداد Firebase (قراءة البيانات فقط) ======
    // ملاحظة: يجب استبدال هذه القيم بمتغيرات البيئة في الإنتاج
    const firebaseConfig = {
      apiKey: "AIzaSyCRR-uXoz14YOudO0K740Y5AUbivB0R5M0",
      authDomain: "hnu-3069.firebaseapp.com",
      databaseURL: "https://hnu-3069-default-rtdb.firebaseio.com",
      projectId: "hnu-3069",
      storageBucket: "hnu-3069.firebasestorage.app",
      messagingSenderId: "98084688599",
      appId: "1:98084688599:web:e272972e76d63f8ae01692",
      measurementId: "G-P0E5EC7CHJ"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const dbRef = ref(db);

    // ====== العناصر الأساسية في DOM ======
    const carNumberInput = document.getElementById('carNumber');
    const nameInput = document.getElementById('name');
    const collegeInput = document.getElementById('college');
    const notesInput = document.getElementById('notes');
    const loginBtn = document.getElementById('loginBtn');
    const suggestionsWrap = document.getElementById('suggestions');
    const recordsBody = document.getElementById('recordsBody');
    const statusSpan = document.getElementById('status');
    
    // **********************************************
    // إضافة عناصر DOM الجديدة
    // **********************************************
    const filterDateInput = document.getElementById('filterDate');
    const searchQueryInput = document.getElementById('searchQuery');
    const uploadBtn = document.getElementById('uploadBtn'); // زر الرفع الجديد
    // **********************************************

    // ====== وظيفة ملء قائمة التصفية بالتواريخ الموجودة ======
    function populateDateFilter() {
        // جمع التواريخ الفريدة من السجلات
        const uniqueDates = [...new Set(recordsCache.map(rec => formatDate(rec.timestamp)))];
        
        // فرز التواريخ من الأحدث للأقدم
        uniqueDates.sort((a, b) => new Date(b) - new Date(a));
        
        // مسح القائمة الحالية وإضافة خيار "كل الأيام"
        filterDateInput.innerHTML = '<option value="">كل الأيام</option>';
        
        // إضافة الخيارات الجديدة
        uniqueDates.forEach(date => {
            const option = document.createElement('option');
            option.value = date;
            
            // تحويل التاريخ إلى صيغة عربية (مثال: الأربعاء، 15 مايو 2024)
            const formattedDate = new Date(date).toLocaleDateString('ar-EG', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            option.textContent = formattedDate;
            
            filterDateInput.appendChild(option);
        });
    }

    // ====== متغيرات التخزين المؤقت ======
    let carsCache = []; // لتخزين بيانات السيارات من Firebase
    let recordsCache = []; // لتخزين سجلات الدخول والخروج من Local Storage
    let filteredRecords = []; // لتخزين السجلات بعد التصفية والبحث
    
    // ====== وظائف مساعدة ======

    // عرض إشعار مؤقت
    function showNotification(message, type = 'success') {
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;
      document.body.appendChild(notification);

      setTimeout(() => {
        notification.classList.add('fade-out');
        notification.addEventListener('animationend', () => notification.remove());
      }, 3000);
    }

    // تنسيق الوقت إلى صيغة 12 ساعة (مثال: 10:30 ص)
    function formatTime(timestamp) {
      const date = new Date(timestamp);
      const hours = date.getHours();
      const minutes = date.getMinutes();
      const ampm = hours >= 12 ? 'م' : 'ص';
      const formattedHours = hours % 12 || 12;
      const formattedMinutes = minutes < 10 ? '0' + minutes : minutes;
      return `${formattedHours}:${formattedMinutes} ${ampm}`;
    }

    // تنسيق التاريخ (مثال: 2024-05-15)
    function formatDate(timestamp) {
        const date = new Date(timestamp);
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    // ====== وظائف Local Storage ======

    // تحميل السجلات من Local Storage
    function loadRecordsFromLocalStorage() {
      const records = localStorage.getItem('carRecords');
      recordsCache = records ? JSON.parse(records) : [];
      // الفرز حسب أحدث سجل (timestamp)
      recordsCache.sort((a, b) => b.timestamp - a.timestamp);
      
      // تحديث قائمة التصفية بالتواريخ الموجودة
      populateDateFilter();
      
      // تحديث السجلات المفلترة عند التحميل
      applyFilters(); 
    }

    // حفظ السجلات في Local Storage
    function saveRecordsToLocalStorage() {
      localStorage.setItem('carRecords', JSON.stringify(recordsCache));
    }

    // ====== جلب البيانات من Firebase ======
    async function fetchCarsData() {
      statusSpan.textContent = '⏳ جارٍ جلب بيانات السيارات من Firebase...';
      try {
        const snapshot = await get(child(dbRef, 'cars'));
        if (snapshot.exists()) {
          // تحويل الكائن إلى مصفوفة
          carsCache = Object.values(snapshot.val());
          statusSpan.textContent = '✅ تم تحديث بيانات السيارات بنجاح.';
        } else {
          statusSpan.textContent = '⚠️ لم يتم العثور على بيانات سيارات.';
        }
      } catch (error) {
        console.error("خطأ في جلب بيانات السيارات:", error);
        statusSpan.textContent = '❌ فشل جلب البيانات. قد تكون البيانات قديمة.';
      }
    }
    
    // ====== رفع سجلات اليوم إلى Firebase ======
    async function uploadTodayRecords() {
        // 1. تحديد سجلات اليوم الحالي (اليوم الذي يتم فيه الضغط على الزر)
        const today = formatDate(Date.now());
        const recordsToUpload = recordsCache.filter(rec => formatDate(rec.timestamp) === today);
        
        if (recordsToUpload.length === 0) {
            showNotification('⚠️ لا توجد سجلات لليوم الحالي لرفعها.', 'warning');
            return;
        }
        
        // 2. إعداد البيانات للرفع (تحويلها إلى كائن)
        const recordsObject = recordsToUpload.reduce((obj, rec) => {
            // استخدام المعرف الفريد (id) كسجل في Firebase
            obj[rec.id] = rec;
            return obj;
        }, {});
        
        // 3. الرفع إلى Firebase
        uploadBtn.disabled = true;
        const originalText = uploadBtn.textContent;
        uploadBtn.textContent = `⏳ جارٍ رفع ${recordsToUpload.length} سجل...`;
        
        try {
            // استخدام دالة set لتحديث البيانات تحت مسار اليوم
            // المسار: /records/YYYY-MM-DD
            const datePath = today.replace(/-/g, ''); // إزالة الشرطات لتصبح 20240515
            const recordsRef = ref(db, `records/${datePath}`);
            await set(recordsRef, recordsObject);
            
            showNotification(`✅ تم رفع ${recordsToUpload.length} سجل لليوم ${today} بنجاح!`, 'success');
        } catch (error) {
            console.error("خطأ في رفع السجلات:", error);
            showNotification('❌ فشل رفع السجلات. تحقق من اتصالك بالإنترنت.', 'error');
        } finally {
            uploadBtn.disabled = false;
            uploadBtn.textContent = originalText;
        }
    }

    // **********************************************
    // إضافة مستمع الحدث لزر الرفع
    // **********************************************
    uploadBtn.addEventListener('click', uploadTodayRecords);
    // **********************************************
    
    // **********************************************
    // إضافة وظيفة تطبيق التصفية والبحث
    // **********************************************
    function applyFilters() {
        const selectedDate = filterDateInput.value; // التاريخ المحدد (بصيغة YYYY-MM-DD)
        const searchQuery = searchQueryInput.value.trim().toLowerCase(); // نص البحث
        
        filteredRecords = recordsCache.filter(rec => {
            let passesDateFilter = true;
            let passesSearchFilter = true;
            
            // 1. تصفية حسب اليوم
            if (selectedDate) {
                const recordDate = formatDate(rec.timestamp);
                passesDateFilter = recordDate === selectedDate;
            }
            
            // 2. تصفية حسب الاسم أو رقم السيارة
            if (searchQuery) {
                const name = (rec.name || '').toLowerCase();
                const number = (rec.number || '').toLowerCase();
                passesSearchFilter = name.includes(searchQuery) || number.includes(searchQuery);
            }
            
            return passesDateFilter && passesSearchFilter;
        });
        
        // إعادة عرض السجلات المفلترة
        renderRecords();
    }
    
    // **********************************************
    // إضافة مستمعي الأحداث لأدوات التصفية والبحث
    // **********************************************
    // تم تغيير 'change' إلى 'input' لحقل البحث، وتم الإبقاء على 'change' لقائمة التصفية
    filterDateInput.addEventListener('change', applyFilters);
    searchQueryInput.addEventListener('input', applyFilters);
    // **********************************************


    // ====== عرض السجلات في الجدول (تم تعديلها لاستخدام filteredRecords) ======
    function renderRecords() {
      recordsBody.innerHTML = '';
      let lastDate = '';

      // استخدام filteredRecords بدلاً من recordsCache
      filteredRecords.forEach(rec => {
        const currentDate = formatDate(rec.timestamp);

        // إضافة فاصل اليوم إذا تغير التاريخ
        if (currentDate !== lastDate) {
            const row = recordsBody.insertRow();
            row.className = 'day-separator';
            const cell = row.insertCell();
            cell.colSpan = 7;
            cell.textContent = new Date(rec.timestamp).toLocaleDateString('ar-EG', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            lastDate = currentDate;
        }

        const row = recordsBody.insertRow();
        
        // الاسم
        const nameCell = row.insertCell();
        nameCell.textContent = rec.name;

        // رقم السيارة
        const numberCell = row.insertCell();
        numberCell.textContent = rec.number;

        // جهة الدخول
        const collegeCell = row.insertCell();
        collegeCell.textContent = rec.college;

        // وقت الدخول
        const inTimeCell = row.insertCell();
        inTimeCell.className = 'time-in';
        inTimeCell.textContent = rec.inTime;

        // وقت الخروج
        const outTimeCell = row.insertCell();
        outTimeCell.className = rec.outTime ? 'time-out' : '';
        outTimeCell.textContent = rec.outTime || '—';

        // الملاحظات
        const notesCell = row.insertCell();
        notesCell.textContent = rec.notes || '—';

        // الإجراء (زر الخروج)
        const actionCell = row.insertCell();
        if (!rec.outTime) {
          const exitBtn = document.createElement('button');
          exitBtn.className = 'exit-btn';
          exitBtn.textContent = 'خروج';
          exitBtn.setAttribute('data-id', rec.id);
          actionCell.appendChild(exitBtn);
        } else {
          actionCell.textContent = 'تم الخروج';
        }
      });
    }

    // ====== بدء التحميل الأولي ======
    async function loadInitialData() {
      await fetchCarsData();
      loadRecordsFromLocalStorage();
      // renderRecords() يتم استدعاؤها داخل applyFilters التي يتم استدعاؤها داخل loadRecordsFromLocalStorage
    }

    // ====== وظيفة عرض الاقتراحات ======
    function renderSuggestions(q) {
      suggestionsWrap.innerHTML = '';
      if (q.length < 2) return; // لا تعرض شيئًا إلا بعد حرفين

      // ابحث في carsCache عن numbers تحتوي q
      const matches = carsCache.filter(c=> c.number && c.number.includes(q) );
      // خذ أول 10 نتيجة
      matches.slice(0,10).forEach(c=>{
        const card = document.createElement('div');
        card.className = 'suggestion-card';
        // التعديل المطلوب: إظهار جهة الدخول (college) مع رقم السيارة
        card.innerHTML = `<div style="font-size:13px;color:var(--blue-dark);">${c.number}</div><div style="font-size:12px;color:#0b0b0b;margin-top:4px">${c.name || ''}</div><div style="font-size:11px;color:#666;margin-top:2px">${c.college || ''}</div>`;
        card.addEventListener('click', ()=>{
          // عند النقر — عبّي الحقول
          carNumberInput.value = c.number || '';
          nameInput.value = c.name || '';
          collegeInput.value = c.college || '';
          suggestionsWrap.innerHTML = '';
        });
        suggestionsWrap.appendChild(card);
      });

      // لو مفيش نتائج نظهر رسالة صغيرة
      if(matches.length === 0){
        const no = document.createElement('div');
        no.style.color = '#666';
        no.style.fontWeight = '700';
        no.style.marginTop = '6px';
        no.textContent = 'لا توجد اقتراحات لهذه البداية';
        suggestionsWrap.appendChild(no);
      }
    }

    // ====== عند تغيير حقل رقم السيارة ======
    carNumberInput.addEventListener('input', (e)=>{
      renderSuggestions(e.target.value.trim());
    });

    // ====== عند اختيار رقم أو الخروج من الحقل ======
    carNumberInput.addEventListener('change', ()=>{
      const val = carNumberInput.value.trim();
      if(!val) return;
      const found = carsCache.find(c => c.number === val);
      if(found){
        nameInput.value = found.name || '';
        collegeInput.value = found.college || '';
      }
    });

    // ====== تسجيل دخول — يخزن في Local Storage ======
    loginBtn.addEventListener('click', async ()=>{
      const number = carNumberInput.value.trim();
      const name = nameInput.value.trim();
      const college = collegeInput.value.trim();
      const notes = notesInput.value.trim();

      if(!number || !name){
        showNotification('من فضلك أدخل رقم السيارة ثم اختر الاقتراح أو املأ الاسم.', 'error');
        return;
      }

      // 1. التحقق مما إذا كانت السيارة مسجلة دخول بالفعل (التعديل المطلوب)
      const isAlreadyIn = recordsCache.some(rec => 
        rec.number === number && !rec.outTime // نتحقق من نفس الرقم وعدم وجود وقت خروج
      );

      if (isAlreadyIn) {
        // إذا كانت مسجلة بالفعل، نوقف العملية ونعرض إشعار تحذيري أنيق
        // التعديل المطلوب: رسالة تنبيه أنيقة
        const existingRecord = recordsCache.find(rec => rec.number === number && !rec.outTime);
        const entryTime = existingRecord ? existingRecord.inTime : 'وقت غير معروف';
        const entryCollege = existingRecord ? existingRecord.college : 'جهة غير معروفة';
        
        showNotification(`⚠️ السيارة رقم ${number} مسجلة دخول بالفعل! (جهة: ${entryCollege}، وقت: ${entryTime})`, 'warning');
        return;
      }

      try {
        // تعطيل الزر أثناء الحفظ
        loginBtn.disabled = true;
        loginBtn.textContent = '⏳ جارٍ الحفظ...';

        // وقت بصيغة 12 ساعة لعرض، وtimestamp للفرز
        const ts = Date.now();
        const inTime = formatTime(ts);
        const id = 'rec_' + ts; // معرّف فريد

        // حفظ في Local Storage
        recordsCache.push({ id, name, number, college, notes, inTime, outTime:'', timestamp:ts });
        saveRecordsToLocalStorage();
        
        // إعادة تطبيق الفلاتر لعرض السجل الجديد
        applyFilters(); 

        // نظف الحقول
        carNumberInput.value = '';
        nameInput.value = '';
        collegeInput.value = '';
        notesInput.value = '';
        suggestionsWrap.innerHTML = '';

        showNotification('✅ تم تسجيل الدخول بنجاح!', 'success');
      } catch(err){
        console.error('خطأ في الحفظ', err);
        showNotification('حدث خطأ أثناء حفظ السجل', 'error');
      } finally {
        // إعادة تفعيل الزر
        loginBtn.disabled = false;
        loginBtn.textContent = '➕ تسجيل دخول';
      }
    });

    // ====== تسجيل الخروج — يحدث outTime في Local Storage ======
    recordsBody.addEventListener('click', async (e)=>{
      if(e.target && e.target.classList.contains('exit-btn')){
        const id = e.target.getAttribute('data-id');
        const ts = Date.now();
        const outTime = formatTime(ts);

        try{
          // تعطيل الزر أثناء الحفظ
          e.target.disabled = true;
          e.target.textContent = '⏳...';

          // تحديث في Local Storage
          const rec = recordsCache.find(r=> r.id === id);
          if(rec){ 
            rec.outTime = outTime; 
            rec.outTimestamp = ts; 
          }
          saveRecordsToLocalStorage();

          // تحديث واجهة المستخدم
          applyFilters();

          showNotification('✅ تم تسجيل الخروج بنجاح!', 'success');
        } catch(err){
          console.error('خطأ في تحديث الخروج', err);
          showNotification('فشل تسجيل الخروج', 'error');
          e.target.disabled = false;
          e.target.textContent = 'خروج';
        }
      }
    });

    // ====== بدء التحميل عند فتح الصفحة ======
    loadInitialData();
  </script>
</body>
</html>
