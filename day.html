<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ù†Ø¸Ø§Ù… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª â€” Ø¬Ø§Ù…Ø¹Ø© Ø­Ù„ÙˆØ§Ù† Ø§Ù„Ø£Ù‡Ù„ÙŠØ©</title>

<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@600;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

<style>
:root{
  --blue-dark: #0d47a1;
  --blue-soft: #e7f3ff;
  --card-blue: #d8eefe;
  --accent: #1976d2;
  --black-bold: #0b0b0b;
  --danger: #d32f2f;
  --green: #2e7d32;
}

html,body{height:100%;margin:0}
body{
  font-family:'Cairo',sans-serif;
  background: linear-gradient(180deg,#f8fbff 0%, #e9f7ff 100%);
  color: var(--black-bold);
  display:flex;
  flex-direction:column;
  align-items:center;
  padding:14px;
}

/* --- Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø¹Ø§Ù…Ø© --- */
.title { color: var(--blue-dark); font-size:24px; font-weight:900; text-align:center; margin-top:10px; margin-bottom:4px; letter-spacing: 0.5px; text-shadow: 0 1px 2px rgba(0,0,0,0.05);}
.status-wrap{ width:100%; max-width:520px; overflow:hidden; border-radius:10px; margin-bottom:12px; background:linear-gradient(90deg, rgba(255,255,255,0.15), rgba(255,255,255,0.05)); border:1px solid rgba(13,71,161,0.06);}
.status { display:block; white-space:nowrap; padding:8px 12px; font-weight:700; color:var(--black-bold); background: linear-gradient(90deg, rgba(235,246,255,0.6), rgba(255,255,255,0)); transform:translateX(100%); animation: slideRTL 8s linear infinite; font-size:14px; }
@keyframes slideRTL { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); }}

.card { width:100%; max-width:520px; background:#fff; border-radius:14px; padding:14px; box-shadow:0 8px 30px rgba(13,71,161,0.06); margin-bottom:12px; box-sizing:border-box; }
label{ display:block; text-align:right; margin:8px 0 6px; font-weight:800; color:var(--black-bold); font-size:15px; }
.input { width:100%; padding:12px 14px; border-radius:12px; border:1px solid #d6eaf8; background: var(--card-blue); text-align:center; font-size:16px; font-weight:700; color:var(--black-bold); outline:none; box-sizing:border-box; }
.input:focus{ box-shadow:0 6px 18px rgba(33,150,243,0.12); border-color:var(--accent); background:#eef8ff; }
textarea.input { min-height:60px; resize:vertical; padding-top:10px; }
.btn-primary { margin-top:12px; width:100%; padding:12px; border-radius:12px; border:none; background: linear-gradient(90deg,#1565c0,#42a5f5); color:white; font-weight:800; font-size:16px; cursor:pointer; transition:opacity 0.3s ease; }
.btn-primary:active{transform:scale(.995)}
.btn-primary:disabled{opacity:.6;cursor:not-allowed}
.btn-secondary { display: block; width: 100%; text-align: center; padding: 8px; border-radius: 12px; border: 1px solid var(--accent); background: #fff; color: var(--accent); font-weight: 800; font-size: 15px; cursor: pointer; transition: background 0.3s ease; text-decoration: none; box-sizing: border-box; }
.btn-secondary:hover { background: var(--blue-soft); }

.suggestions { margin-top:8px; display:flex; flex-wrap:wrap; gap:8px; justify-content:flex-start; }

.suggestion-card {
    text-align: right;
    padding: 8px 12px;
    width: 100%;
    display: block;
    background: linear-gradient(180deg,#e8f6ff, #d7efff);
    border-radius: 12px;
    cursor: pointer;
    box-sizing: border-box;
    border: 1px solid rgba(13,71,161,0.06);
    transition: transform .12s ease, box-shadow .12s ease;
}
.suggestion-card:hover{ transform:translateY(-4px); box-shadow:0 8px 20px rgba(13,71,161,0.08) }

.suggestion-card .car-num { font-size: 16px; font-weight: 900; color: var(--blue-dark); }
.suggestion-card .details { font-size: 12px; font-weight: 600; color: #555; }

.filter-bar { display: flex; gap: 8px; margin-bottom: 12px; width: 100%; max-width: 520px; }
.filter-bar .input { padding: 8px 10px; font-size: 14px; font-weight: 600; height: 40px; }
.filter-bar select.input { flex-shrink: 0; width: 140px; text-align: right; padding-right: 14px; }
.filter-bar .input[type="text"] { flex-grow: 1; }

.table-wrap{ width:100%; max-width:520px; background:#fff; border-radius:12px; overflow:auto; box-shadow:0 8px 20px rgba(13,71,161,0.04); margin-top:10px; }
table { width:100%; border-collapse:collapse; }

th, td{ padding:4px; text-align:center; border-bottom:1px solid #e0eaf3; font-weight:700; color:var(--black-bold); font-size:9px; white-space: normal; }
th{ background:var(--accent); color:#fff; font-size:9px; font-weight:800; border-bottom: 2px solid var(--blue-dark); }
.time-in{ color:var(--green); font-weight: 800; }
.time-out{ color:var(--danger); font-weight: 800; }
.exit-btn{ background:var(--danger); color:#fff; border:none; padding:4px 6px; border-radius:6px; font-weight:800; font-size:10px; cursor:pointer; transition:opacity 0.3s ease; }

.day-separator td { background: var(--blue-soft); color: var(--blue-dark); font-weight: 800; text-align: center; padding: 6px; border-bottom: 2px solid var(--accent); border-top: 2px solid var(--accent); font-size: 12px; }

.admin-controls, .admin-only, .exit-btn, th.action-col, td.action-cell { display: none; }
body.admin-logged-in .admin-controls,
body.admin-logged-in .admin-only,
body.admin-logged-in .exit-btn,
body.admin-logged-in th.action-col,
body.admin-logged-in td.action-cell { display: revert; }

#adminLoginIcon { position: fixed; top: 15px; left: 15px; width: 44px; height: 44px; background: var(--blue-dark); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 22px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 1001; }
#adminLogoutBtn { display: none; }
body.admin-logged-in #adminLoginIcon { display: none; }
body.admin-logged-in #adminLogoutBtn { display: block; }

.modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 2000; }
.modal-content { background: white; padding: 20px; border-radius: 14px; width: 90%; max-width: 340px; text-align: center; }
.modal-overlay.show { display: flex; }

.notification { position: fixed; top: 20px; right: 20px; padding: 12px 16px; border-radius: 8px; font-weight: 700; font-size: 14px; z-index: 1000; transition: transform 0.3s ease, opacity 0.5s ease; }
.notification.success { background: #4caf50; color: white; }
.notification.error { background: #f44336; color: white; }
.notification.info { background: #2196F3; color: white; }
@keyframes slideIn { from { transform: translateX(110%); } to { transform: translateX(0); } }
.notification { animation: slideIn 0.3s ease-out forwards; }
.notification.fade-out { transform: translateX(110%); opacity: 0; }

</style>
</head>
<body>

<div id="adminLoginIcon" title="Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„"><i class="bi bi-person-fill-lock"></i></div>
<button id="adminLogoutBtn" class="btn-secondary admin-only" style="position: fixed; top: 15px; left: 15px; width: auto; padding: 8px 16px; z-index: 1001;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>

<div id="adminLoginModal" class="modal-overlay">
    <div class="modal-content">
        <h3 style="color: var(--blue-dark); margin-top: 0;">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</h3>
        <label for="adminUser">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
        <input id="adminUser" class="input" value="admin">
        <label for="adminPass">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
        <input id="adminPass" type="password" class="input">
        <button id="submitAdminLogin" class="btn-primary">Ø¯Ø®ÙˆÙ„</button>
        <button id="cancelAdminLogin" class="btn-secondary" style="margin-top: 8px;">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
</div>


<div style="width:100%;max-width:520px;">
<div class="title">ğŸš— Ù†Ø¸Ø§Ù… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª â€” Ø¬Ø§Ù…Ø¹Ø© Ø­Ù„ÙˆØ§Ù† Ø§Ù„Ø£Ù‡Ù„ÙŠØ©</div>
<div class="footer">ØªÙ… Ø§Ù„ØªØµÙ…ÙŠÙ… Ø¨ÙˆØ§Ø³Ø·Ø© / Ù…Ø­Ù…Ø¯ Ø±Ø¬Ø¨</div>

<div class="status-wrap" aria-hidden="true">
  <span id="status" class="status">âœ… Ø¬Ø§Ù‡Ø² Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span>
</div>

<div class="admin-controls">
    <div class="card">
        <button id="uploadBtn" class="btn-secondary">â¬†ï¸ Ø±ÙØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†</button>
    </div>
</div>

<div class="admin-controls">
    <div class="card">
      <label for="carNumberInput">Ø±Ù‚Ù… Ø§Ù„Ø³ÙŠØ§Ø±Ø©</label>
      <input id="carNumberInput" class="input" placeholder="Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ø³ÙŠØ§Ø±Ø©" autocomplete="off" />
      <div id="suggestions" class="suggestions" aria-live="polite"></div>
      <label for="nameInput">Ø§Ù„Ø§Ø³Ù…</label>
      <input id="nameInput" class="input" placeholder="Ø§Ù„Ø§Ø³Ù…" />
      <label for="collegeInput">Ø¬Ù‡Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„</label>
      <input id="collegeInput" class="input" placeholder="Ø¬Ù‡Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„" />
      <label for="notesInput">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
      <textarea id="notesInput" class="input" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></textarea>
      <button id="loginBtn" class="btn-primary">â• ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ù…Ø­Ù„ÙŠ</button>
    </div>
</div>

<div class="filter-bar">
    <select id="filterDate" class="input" title="ÙÙ„ØªØ± Ø­Ø³Ø¨ Ø§Ù„ÙŠÙˆÙ…">
        <option value="">ÙƒÙ„ Ø§Ù„Ø£ÙŠØ§Ù…</option>
    </select>
    <input type="text" id="searchQuery" class="input" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ø³ÙŠØ§Ø±Ø©" title="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ø³ÙŠØ§Ø±Ø©">
</div>

<div class="table-wrap" style="margin-top:12px;">
  <table id="recordsTable" aria-live="polite">
    <thead>
      <tr>
        <th>Ø§Ù„Ø§Ø³Ù…</th>
        <th>Ø±Ù‚Ù…</th>
        <th>Ø¬Ù‡Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„</th>
        <th>ÙˆÙ‚Øª Ø§Ù„Ø¯Ø®ÙˆÙ„</th>
        <th>ÙˆÙ‚Øª Ø§Ù„Ø®Ø±ÙˆØ¬</th>
        <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
        <th class="action-col">Ø¥Ø¬Ø±Ø§Ø¡</th>
      </tr>
    </thead>
    <tbody id="recordsBody"></tbody>
  </table>
</div>

</div>

<script type="module">
// Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù„Ø§Ø²Ù…Ø© Ù…Ù† Firebase Ù…Ø¹ Ø¥Ø¶Ø§ÙØ© onValue
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, get, update, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

// ====== Firebase Config ======
const firebaseConfig = {
  apiKey: "AIzaSyDBSiTb1m0osdrX7YOv4ADr8x-7TghSqmY",
  authDomain: "day3069-e27df.firebaseapp.com",
  databaseURL: "https://day3069-e27df-default-rtdb.firebaseio.com",
  projectId: "day3069-e27df",
  storageBucket: "day3069-e27df.firebasestorage.app",
  messagingSenderId: "110258698429",
  appId: "1:110258698429:web:fcc4114a83829756329fd4",
  measurementId: "G-Q3LN0HTXXZ"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const dbRef = ref(db);

// ====== Ø¹Ù†Ø§ØµØ± DOM ======
const carNumberInput = document.getElementById('carNumberInput');
const nameInput = document.getElementById('nameInput');
const collegeInput = document.getElementById('collegeInput');
const notesInput = document.getElementById('notesInput');
const loginBtn = document.getElementById('loginBtn');
const suggestionsWrap = document.getElementById('suggestions');
const recordsBody = document.getElementById('recordsBody');
const filterDateInput = document.getElementById('filterDate');
const searchQueryInput = document.getElementById('searchQuery');
const uploadBtn = document.getElementById('uploadBtn');
const adminLoginIcon = document.getElementById('adminLoginIcon');
const adminLoginModal = document.getElementById('adminLoginModal');
const adminPassInput = document.getElementById('adminPass');
const submitAdminLoginBtn = document.getElementById('submitAdminLogin');
const cancelAdminLoginBtn = document.getElementById('cancelAdminLogin');
const adminLogoutBtn = document.getElementById('adminLogoutBtn');
const statusSpan = document.getElementById('status');

// ====== Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø© ======
let cloudRecords = [];
let localRecords = [];
let carsCache = [];
let isInitialLoad = true; // Ù…ØªØºÙŠØ± Ù„ØªØªØ¨Ø¹ Ø£ÙˆÙ„ ØªØ­Ù…ÙŠÙ„ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª

// ====== Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© ======
function showNotification(message, type = 'success') {
    const n = document.createElement('div');
    n.className = `notification ${type}`;
    n.textContent = message;
    document.body.appendChild(n);
    setTimeout(() => {
        n.classList.add('fade-out');
        n.addEventListener('transitionend', () => n.remove());
    }, 3000);
}

function formatTime(ts) { const d = new Date(ts); const h = d.getHours(); const m = d.getMinutes(); const ampm = h >= 12 ? 'Ù…' : 'Øµ'; return `${h % 12 || 12}:${m < 10 ? '0' + m : m} ${ampm}`; }
function formatDate(ts) { const d = new Date(ts); return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`; }

// ====== Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ ======
function loadLocalRecords() {
    const stored = localStorage.getItem('localCarRecords');
    localRecords = stored ? JSON.parse(stored) : [];
    updateUploadButtonState();
}

function saveLocalRecords() {
    localStorage.setItem('localCarRecords', JSON.stringify(localRecords));
    updateUploadButtonState();
}

function updateUploadButtonState() {
    const count = localRecords.length;
    uploadBtn.textContent = count > 0 ? `â¬†ï¸ Ø±ÙØ¹ ${count} Ø³Ø¬Ù„ Ù…Ø­Ù„ÙŠ Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†` : 'âœ… Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù…Ø­Ù„ÙŠØ© Ù„Ù„Ø±ÙØ¹';
    uploadBtn.disabled = count === 0;
}

// ====== Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ù…Ø¬Ø© ======
function renderCombinedRecords() {
    const allRecords = [...cloudRecords, ...localRecords];
    const selDate = filterDateInput.value;
    const sq = searchQueryInput.value.trim().toLowerCase();
    
    const filteredRecords = allRecords.filter(r => {
        const dateMatch = !selDate || formatDate(r.timestamp) === selDate;
        const searchMatch = !sq || (r.name && r.name.toLowerCase().includes(sq)) || (r.number && r.number.toLowerCase().includes(sq));
        return dateMatch && searchMatch;
    });

    // ÙØ±Ø² ØªÙ†Ø§Ø²Ù„ÙŠ (Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹)
    filteredRecords.sort((a, b) => b.timestamp - a.timestamp);
    
    recordsBody.innerHTML = '';

    if (filteredRecords.length === 0) {
        recordsBody.innerHTML = '<tr><td colspan="7" style="padding:16px; color:#999;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§</td></tr>';
        return;
    }

    let lastDate = null;
    filteredRecords.forEach(r => {
        const currentDate = formatDate(r.timestamp);
        if (currentDate !== lastDate) {
            const dateRow = recordsBody.insertRow();
            dateRow.className = 'day-separator';
            const cell = dateRow.insertCell();
            cell.colSpan = 7;
            cell.textContent = currentDate;
            lastDate = currentDate;
        }

        const row = recordsBody.insertRow();
        row.dataset.id = r.id;
        // Ø¥Ø¶Ø§ÙØ© Ø¹Ù„Ø§Ù…Ø© Ù„Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        if (localRecords.some(local => local.id === r.id)) {
            row.style.backgroundColor = 'var(--blue-soft)';
        }

        row.insertCell().textContent = r.name;
        row.insertCell().textContent = r.number;
        row.insertCell().textContent = r.college;
        
        const inTimeCell = row.insertCell();
        inTimeCell.className = 'time-in';
        inTimeCell.textContent = r.inTime;
        
        const outTimeCell = row.insertCell();
        outTimeCell.className = r.outTime ? 'time-out' : '';
        outTimeCell.textContent = r.outTime || '-';
        
        row.insertCell().textContent = r.notes || '-';
        
        const actionCell = row.insertCell();
        actionCell.className = 'action-cell';
        if (!r.outTime) {
            const exitBtn = document.createElement('button');
            exitBtn.className = 'exit-btn';
            exitBtn.dataset.id = r.id;
            exitBtn.textContent = 'Ø®Ø±ÙˆØ¬';
            actionCell.appendChild(exitBtn);
        }
    });
}

function populateDateFilter() {
    const allRecords = [...cloudRecords, ...localRecords];
    const dates = [...new Set(allRecords.map(r => formatDate(r.timestamp)))];
    dates.sort((a, b) => new Date(b) - new Date(a));
    const currentFilter = filterDateInput.value;
    filterDateInput.innerHTML = '<option value="">ÙƒÙ„ Ø§Ù„Ø£ÙŠØ§Ù…</option>';
    dates.forEach(date => {
        const option = document.createElement('option');
        option.value = date;
        option.textContent = date;
        filterDateInput.appendChild(option);
    });
    // Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„ÙÙ„ØªØ± Ø§Ù„Ù…Ø®ØªØ§Ø±
    if (dates.includes(currentFilter)) {
        filterDateInput.value = currentFilter;
    }
}

// ====== Ø¹Ø±Ø¶ Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª ======
function renderSuggestions(query) {
    suggestionsWrap.innerHTML = '';
    if (query.length < 2 || carsCache.length === 0) return;
    
    const matches = carsCache.filter(c => c.carNumber && c.carNumber.includes(query));
    matches.slice(0, 5).forEach(car => {
        const card = document.createElement('div');
        card.className = 'suggestion-card';
        const carNumDiv = document.createElement('div');
        carNumDiv.className = 'car-num';
        carNumDiv.textContent = car.carNumber;
        const detailsDiv = document.createElement('div');
        detailsDiv.className = 'details';
        detailsDiv.textContent = `${car.ownerName} - ${car.entrance}`;
        card.appendChild(carNumDiv);
        card.appendChild(detailsDiv);
        card.onclick = () => {
            carNumberInput.value = car.carNumber;
            nameInput.value = car.ownerName;
            collegeInput.value = car.entrance;
            notesInput.value = car.notes || '';
            suggestionsWrap.innerHTML = '';
            nameInput.focus();
        };
        suggestionsWrap.appendChild(card);
    });
}

// ====== ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„Ø®Ø±ÙˆØ¬ (Ù…Ø­Ù„ÙŠ ÙÙ‚Ø·) ======
loginBtn.addEventListener('click', () => {
    const number = carNumberInput.value.trim(), name = nameInput.value.trim(), college = collegeInput.value.trim(), notes = notesInput.value.trim();
    if (!number || !name) { showNotification('Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø³ÙŠØ§Ø±Ø© ÙˆØ§Ù„Ø§Ø³Ù…', 'error'); return; }
    
    const allRecords = [...cloudRecords, ...localRecords];
    if (allRecords.some(r => r.number === number && !r.outTime)) {
        showNotification(`âš ï¸ Ø§Ù„Ø³ÙŠØ§Ø±Ø© ${number} Ù…Ø³Ø¬Ù„Ø© Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„ÙØ¹Ù„!`, 'warning');
        return;
    }

    const ts = Date.now();
    const newRecord = { id: 'rec_' + ts, name, number, college, notes, inTime: formatTime(ts), outTime: '', timestamp: ts };
    
    localRecords.push(newRecord);
    saveLocalRecords();
    
    populateDateFilter();
    renderCombinedRecords();
    
    carNumberInput.value = ''; nameInput.value = ''; collegeInput.value = ''; notesInput.value = ''; suggestionsWrap.innerHTML = '';
    showNotification('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø­Ù„ÙŠØ§Ù‹ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
});

recordsBody.addEventListener('click', e => {
    const exitButton = e.target.closest('.exit-btn');
    if (!exitButton) return;

    const recId = exitButton.dataset.id;
    let record = localRecords.find(r => r.id === recId);

    if (record) {
        record.outTime = formatTime(Date.now());
        record.outTimestamp = Date.now();
    } else {
        record = cloudRecords.find(r => r.id === recId);
        if (record) {
            // Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ù…Ø­Ø¯Ø«Ø© Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ Ù…Ø¨Ø§Ø´Ø±Ø©
            const updatedRecord = { ...record, outTime: formatTime(Date.now()), outTimestamp: Date.now() };
            // Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ù…Ù† Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ (Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªÙƒØ±Ø§Ø±)
            localRecords = localRecords.filter(r => r.id !== recId);
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø­Ø¯Ø« Ø¥Ù„Ù‰ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
            localRecords.push(updatedRecord);
        }
    }
    
    saveLocalRecords();
    renderCombinedRecords();
    showNotification('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ø­Ù„ÙŠØ§Ù‹!', 'success');
});

// ====== Ø±ÙØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† ======
uploadBtn.addEventListener('click', async () => {
    if (localRecords.length === 0) return;

    uploadBtn.disabled = true;
    uploadBtn.textContent = `â³ Ø¬Ø§Ø±Ù Ø±ÙØ¹ ${localRecords.length} Ø³Ø¬Ù„...`;

    const updates = {};
    localRecords.forEach(record => {
        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ timestamp
        const ts = record.timestamp || Date.now();
        const datePath = formatDate(ts).replace(/-/g, '');
        updates[`records/${datePath}/${record.id}`] = record;
    });

    try {
        await update(dbRef, updates);
        showNotification(`âœ… ØªÙ… Ø±ÙØ¹ ${localRecords.length} Ø³Ø¬Ù„ Ø¨Ù†Ø¬Ø§Ø­!`, 'success');
        
        // Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø¨Ø¹Ø¯ Ø±ÙØ¹Ù‡Ø§ Ø¨Ù†Ø¬Ø§Ø­
        localRecords = [];
        saveLocalRecords();
        
        // Ù„Ø§ Ø­Ø§Ø¬Ø© Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø¥Ù„Ù‰ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠØ© ÙŠØ¯ÙˆÙŠØ§Ù‹
        // Ù„Ø£Ù† onValue Ø³ÙŠÙ‚ÙˆÙ… Ø¨ØªØ­Ø¯ÙŠØ«Ù‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
        // renderCombinedRecords(); // onValue Ø³ÙŠØªÙˆÙ„Ù‰ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¹Ø±Ø¶
    } catch (error) {
        showNotification('âŒ ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.', 'error');
        console.error("Upload failed:", error);
    } finally {
        updateUploadButtonState();
    }
});

// ====== Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø© (Ø¨Ø´ÙƒÙ„ Ù„Ø­Ø¸ÙŠ) ======
function listenToCloudRecords() {
    const recordsRef = ref(db, 'records');
    onValue(recordsRef, (snapshot) => {
        cloudRecords = []; // Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
        if (snapshot.exists()) {
            const allDays = snapshot.val();
            Object.values(allDays).forEach(dayRecords => {
                cloudRecords.push(...Object.values(dayRecords));
            });
            statusSpan.textContent = `ğŸ”„ Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ${formatTime(Date.now())} | ${cloudRecords.length} Ø³Ø¬Ù„ Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†`;
        } else {
            statusSpan.textContent = "â„¹ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø³Ø­Ø§Ø¨ÙŠØ© Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.";
        }

        if (isInitialLoad) {
            showNotification('â˜ï¸ ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­', 'info');
            isInitialLoad = false;
        } else {
            showNotification('ğŸ”„ ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹!', 'info');
        }
        
        populateDateFilter();
        renderCombinedRecords();
    }, (error) => {
        showNotification('âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
        console.error("Real-time listener failed:", error);
        statusSpan.textContent = "âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª";
    });
}

async function fetchCarsData() {
    try {
        const carsSnapshot = await get(ref(db, 'cars'));
        if (carsSnapshot.exists()) {
            carsCache = Object.values(carsSnapshot.val());
        }
    } catch (error) {
        console.error("Cars data fetch failed:", error);
        showNotification('âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª', 'error');
    }
}

// ====== Ù…Ù†Ø·Ù‚ Ø§Ù„Ø£Ø¯Ù…Ù† ======
function setAdminMode(loggedIn) {
    document.body.classList.toggle('admin-logged-in', loggedIn);
    sessionStorage.setItem('isAdmin', loggedIn ? 'true' : 'false');
}

adminLoginIcon.addEventListener('click', () => { adminLoginModal.classList.add('show'); adminPassInput.focus(); });
cancelAdminLoginBtn.addEventListener('click', () => { adminLoginModal.classList.remove('show'); });
adminLogoutBtn.addEventListener('click', () => { setAdminMode(false); showNotification('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬', 'info'); });

submitAdminLoginBtn.addEventListener('click', () => {
    const user = document.getElementById('adminUser').value;
    const pass = adminPassInput.value;
    if (user === 'admin' && pass === '123456') {
        setAdminMode(true);
        adminLoginModal.classList.remove('show');
        showNotification('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒÙ…Ø³Ø¤ÙˆÙ„', 'success');
    } else {
        showNotification('âŒ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©', 'error');
    }
});

// ====== Ù…Ø³ØªÙ…Ø¹Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø« ======
filterDateInput.addEventListener('change', renderCombinedRecords);
searchQueryInput.addEventListener('input', renderCombinedRecords);
carNumberInput.addEventListener('input', (e) => renderSuggestions(e.target.value.trim()));

// ====== Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„ ======
async function init() {
    if (sessionStorage.getItem('isAdmin') === 'true') {
        setAdminMode(true);
    }
    loadLocalRecords();
    await fetchCarsData();
    // Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù„Ø­Ø¸ÙŠØ© Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ø¬Ù„Ø¨ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©
    listenToCloudRecords();
    // Ù„Ø§ Ø­Ø§Ø¬Ø© Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ renderCombinedRecords Ùˆ populateDateFilter Ù‡Ù†Ø§
    // Ù„Ø£Ù† listenToCloudRecords Ø³ØªÙ‚ÙˆÙ… Ø¨Ø°Ù„Ùƒ Ø¹Ù†Ø¯ Ø£ÙˆÙ„ Ø§ØªØµØ§Ù„
}

init();
</script>
</body>
</html>

