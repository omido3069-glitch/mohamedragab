<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ ÙˆØ®Ø±ÙˆØ¬ Ø³ÙŠØ§Ø±Ø§Øª â€” ÙƒØ§Ù…Ù„</title>

  <!-- Tailwind (Ù„Ù„Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase Compat (Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù€ compat Ø¹Ù„Ø´Ø§Ù† Ù†Ù‚Ø¯Ø± Ù†Ø¹Ù…Ù„ Ø£ÙƒØ«Ø± Ù…Ù† app) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <style>
    body { background: linear-gradient(-45deg,#1e3c72,#2a5298,#6dd5ed,#2193b0); background-size:400% 400%; animation:gradientBG 12s ease infinite; }
    @keyframes gradientBG{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
    .date-separator{background:linear-gradient(to right,#facc15,#f59e0b);color:#1e293b;font-weight:bold;text-align:center;padding:10px;font-size:1rem;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.2);}
    input:focus{outline:none;box-shadow:0 0 8px rgba(37,99,235,0.35);border:2px solid #2563eb}
    table{min-width:1100px}
    /* Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª */
    .suggestions{position:absolute;z-index:60;width:100%;max-height:240px;overflow:auto;background:white;border-radius:8px;box-shadow:0 8px 30px rgba(0,0,0,0.15)}
    .suggestion-item{padding:10px 12px;cursor:pointer;border-bottom:1px solid #f1f5f9;direction:rtl}
    .suggestion-item:hover,.suggestion-item.active{background:#eef2ff}
    .no-suggestion{padding:10px 12px;color:#64748b}
    /* ØªÙˆØ³Øª */
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:rgba(20,20,20,0.9);color:white;padding:10px 14px;border-radius:8px;z-index:200}
    /* Ø¨Ø§Ø¯Ø¬ Ø§ÙˆÙÙ„Ø§ÙŠÙ† */
    .offline-badge{display:inline-block;background:#f43f5e;color:white;padding:2px 7px;border-radius:8px;font-size:11px;margin-left:8px}
    /* Ø²Ø± Ø§Ù„Ø®Ø±ÙˆØ¬ Ø£Ø¹Ù„Ù‰ ÙŠØ³Ø§Ø± */
    #logoutBtn{position:fixed;top:14px;left:14px;z-index:300}
  </style>
</head>
<body class="min-h-screen p-6 flex flex-col items-center">

  <!-- Ø²Ø± Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£Ø¯Ù…Ù† Ø§Ù„Ø¬Ø¯ÙŠØ¯ -->
  <button onclick="openAdminModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg mb-4 shadow-lg hover:opacity-90">
    ğŸ”‘ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£Ø¯Ù…Ù†
  </button>

  <!-- Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù„Ù„Ø£Ø¯Ù…Ù† (ÙÙˆÙ‚ Ø§Ù„Ø´Ù…Ø§Ù„) -->
  <button id="logoutBtn" class="hidden bg-red-600 text-white px-4 py-2 rounded-2xl shadow-lg hover:opacity-90">ğŸ”“ ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>

  <div class="w-full max-w-[1200px] bg-white/90 rounded-2xl shadow-2xl p-6 backdrop-blur-md">
    <h1 class="text-3xl font-bold text-center mb-4 text-blue-900">ğŸš— Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ ÙˆØ®Ø±ÙˆØ¬ Ø³ÙŠØ§Ø±Ø§Øª</h1>
    <div id="statusNotice" class="mb-4 p-3 rounded-lg bg-yellow-100 border border-yellow-400 text-yellow-800 font-semibold text-center shadow">
      âš ï¸ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ù…Ø­Ù„ÙŠÙ‹Ø§ Ø£ÙˆÙÙ„Ø§ÙŠÙ† ÙˆØªÙØ±ÙØ¹ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¹Ù†Ø¯ Ø¹ÙˆØ¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„.
    </div>

    <div id="errorBox" class="hidden mb-4 p-3 rounded-lg bg-red-100 border border-red-400 text-red-700 font-semibold text-center"></div>

    <!-- Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ -->
    <form id="logForm" class="relative grid grid-cols-4 gap-4 mb-6 hidden">
      <input id="name" class="border rounded-lg p-3" placeholder="ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…" />
      <div class="relative">
        <input id="plate" class="border rounded-lg p-3" placeholder="ğŸ”¢ Ø±Ù‚Ù… Ø§Ù„Ø³ÙŠØ§Ø±Ø©" autocomplete="off" />
        <div id="suggestions" class="suggestions hidden"></div>
      </div>
      <input id="entryGate" class="border rounded-lg p-3" placeholder="ğŸšª Ø¬Ù‡Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„" />
      <input id="notes" class="border rounded-lg p-3" placeholder="ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª" />
      <button type="submit" class="col-span-4 bg-gradient-to-r from-blue-600 to-blue-400 text-white p-3 rounded-lg shadow-lg hover:opacity-90">â• ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</button>
    </form>

    <div id="logoutAdmin" class="hidden text-left mb-4"></div>

    <!-- ÙÙ„ØªØ± ÙˆØ¨Ø­Ø« -->
    <div class="flex gap-4 items-center mb-4">
      <div>
        <label class="font-semibold text-gray-700">ğŸ“… Ø§Ø®ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
        <select id="dateFilter" class="border rounded-lg p-2">
          <option value="">ÙƒÙ„ Ø§Ù„Ø£ÙŠØ§Ù…</option>
        </select>
      </div>
      <div class="flex-1">
        <input id="searchInput" class="w-full border rounded-lg p-2" placeholder="ğŸ” Ø¨Ø­Ø«..." />
      </div>
    </div>

    <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª -->
    <div class="overflow-x-auto rounded-lg shadow-lg">
      <table class="w-full text-base border border-gray-300 bg-white">
        <thead class="bg-gradient-to-r from-blue-700 to-blue-500 text-white">
          <tr>
            <th class="p-3 border">#</th>
            <th class="p-3 border">ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…</th>
            <th class="p-3 border">ğŸ”¢ Ø±Ù‚Ù… Ø§Ù„Ø³ÙŠØ§Ø±Ø©</th>
            <th class="p-3 border">â° Ø§Ù„Ø¯Ø®ÙˆÙ„</th>
            <th class="p-3 border">ğŸšª Ø¬Ù‡Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„</th>
            <th class="p-3 border">ğŸš¦ Ø§Ù„Ø®Ø±ÙˆØ¬</th>
            <th class="p-3 border">ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
            <th class="p-3 border">âš™ï¸ Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
          </tr>
        </thead>
        <tbody id="logsBody" class="bg-white"></tbody>
      </table>
    </div>
  </div>

  <div id="adminModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl p-6 w-96 shadow-2xl">
      <h2 class="text-2xl font-bold mb-4 text-center">ğŸ”‘ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø£Ø¯Ù…Ù†</h2>
      <div id="adminError" class="hidden mb-3 p-2 rounded bg-red-100 text-red-700 text-sm text-center"></div>
      <input id="adminUser" class="border rounded-lg w-full p-3 mb-3" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" />
      <input id="adminPass" type="password" class="border rounded-lg w-full p-3 mb-3" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
      <div class="flex items-center mb-3">
        <input id="rememberMe" type="checkbox" class="mr-2" />
        <label for="rememberMe" class="text-gray-700">ØªØ°ÙƒØ±Ù†ÙŠ</label>
      </div>
      <div class="flex gap-3">
        <button onclick="checkAdminLogin()" class="flex-1 bg-green-600 text-white py-2 rounded-lg">Ø¯Ø®ÙˆÙ„</button>
        <button onclick="closeAdminModal()" class="flex-1 bg-gray-400 text-white py-2 rounded-lg">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast hidden"></div>

<script>
/* ============================
   Ø¥Ø¹Ø¯Ø§Ø¯ Firebase (Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª)
   ============================ */
const firebaseConfig = {
  apiKey: "AIzaSyDu7UfSHxNbU5MLQizUYme0ifwHBWWOC6g",
  authDomain: "companies-a701a.firebaseapp.com",
  databaseURL: "https://companies-a701a-default-rtdb.firebaseio.com",
  projectId: "companies-a701a",
  storageBucket: "companies-a701a.firebasestorage.app",
  messagingSenderId: "815579189112",
  appId: "1:815579189112:web:4da4125a903931526a828d",
  measurementId: "G-K9QRTY3SPJ"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ============================
   Ø±Ø¨Ø· Ù…Ø´Ø±ÙˆØ¹ hnu-3069 (Ù„Ù„Ù€ read ÙÙ‚Ø·)
   ============================ */
const externalApp = firebase.initializeApp(
  { databaseURL: "https://hnu-3069-default-rtdb.firebaseio.com/" },
  "external"
);
const externalDb = externalApp.database();

/* ============================
   Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù€ DOM ÙˆØ­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
   ============================ */
const plateInput = document.getElementById('plate');
const suggestionsBox = document.getElementById('suggestions');
const nameInput = document.getElementById('name');
const entryGateInput = document.getElementById('entryGate');
const notesInput = document.getElementById('notes');
const logForm = document.getElementById('logForm');
const toastEl = document.getElementById('toast');

let carsData = [];
let logs = [];
let isAdmin = false;

/* ============================
   Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø©
   ============================ */
function normalizeNumber(s){
  if(!s) return '';
  return s.replace(/\s+/g,'').toLowerCase();
}
function showToast(msg, ms = 2200){
  toastEl.textContent = msg;
  toastEl.classList.remove('hidden');
  clearTimeout(showToast._t);
  showToast._t = setTimeout(()=> toastEl.classList.add('hidden'), ms);
}
function formatTime(date){
  let h = date.getHours(), m = date.getMinutes();
  const ampm = h >= 12 ? 'Ù…' : 'Øµ';
  h = h % 12 || 12;
  m = m < 10 ? '0'+m : m;
  return h + ':' + m + ' ' + ampm;
}
function formatDateArabic(date){
  return date.toLocaleDateString('ar-EG', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
}

/* ============================
   ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª Ù…Ù† hnu-3069 Ù…Ø¹ ÙƒØ§Ø´ Ù…Ø­Ù„ÙŠ
   ============================ */
async function loadCarsData(){
  try {
    const snap = await externalDb.ref('cars').once('value');
    const obj = snap.val();
    if(obj){
      carsData = Object.keys(obj).map(k => ({ key: k, ...obj[k] }));
      localStorage.setItem('cachedCarsData', JSON.stringify(carsData));
      console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª Ù…Ù† hnu-3069.');
    } else {
      carsData = JSON.parse(localStorage.getItem('cachedCarsData') || '[]');
      console.log('â„¹ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ hnu-3069ØŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙƒØ§Ø´ Ø§Ù„Ù…Ø­Ù„ÙŠ Ø¥Ù† ÙˆÙØ¬Ø¯.');
    }
  } catch (err) {
    console.warn('âš ï¸ ÙØ´Ù„ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù€ hnu-3069 â€” Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙƒØ§Ø´ Ø§Ù„Ù…Ø­Ù„ÙŠ Ø¥Ù† ÙˆÙØ¬Ø¯.');
    carsData = JSON.parse(localStorage.getItem('cachedCarsData') || '[]');
  }
}
loadCarsData();

/* ============================
   Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª (Autocomplete)
   ============================ */
let currentSuggestions = [];
let highlightedIndex = -1;

function renderSuggestions(matches){
  suggestionsBox.innerHTML = '';
  if(!matches || matches.length === 0){
    suggestionsBox.innerHTML = '<div class="no-suggestion">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>';
    suggestionsBox.classList.remove('hidden');
    currentSuggestions = [];
    highlightedIndex = -1;
    return;
  }
  currentSuggestions = matches.slice(0, 12);
  currentSuggestions.forEach((car, idx) => {
    const div = document.createElement('div');
    div.className = 'suggestion-item';
    div.setAttribute('data-idx', idx);
    div.innerHTML = `<div class="font-semibold text-right">${car.number||''}</div>
                     <div class="text-sm text-gray-600 text-right">${car.name||''} â€” ${car.college||car.company||''}</div>`;
    div.addEventListener('click', () => selectSuggestion(idx));
    suggestionsBox.appendChild(div);
  });
  highlightedIndex = -1;
  suggestionsBox.classList.remove('hidden');
}

function selectSuggestion(idx){
  const car = currentSuggestions[idx];
  if(!car) return;
  nameInput.value = car.name || '';
  plateInput.value = car.number || '';
  entryGateInput.value = car.college || car.company || '';
  notesInput.value = (car.company && car.company !== 'Ù„Ø§ ÙŠÙˆØ¬Ø¯') ? car.company : (car.phone || '');
  suggestionsBox.classList.add('hidden');
  currentSuggestions = [];
  highlightedIndex = -1;
}

function fetchSuggestionsFromCache(prefix){
  if(!prefix || prefix.length < 2){
    renderSuggestions([]);
    return;
  }
  const np = normalizeNumber(prefix);
  const starts = [], contains = [];
  for(const car of carsData){
    if(!car.number) continue;
    const nn = normalizeNumber(car.number);
    if(nn.startsWith(np)) starts.push(car);
    else if(nn.includes(np)) contains.push(car);
  }
  renderSuggestions(starts.concat(contains));
}

function debounce(fn, delay=180){ let t; return function(...args){ clearTimeout(t); t = setTimeout(()=>fn.apply(this,args), delay); }; }
const debouncedFetch = debounce(v => fetchSuggestionsFromCache(v), 180);

plateInput.addEventListener('input', function(e){
  const v = this.value.trim();
  if(v.length >= 2) debouncedFetch(v);
  else { suggestionsBox.classList.add('hidden'); suggestionsBox.innerHTML = ''; currentSuggestions = []; highlightedIndex = -1; }
});
plateInput.addEventListener('keydown', function(e){
  if(suggestionsBox.classList.contains('hidden')) return;
  const items = suggestionsBox.querySelectorAll('.suggestion-item');
  if(e.key === 'ArrowDown'){ e.preventDefault(); if(highlightedIndex < items.length - 1) highlightedIndex++; updateHighlight(items); }
  else if(e.key === 'ArrowUp'){ e.preventDefault(); if(highlightedIndex > 0) highlightedIndex--; updateHighlight(items); }
  else if(e.key === 'Enter'){ e.preventDefault(); if(highlightedIndex >= 0) selectSuggestion(highlightedIndex); }
  else if(e.key === 'Escape'){ suggestionsBox.classList.add('hidden'); }
});
function updateHighlight(items){ items.forEach(it => it.classList.remove('active')); if(highlightedIndex >= 0 && items[highlightedIndex]) items[highlightedIndex].classList.add('active'); }
document.addEventListener('click', (e) => { if(!document.getElementById('plate').contains(e.target) && !suggestionsBox.contains(e.target)) suggestionsBox.classList.add('hidden'); });

/* ============================
   Ø£ÙˆÙÙ„Ø§ÙŠÙ†
   ============================ */
function saveOfflineLog(log){
  let offlineLogs = JSON.parse(localStorage.getItem('offlineLogs') || '[]');
  offlineLogs.push(log);
  localStorage.setItem('offlineLogs', JSON.stringify(offlineLogs));
  const offlineKey = 'offline-' + Date.now();
  logs.push({ ...log, key: offlineKey, _offline: true });
  renderLogs();
  showToast('ğŸ“´ ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„ Ù…Ø­Ù„ÙŠÙ‹Ø§ (ÙˆØ¶Ø¹ Ø¹Ø¯Ù… Ø§Ù„Ø§ØªØµØ§Ù„).');
}

async function syncOfflineLogs(){
  const offlineLogs = JSON.parse(localStorage.getItem('offlineLogs') || '[]');
  if(!offlineLogs || offlineLogs.length === 0) return;
  try { for(const log of offlineLogs){ await db.ref('carLogs').push(log); }
    localStorage.removeItem('offlineLogs');
    showToast(`âœ… ØªÙ… Ø±ÙØ¹ ${offlineLogs.length} Ø³Ø¬Ù„ Ù…Ù† ÙˆØ¶Ø¹ Ø¹Ø¯Ù… Ø§Ù„Ø§ØªØµØ§Ù„.`);
    setTimeout(() => { loadLogs(); }, 700);
  } catch (err){ console.error('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø³Ø¬Ù„Ø§Øª:', err); showToast('âš ï¸ ÙØ´Ù„ Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø³Ø¬Ù„Ø§ØªØŒ Ø³ÙŠØ¹Ø§Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ù‹Ø§.'); }
}
window.addEventListener('online', () => { loadCarsData().then(() => syncOfflineLogs()); });
if(navigator.onLine) { loadCarsData(); syncOfflineLogs(); }

/* ============================
   ØªØ­Ù…ÙŠÙ„ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„Ø§Øª
   ============================ */
function loadLogs(){
  db.ref('carLogs').on('value', snapshot => {
    const obj = snapshot.val();
    logs = [];
    if(obj){ Object.keys(obj).forEach(k => { logs.push({ key: k, ...obj[k] }); }); }
    const offlineLocal = JSON.parse(localStorage.getItem('offlineLogs') || '[]');
    if(offlineLocal && offlineLocal.length){
      offlineLocal.forEach(ol => {
        const keyComp = `${(ol.plate||'') }||${(ol.entryTime||'') }||${(ol.date||'')}`;
        const exists = logs.find(l => `${l.plate||''}||${l.entryTime||''}||${l.date||''}` === keyComp);
        if(!exists){ logs.push({ ...ol, key: 'offline-local-' + Math.random().toString(36).slice(2), _offline:true }); }
      });
    }
    populateDateFilter();
    renderLogs();
  });
}

function populateDateFilter(){
  const dateFilter = document.getElementById('dateFilter');
  const uniqueDates = [...new Set(logs.map(l => l.date))];
  dateFilter.innerHTML = '<option value="">ÙƒÙ„ Ø§Ù„Ø£ÙŠØ§Ù…</option>';
  uniqueDates.forEach(d => { const opt = document.createElement('option'); opt.value = d; opt.textContent = d; dateFilter.appendChild(opt); });
}

function renderLogs(){
  const tbody = document.getElementById('logsBody');
  tbody.innerHTML = '';
  const dateVal = document.getElementById('dateFilter').value;
  const searchVal = (document.getElementById('searchInput').value || '').toLowerCase();
  const seen = new Set();
  const display = [...logs].reverse();
  let index = 0; let lastDate = '';
  display.forEach(log => {
    const comp = `${(log.plate||'')}||${(log.entryTime||'')}||${(log.date||'')}`;
    if(seen.has(comp)) return; seen.add(comp);
    if(dateVal && log.date !== dateVal) return;
    if(searchVal && !((log.name||'').toLowerCase().includes(searchVal) || (log.plate||'').toLowerCase().includes(searchVal) || (log.entryGate||'').toLowerCase().includes(searchVal) || (log.notes||'').toLowerCase().includes(searchVal))) return;
    if(log.date !== lastDate){
      const trSep = document.createElement('tr'); const td = document.createElement('td');
      td.colSpan = 8; td.className = 'date-separator'; td.textContent = 'ğŸ“… ' + log.date; trSep.appendChild(td); tbody.appendChild(trSep); lastDate = log.date;
    }
    index++;
    const tr = document.createElement('tr');
    const offlineBadge = log._offline ? `<span class="offline-badge">ÙˆØ¶Ø¹ Ø¹Ø¯Ù… Ø§Ù„Ø§ØªØµØ§Ù„</span>` : '';
    tr.innerHTML = `<td class="p-3 border text-center">${index}</td>
      <td class="p-3 border">${offlineBadge} ${log.name || ''}</td>
      <td class="p-3 border">${log.plate || ''}</td>
      <td class="p-3 border">${log.entryTime || ''}</td>
      <td class="p-3 border">${log.entryGate || ''}</td>
      <td class="p-3 border">${log.exitTime ? log.exitTime : '-'}</td>
      <td class="p-3 border">${log.notes || ''}</td>
      <td class="p-3 border text-center space-x-1">
        ${ (isAdmin && !log.exitTime) ? `<button onclick="registerExit('${log.key}')" class="bg-green-500 text-white px-3 py-1 rounded-lg text-xs">ğŸš¦ Ø®Ø±ÙˆØ¬</button>` : '' }
        ${ isAdmin ? `<button onclick="deleteLog('${log.key}')" class="bg-red-500 text-white px-3 py-1 rounded-lg text-xs">ğŸ—‘ï¸ Ø­Ø°Ù</button>` : '' }
      </td>`;
    tbody.appendChild(tr);
  });
}

document.getElementById('dateFilter').addEventListener('change', renderLogs);
document.getElementById('searchInput').addEventListener('input', renderLogs);

/* ============================
   Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
   ============================ */
logForm.addEventListener('submit', function(e){
  e.preventDefault();
  if(!isAdmin) return;
  const errorBox = document.getElementById('errorBox');
  errorBox.classList.add('hidden'); errorBox.textContent = '';
  const name = nameInput.value.trim();
  const plate = plateInput.value.trim();
  const entryGate = entryGateInput.value.trim();
  const notes = notesInput.value.trim();
  const existing = logs.find(l => l.plate === plate && !l.exitTime);
  if(existing){ errorBox.textContent = `ğŸš« Ø§Ù„Ø³ÙŠØ§Ø±Ø© ${plate} Ù…Ø³Ø¬Ù„Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙˆÙ„Ù… ØªÙØ³Ø¬Ù„ Ø®Ø±ÙˆØ¬.`; errorBox.classList.remove('hidden'); return; }
  const entryTime = formatTime(new Date());
  const date = formatDateArabic(new Date());
  const logData = { name, plate, entryGate, notes, entryTime, exitTime: null, date };
  if(navigator.onLine){
    db.ref('carLogs').push(logData).then(() => { showToast('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.'); }).catch(err => { console.error('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„:',err); saveOfflineLog(logData); });
  } else { saveOfflineLog(logData); }
  logForm.reset();
  suggestionsBox.classList.add('hidden');
});

/* ============================
   ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù„Ù„Ø³Ø¬Ù„Ø§Øª
   ============================ */
function registerExit(key){
  if(!isAdmin) return;
  if(key && key.startsWith && key.startsWith('offline')){
    const idx = logs.findIndex(l => l.key === key);
    if(idx !== -1){
      logs[idx].exitTime = formatTime(new Date());
      let offlineLogs = JSON.parse(localStorage.getItem('offlineLogs') || '[]');
      const oi = offlineLogs.findIndex(o => o.plate === logs[idx].plate && !o.exitTime && o.entryTime === logs[idx].entryTime && o.date === logs[idx].date);
      if(oi !== -1){ offlineLogs[oi].exitTime = logs[idx].exitTime; localStorage.setItem('offlineLogs', JSON.stringify(offlineLogs)); }
      renderLogs(); showToast('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ø­Ù„ÙŠÙ‹Ø§ (ÙˆØ¶Ø¹ Ø¹Ø¯Ù… Ø§Ù„Ø§ØªØµØ§Ù„).');
    }
  } else { db.ref('carLogs/' + key + '/exitTime').set(formatTime(new Date())); }
}

/* ============================
   Ø­Ø°Ù Ø³Ø¬Ù„
   ============================ */
function deleteLog(key){
  if(!isAdmin) return;
  if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ØŸ')) return;
  if(key && key.startsWith && key.startsWith('offline')){
    const idx = logs.findIndex(l => l.key === key);
    if(idx !== -1){
      const plate = logs[idx].plate; const entryTime = logs[idx].entryTime; const date = logs[idx].date;
      logs.splice(idx,1);
      let offlineLogs = JSON.parse(localStorage.getItem('offlineLogs') || '[]');
      offlineLogs = offlineLogs.filter(o => !(o.plate === plate && o.entryTime === entryTime && o.date === date));
      localStorage.setItem('offlineLogs', JSON.stringify(offlineLogs));
      renderLogs(); showToast('ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø­Ù„ÙŠ.');
    }
  } else { db.ref('carLogs/' + key).remove(); }
}

/* ============================
   Ø¥Ø¹Ø¯Ø§Ø¯ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø£Ø¯Ù…Ù†
   ============================ */
function openAdminModal(){ document.getElementById('adminModal').classList.remove('hidden'); }
function closeAdminModal(){ document.getElementById('adminModal').classList.add('hidden'); document.getElementById('adminUser').value=''; document.getElementById('adminPass').value=''; document.getElementById('adminError').classList.add('hidden'); }

function checkAdminLogin(){
  const user = document.getElementById('adminUser').value.trim();
  const pass = document.getElementById('adminPass').value.trim();
  const remember = document.getElementById('rememberMe').checked;
  const adminError = document.getElementById('adminError');
  if(user === 'admin' && pass === '1234'){
    isAdmin = true;
    document.getElementById('logForm').classList.remove('hidden');
    document.getElementById('logoutBtn').classList.remove('hidden');
    if(remember) localStorage.setItem('isAdmin','true');
    closeAdminModal();
    loadLogs();
    renderLogs();
  } else {
    adminError.textContent = 'âŒ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©';
    adminError.classList.remove('hidden');
  }
}

document.getElementById('logoutBtn').addEventListener('click', () => {
  isAdmin = false;
  localStorage.removeItem('isAdmin');
  document.getElementById('logForm').classList.add('hidden');
  document.getElementById('logoutBtn').classList.add('hidden');
  showToast('ğŸ”’ ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬');
});

if(localStorage.getItem('isAdmin') === 'true'){
  isAdmin = true;
  document.getElementById('logForm').classList.remove('hidden');
  document.getElementById('logoutBtn').classList.remove('hidden');
  loadLogs();
}

/* Ø®Ø±ÙˆØ¬ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ Ù…Ù†ØªØµÙ Ø§Ù„Ù„ÙŠÙ„ */
setInterval(()=>{
  const now = new Date();
  if(now.getHours() === 0 && now.getMinutes() === 0){
    logs.forEach(log => {
      if(!log.exitTime){
        if(log.key && log.key.startsWith && log.key.startsWith('offline')){
          const idx = logs.findIndex(l => l.key === log.key);
          if(idx !== -1){
            logs[idx].exitTime = '12:00 Øµ';
            let offlineLogs = JSON.parse(localStorage.getItem('offlineLogs') || '[]');
            const oi = offlineLogs.findIndex(o => o.plate === logs[idx].plate && !o.exitTime && o.entryTime === logs[idx].entryTime);
            if(oi !== -1){ offlineLogs[oi].exitTime = '12:00 Øµ'; localStorage.setItem('offlineLogs', JSON.stringify(offlineLogs)); }
          }
        } else { db.ref('carLogs/' + log.key + '/exitTime').set('12:00 Øµ'); }
      }
    });
    renderLogs();
  }
}, 60000);

loadLogs();

</script>
</body>
</html>
