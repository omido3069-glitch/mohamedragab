<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ø¹Ù…Ø§Ù„Ø© Ø§Ù„Ø´Ø±ÙƒØ§Øª</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  body { font-family: 'Tajawal', sans-serif; background: #f8f9fa; }
  h2 { text-align: center; color: #0d6efd; margin: 20px 0; }
  .table { background: white; }
  input, select { border-radius: 10px; padding: 10px; font-weight: bold; font-size: 1.05rem; }
  #search { width:100%; padding:12px; font-size:1.1rem; margin-bottom:10px; border-radius:12px; border:2px solid #0d6efd; }
  .adminOnly { display:none; }
  img.card-img { width:60px; height:60px; object-fit:cover; cursor:pointer; border-radius:8px; }
  #logoutBtn { display:none; }
</style>
</head>
<body>
<div class="container mt-4">

  <!-- ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
  <div id="loginSection" class="mb-4">
    <h2>ğŸ” Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£Ø¯Ù…Ù†</h2>
    <input type="text" id="username" class="form-control mb-2" placeholder="Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„">
    <input type="password" id="password" class="form-control mb-2" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±">
    <button id="loginBtn" class="btn btn-primary w-100 mb-3">Ø¯Ø®ÙˆÙ„</button>
  </div>

  <!-- Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ -->
  <button id="logoutBtn" class="btn btn-warning w-100 mb-3">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>

  <!-- Ø¥Ø¶Ø§ÙØ© Ø¹Ø§Ù…Ù„ Ø¬Ø¯ÙŠØ¯ -->
  <div id="addWorkerSection" class="adminOnly mb-4 card p-3 shadow">
    <h4 class="text-center text-success">â• Ø¥Ø¶Ø§ÙØ© Ø¹Ø§Ù…Ù„ Ø¬Ø¯ÙŠØ¯</h4>
    <input id="name" class="form-control mb-2" placeholder="Ø§Ù„Ø§Ø³Ù…">
    <select id="company" class="form-select mb-2">
      <option value="">Ø§Ø®ØªØ± Ø¬Ù‡Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„</option>
      <option>Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠÙ‡</option><option>Ø³Ø§Ø´ÙŠÙƒÙˆ</option><option>Ø§ÙŠÙ…Ø§Ùƒ</option><option>Ø§ÙŠÙ…ÙƒÙˆ</option>
      <option>Ø§Ø¨Ùˆ Ø´Ù„ÙˆØ¹</option><option>ÙƒÙˆÙ„ÙŠØªÙŠ</option><option>ØªÙ„ÙŠÙƒÙˆÙ…</option><option>Ø§Ù„ÙˆØ§Ø¯ÙŠ</option>
      <option>Ø§Ù„Ø­Ù†Ø§ÙˆÙŠ</option><option>ÙØ±Ù†Ø¯Ø³</option><option>ÙƒÙŠØ±</option><option>Ø´Ø±ÙƒÙ‡ ØªØ§ÙˆÙ† Ø¬Ø§Ø²</option>
      <option>ØµÙŠØ§Ù†Ù‡ ÙƒØ§ÙØªØ±ÙŠØ§</option>
    </select>
    <input id="phone" class="form-control mb-2" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
    <input id="job" class="form-control mb-2" placeholder="Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„">
    <input id="nid" class="form-control mb-2" placeholder="Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ">
    <label class="form-label">ğŸ“· ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</label>
    <input id="idImage" type="file" class="form-control mb-2" accept="image/*">
    <button onclick="addWorker()" class="btn btn-success w-100">Ø¥Ø¶Ø§ÙØ©</button>
  </div>

  <!-- Ø§Ù„Ø¨Ø­Ø« + Ø§Ù„ÙÙ„ØªØ± -->
  <div class="row mb-3">
    <div class="col-md-8">
      <input type="text" id="search" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠØŒ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙØŒ Ø¬Ù‡Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ØŒ Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„">
    </div>
    <div class="col-md-4">
      <select id="companyFilter" class="form-select">
        <option value="">â¬‡ï¸ ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø¬Ù‡Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„</option>
        <option value="">Ø§Ù„ÙƒÙ„</option>
        <option>Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠÙ‡</option><option>Ø³Ø§Ø´ÙŠÙƒÙˆ</option><option>Ø§ÙŠÙ…Ø§Ùƒ</option><option>Ø§ÙŠÙ…ÙƒÙˆ</option>
        <option>Ø§Ø¨Ùˆ Ø´Ù„ÙˆØ¹</option><option>ÙƒÙˆÙ„ÙŠØªÙŠ</option><option>ØªÙ„ÙŠÙƒÙˆÙ…</option><option>Ø§Ù„ÙˆØ§Ø¯ÙŠ</option>
        <option>Ø§Ù„Ø­Ù†Ø§ÙˆÙŠ</option><option>ÙØ±Ù†Ø¯Ø³</option><option>ÙƒÙŠØ±</option><option>Ø´Ø±ÙƒÙ‡ ØªØ§ÙˆÙ† Ø¬Ø§Ø²</option>
        <option>ØµÙŠØ§Ù†Ù‡ ÙƒØ§ÙØªØ±ÙŠØ§</option>
      </select>
    </div>
  </div>

  <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ù…Ø§Ù„Ø© -->
  <div class="table-responsive">
    <table class="table table-bordered text-center table-hover" id="workersTable">
      <thead class="table-primary">
        <tr>
          <th>Ø§Ù„Ø§Ø³Ù…</th>
          <th>Ø¬Ù‡Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„</th>
          <th>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</th>
          <th>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„</th>
          <th>ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</th>
          <th class="adminOnly">Ø­Ø°Ù</th>
          <th>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ</th>
        </tr>
      </thead>
      <tbody><!-- ÙŠØªÙ… Ù…Ù„Ø¤Ù‡ Ù…Ù† Firestore --></tbody>
    </table>
  </div>
</div>

<!-- Popup Ù„Ø¹Ø±Ø¶ ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© -->
<div class="modal fade" id="imageModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body text-center">
        <img id="modalImage" src="" class="img-fluid rounded shadow">
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- Firebase + Firestore + ImgBB -->
<script type="module">
  // ===== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ø© =====
  const ADMIN_USER = "omido3069@gmail.com";
  const ADMIN_PASS = "12345600";
  let isAdmin = false;

  // Ù…ÙØªØ§Ø­ ImgBB (Ù„Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±)
  const IMGBB_API_KEY = "50278cd2ec1f082d34009398b27e0096";

  // ===== Firebase Firestore =====
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDxZnTzssVZWtGR5iD6feE5d3BUFX3T5E0",
    authDomain: "companies-4bcc8.firebaseapp.com",
    projectId: "companies-4bcc8",
    storageBucket: "companies-4bcc8.appspot.com",
    messagingSenderId: "688630422572",
    appId: "1:688630422572:web:580391a664b0193383c589",
    measurementId: "G-KPHEF2BY6M"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const workersCol = collection(db, "workers");

  // ===== ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø£Ø¯Ù…Ù† =====
  document.getElementById("loginBtn").addEventListener("click", () => {
    const user = document.getElementById("username").value.trim();
    const pass = document.getElementById("password").value.trim();
    if (user===ADMIN_USER && pass===ADMIN_PASS) {
      isAdmin = true;
      alert("âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒØ£Ø¯Ù…Ù†");
      document.querySelectorAll(".adminOnly").forEach(el=>el.style.display="table-cell");
      document.getElementById("addWorkerSection").style.display="block";
      document.getElementById("loginSection").style.display="none";
      document.getElementById("logoutBtn").style.display="block";
    } else {
      alert("âŒ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ØºÙŠØ± ØµØ­ÙŠØ­Ø©");
    }
  });

  document.getElementById("logoutBtn").addEventListener("click", ()=>{
    isAdmin = false;
    document.querySelectorAll(".adminOnly").forEach(el=>el.style.display="none");
    document.getElementById("addWorkerSection").style.display="none";
    document.getElementById("loginSection").style.display="block";
    document.getElementById("logoutBtn").style.display="none";
    alert("ğŸšª ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬");
  });

  // ===== Ø±ÙØ¹ ØµÙˆØ±Ø© Ø¥Ù„Ù‰ ImgBB =====
  async function uploadToImgBB(file) {
    const fd = new FormData();
    fd.append("image", file);
    const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method:"POST", body: fd });
    const data = await res.json();
    if (data?.success) return data.data.url;
    throw new Error("ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©");
  }

  // ===== Ø¥Ø¶Ø§ÙØ© Ø¹Ø§Ù…Ù„ Ø¬Ø¯ÙŠØ¯ (Firestore + ImgBB) =====
  window.addWorker = async function () {
    const name = document.getElementById("name").value.trim();
    const company = document.getElementById("company").value.trim();
    const phone = document.getElementById("phone").value.trim();
    const job = document.getElementById("job").value.trim();
    const nid = document.getElementById("nid").value.trim();
    const file = document.getElementById("idImage").files[0];

    if (!name || !company || !phone || !job || !nid) {
      alert("âŒ ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„");
      return;
    }

    try {
      let imgUrl = "";
      if (file) imgUrl = await uploadToImgBB(file);

      await addDoc(workersCol, {
        name, company, phone, job, nid,
        image: imgUrl,
        createdAt: Date.now()
      });

      alert("âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ø§Ù…Ù„ Ø¨Ù†Ø¬Ø§Ø­");
      await loadWorkers();
      // ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„
      ["name","company","phone","job","nid","idImage"].forEach(id=>{
        const el = document.getElementById(id);
        if (el.type==="file") el.value = "";
        else el.value = "";
      });
    } catch (e) {
      console.error(e);
      alert("âš ï¸ Ø­ØµÙ„ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø¶Ø§ÙØ©");
    }
  };

  // ===== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù…Ø§Ù„ Ù…Ù† Firestore =====
  async function loadWorkers() {
    const tbody = document.querySelector("#workersTable tbody");
    tbody.innerHTML = "";
    const q = query(workersCol, orderBy("createdAt", "desc"));
    const snap = await getDocs(q);
    snap.forEach(docSnap => {
      const w = docSnap.data();
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${w.name || ""}</td>
        <td>${w.company || ""}</td>
        <td>${w.phone || ""}</td>
        <td>${w.job || ""}</td>
        <td><img src="${w.image || 'https://via.placeholder.com/120x80?text=No+Image'}" class="card-img" onclick="showImage('${w.image || ''}')"></td>
        <td class="adminOnly">
          <button class="btn btn-danger btn-sm" onclick="deleteWorker('${docSnap.id}')">Ø­Ø°Ù</button>
        </td>
        <td>${w.nid || ""}</td>
      `;
      tbody.appendChild(tr);
    });
  }
  window.onload = loadWorkers;

  // ===== Ø­Ø°Ù Ø¹Ø§Ù…Ù„ =====
  window.deleteWorker = async function(id) {
    if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ")) return;
    try {
      await deleteDoc(doc(db, "workers", id));
      alert("ğŸ—‘ï¸ ØªÙ… Ø§Ù„Ø­Ø°Ù");
      await loadWorkers();
    } catch (e) {
      console.error(e);
      alert("âš ï¸ Ø­ØµÙ„ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù");
    }
  };

  // ===== Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ÙÙ„ØªØ±Ø© (Ù…Ø­Ù„ÙŠÙ‹Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶) =====
  document.getElementById("search").addEventListener("input", filterTable);
  document.getElementById("companyFilter").addEventListener("change", filterTable);
  function filterTable(){
    const searchVal = document.getElementById("search").value.toLowerCase();
    const companyVal = document.getElementById("companyFilter").value;
    document.querySelectorAll("#workersTable tbody tr").forEach(tr=>{
      const text = tr.innerText.toLowerCase();
      const company = tr.children[1].innerText;
      let show = true;
      if(searchVal && !text.includes(searchVal)) show = false;
      if(companyVal && company !== companyVal) show = false;
      tr.style.display = show ? "" : "none";
    });
  }

  // ===== Ø¹Ø±Ø¶ ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ÙÙŠ Popup =====
  window.showImage = function(src){
    if(!src) return;
    document.getElementById("modalImage").src = src;
    new bootstrap.Modal(document.getElementById('imageModal')).show();
  };
</script>
</body>
</html>
