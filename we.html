<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>ุฅุฏุงุฑุฉ ุนูุงูุฉ ุงูุดุฑูุงุช</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body {
  font-family: 'Tajawal', sans-serif;
  background: linear-gradient(135deg, #e3f2fd, #bbdefb, #90caf9); /* ุฎูููุฉ ุซุงุจุชุฉ */
  background-attachment: fixed;
  min-height: 100vh;
}
h2 { text-align: center; color: #0d6efd; margin: 20px 0; }
.card { border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
input, select { border-radius: 10px; padding: 10px; font-weight: bold; font-size: 1rem; }
#search { width:100%; padding:12px; font-size:1rem; margin-bottom:10px; border-radius:12px; border:2px solid #0d6efd; }
.adminOnly { display:none; }
#logoutBtn { display:none; }
</style>
</head>
<body>
<div class="container py-4">

  <!-- ุชุณุฌูู ุงูุฏุฎูู -->
  <div id="loginSection" class="mb-4">
    <h2>๐ ุฏุฎูู ุงูุฃุฏูู</h2>
    <input type="text" id="username" class="form-control mb-2" placeholder="ุงูุฅูููู">
    <input type="password" id="password" class="form-control mb-2" placeholder="ูููุฉ ุงูุณุฑ">
    <button id="loginBtn" class="btn btn-primary w-100 mb-3">ุฏุฎูู</button>
  </div>

  <!-- ุฒุฑ ุชุณุฌูู ุงูุฎุฑูุฌ -->
  <button id="logoutBtn" class="btn btn-warning w-100 mb-3">๐ช ุชุณุฌูู ุงูุฎุฑูุฌ</button>

  <!-- ุฅุถุงูุฉ ุนุงูู ุฌุฏูุฏ -->
  <div id="addWorkerSection" class="adminOnly mb-4 card p-3 shadow">
    <h4 class="text-center text-success">โ ุฅุถุงูุฉ ุนุงูู ุฌุฏูุฏ</h4>
    <input id="name" class="form-control mb-2" placeholder="ุงูุงุณู">

    <select id="company" class="form-select mb-2">
      <option value="">ุงุฎุชุฑ ุฌูุฉ ุงูุฏุฎูู</option>
      <option>ุงูุนุงูููู</option>
      <option>ุณุงุดููู</option>
      <option>ุงููุงู</option>
      <option>ุงูููู</option>
      <option>ุงุจู ุดููุน</option>
      <option>ููููุชู</option>
      <option>ุชููููู</option>
      <option>ุงููุงุฏู</option>
      <option>ุงูุญูุงูู</option>
      <option>ูุฑูุฏุณ</option>
      <option>ููุฑ</option>
      <option>ุดุฑูู ุชุงูู ุฌุงุฒ</option>
      <option>ุตูุงูู ูุงูุชุฑูุง</option>
    </select>

    <input id="phone" class="form-control mb-2" placeholder="ุฑูู ุงููุงุชู">
    <input id="job" class="form-control mb-2" placeholder="ููุน ุงูุนูู">
    <input id="nid" class="form-control mb-2" placeholder="ุงูุฑูู ุงููููู">

    <label class="form-label">๐ท ุตูุฑุฉ ุงูุจุทุงูุฉ</label>
    <input id="idImage" type="file" class="form-control mb-2" accept="image/*">

    <button onclick="addWorker()" class="btn btn-success w-100">ุฅุถุงูุฉ</button>
  </div>

  <!-- ุงูุจุญุซ + ุงูููุชุฑ -->
  <div class="row mb-3">
    <div class="col-md-8">
      <input type="text" id="search" placeholder="๐ ุงุจุญุซ ุจุงูุงุณูุ ุงูุฑูู ุงูููููุ ุฑูู ุงููุงุชูุ ุฌูุฉ ุงูุฏุฎููุ ููุน ุงูุนูู">
    </div>
    <div class="col-md-4">
      <select id="companyFilter" class="form-select">
        <option value="">โฌ๏ธ ุชุตููุฉ ุญุณุจ ุฌูุฉ ุงูุฏุฎูู</option>
        <option value="">ุงููู</option>
        <option>ุงูุนุงูููู</option>
        <option>ุณุงุดููู</option>
        <option>ุงููุงู</option>
        <option>ุงูููู</option>
        <option>ุงุจู ุดููุน</option>
        <option>ููููุชู</option>
        <option>ุชููููู</option>
        <option>ุงููุงุฏู</option>
        <option>ุงูุญูุงูู</option>
        <option>ูุฑูุฏุณ</option>
        <option>ููุฑ</option>
        <option>ุดุฑูู ุชุงูู ุฌุงุฒ</option>
        <option>ุตูุงูู ูุงูุชุฑูุง</option>
      </select>
    </div>
  </div>

  <!-- ุดุจูุฉ ุงูุนูุงู -->
  <div id="workersGrid" class="row g-3"></div>

</div>

<!-- Popup ูุนุฑุถ ุตูุฑุฉ ุงูุจุทุงูุฉ -->
<div class="modal fade" id="imageModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body text-center">
        <img id="modalImage" src="" class="img-fluid rounded shadow">
      </div>
    </div>
  </div>
</div>

<!-- Modal ุงูุชุนุฏูู -->
<div class="modal fade" id="editModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">โ๏ธ ุชุนุฏูู ุจูุงูุงุช ุงูุนุงูู</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input id="editName" class="form-control mb-2" placeholder="ุงูุงุณู">
        <select id="editCompany" class="form-select mb-2">
          <option>ุงูุนุงูููู</option><option>ุณุงุดููู</option><option>ุงููุงู</option>
          <option>ุงูููู</option><option>ุงุจู ุดููุน</option><option>ููููุชู</option>
          <option>ุชููููู</option><option>ุงููุงุฏู</option><option>ุงูุญูุงูู</option>
          <option>ูุฑูุฏุณ</option><option>ููุฑ</option><option>ุดุฑูู ุชุงูู ุฌุงุฒ</option>
          <option>ุตูุงูู ูุงูุชุฑูุง</option>
        </select>
        <input id="editPhone" class="form-control mb-2" placeholder="ุฑูู ุงููุงุชู">
        <input id="editJob" class="form-control mb-2" placeholder="ููุน ุงูุนูู">
        <input id="editNid" class="form-control mb-2" placeholder="ุงูุฑูู ุงููููู">
        <label class="form-label">๐ท ุตูุฑุฉ ุงูุจุทุงูุฉ</label>
        <input id="editImage" type="file" class="form-control mb-2" accept="image/*">
        <img id="currentImg" src="" class="img-fluid rounded mt-2">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ุฅูุบุงุก</button>
        <button type="button" id="saveEditBtn" class="btn btn-primary">๐พ ุญูุธ ุงูุชุบููุฑุงุช</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script type="module">
/* ===== Firebase - Firestore (CDN) ===== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, updateDoc, doc, getDoc } from "https://www.gstatic.com/firebasejs/12.2.0/firebase-firestore.js";

/* ===== Firebase Config - ุฒู ูุง ุจุนุฏุชูุงูู ===== */
const firebaseConfig = {
  apiKey: "AIzaSyDxZnTzssVZWtGR5iD6feE5d3BUFX3T5E0",
  authDomain: "companies-4bcc8.firebaseapp.com",
  projectId: "companies-4bcc8",
  storageBucket: "companies-4bcc8.firebasestorage.app",
  messagingSenderId: "688630422572",
  appId: "1:688630422572:web:580391a664b0193383c589",
  measurementId: "G-KPHEF2BY6M"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ===== ImgBB API Key ===== */
const imgbbAPI = "50278cd2ec1f082d34009398b27e0096";

/* ===== ุงูุฃุฏูู - ุฒู ูุง ูู ===== */
const ADMIN_USER = "omido3069@gmail.com";
const ADMIN_PASS = "12345600";
let isAdmin = false;
let currentEditId = null;

/* ===== ุชุณุฌูู ุงูุฏุฎูู ===== */
document.getElementById("loginBtn").addEventListener("click", ()=>{
  const user = document.getElementById("username").value;
  const pass = document.getElementById("password").value;
  if(user===ADMIN_USER && pass===ADMIN_PASS){
    isAdmin = true;
    document.querySelectorAll(".adminOnly").forEach(el=>el.style.display="inline-block");
    document.getElementById("addWorkerSection").style.display="block";
    document.getElementById("loginSection").style.display="none";
    document.getElementById("logoutBtn").style.display="block";
    alert("โ ุชู ุชุณุฌูู ุงูุฏุฎูู ูุฃุฏูู");
  } else {
    alert("โ ุงุณู ุงููุณุชุฎุฏู ุฃู ูููุฉ ุงูุณุฑ ุบูุฑ ุตุญูุญุฉ");
  }
});

/* ===== ุชุณุฌูู ุงูุฎุฑูุฌ ===== */
document.getElementById("logoutBtn").addEventListener("click", ()=>{
  isAdmin = false;
  document.querySelectorAll(".adminOnly").forEach(el=>el.style.display="none");
  document.getElementById("addWorkerSection").style.display="none";
  document.getElementById("loginSection").style.display="block";
  document.getElementById("logoutBtn").style.display="none";
  alert("๐ช ุชู ุชุณุฌูู ุงูุฎุฑูุฌ");
});

/* ===== ุฑูุน ุตูุฑุฉ ุฅูู ImgBB ===== */
async function uploadToImgBB(file){
  const formData = new FormData();
  formData.append("image", file);
  const res = await fetch(`https://api.imgbb.com/1/upload?key=${imgbbAPI}`, {
    method: "POST",
    body: formData
  });
  const data = await res.json();
  if(!res.ok || !data.success){
    console.error("ImgBB Error:", data);
    throw new Error("ูุดู ุฑูุน ุงูุตูุฑุฉ");
  }
  // ุฑุงุจุท ูุจุงุดุฑ ููุตูุฑุฉ
  return data.data.url;
}

/* ===== ุชุญููู ุงูุนูุงู ูู Firestore ===== */
async function loadWorkers(){
  const workersGrid = document.getElementById("workersGrid");
  workersGrid.innerHTML = "";
  const querySnapshot = await getDocs(collection(db, "workers"));
  querySnapshot.forEach((docSnap)=>{
    renderWorker(docSnap.id, docSnap.data());
  });
}
loadWorkers();

/* ===== ุฑุณู ุงููุงุฑุช ===== */
function renderWorker(id, worker){
  const grid = document.getElementById("workersGrid");
  const div = document.createElement("div");
  div.className = "col-md-4 worker-card";
  div.innerHTML = `
    <div class="card p-3 text-center">
      <h5>${worker.name}</h5>
      <p class="mb-1">๐ ${worker.company}</p>
      <p class="mb-1">๐ ${worker.phone}</p>
      <p class="mb-1">๐ ${worker.job}</p>
      <p class="mb-1">๐ ${worker.nid}</p>
      <img src="${worker.imgSrc || 'https://via.placeholder.com/150'}" class="img-fluid rounded mb-2" style="max-height:150px;object-fit:cover;">
      <button class="btn btn-info btn-sm mb-1" onclick="showImage('${worker.imgSrc || 'https://via.placeholder.com/150'}')">๐ ุนุฑุถ ุงูุจุทุงูุฉ ุจุญุฌู ูุจูุฑ</button>
      <button class="btn btn-warning btn-sm adminOnly" onclick="editWorker('${id}')">โ๏ธ ุชุนุฏูู</button>
      <button class="btn btn-danger btn-sm adminOnly" onclick="deleteWorker('${id}', this)">๐ ุญุฐู</button>
    </div>
  `;
  grid.appendChild(div);
  if(isAdmin){
    div.querySelectorAll(".adminOnly").forEach(el=>el.style.display="inline-block");
  }
}

/* ===== ุฅุถุงูุฉ ุนุงูู (ImgBB + Firestore) ===== */
window.addWorker = async function(){
  const name = document.getElementById("name").value.trim();
  const company = document.getElementById("company").value.trim();
  const phone = document.getElementById("phone").value.trim();
  const job = document.getElementById("job").value.trim();
  const nid = document.getElementById("nid").value.trim();
  const fileInput = document.getElementById("idImage");

  if(!name || !company || !phone || !job || !nid){
    alert("โ๏ธ ูู ูุถูู ุงููุฃ ูู ุงูุญููู");
    return;
  }

  let imgSrc = "https://via.placeholder.com/150";

  try{
    if(fileInput.files && fileInput.files[0]){
      imgSrc = await uploadToImgBB(fileInput.files[0]);
    }

    const docRef = await addDoc(collection(db, "workers"), { name, company, phone, job, nid, imgSrc });
    alert("โ ุชู ุฅุถุงูุฉ ุงูุนุงูู");
    // ูุถู ุงูุญููู
    document.getElementById("name").value = "";
    document.getElementById("company").value = "";
    document.getElementById("phone").value = "";
    document.getElementById("job").value = "";
    document.getElementById("nid").value = "";
    document.getElementById("idImage").value = "";
    // ุฃุนุฏ ุงูุชุญููู ูู ุงูุณุญุงุจุฉ ูุถูุงู ุงูุชุฒุงูู
    loadWorkers();
  }catch(err){
    console.error(err);
    alert("โ ุญุตู ุฎุทุฃ ุฃุซูุงุก ุงูุฅุถุงูุฉ");
  }
}

/* ===== ุญุฐู ุนุงูู ===== */
window.deleteWorker = async function(id, btn){
  if(!confirm("ูู ุชุฑูุฏ ุญุฐู ูุฐุง ุงูุนุงููุ")) return;
  await deleteDoc(doc(db, "workers", id));
  btn.closest(".worker-card").remove();
}

/* ===== ูุชุญ ููุฏุงู ุงูุชุนุฏูู ===== */
window.editWorker = async function(id){
  currentEditId = id;
  const docSnap = await getDoc(doc(db,"workers",id));
  if(docSnap.exists()){
    const w = docSnap.data();
    document.getElementById("editName").value = w.name || "";
    document.getElementById("editCompany").value = w.company || "";
    document.getElementById("editPhone").value = w.phone || "";
    document.getElementById("editJob").value = w.job || "";
    document.getElementById("editNid").value = w.nid || "";
    document.getElementById("currentImg").src = w.imgSrc || "https://via.placeholder.com/150";
  }
  const modal = new bootstrap.Modal(document.getElementById('editModal'));
  modal.show();
}

/* ===== ุญูุธ ุงูุชุนุฏููุงุช (ImgBB ูู ุงูุตูุฑุฉ ุงุชุบูุฑุช) ===== */
document.getElementById("saveEditBtn").addEventListener("click", async ()=>{
  if(!currentEditId) return;

  const name = document.getElementById("editName").value.trim();
  const company = document.getElementById("editCompany").value.trim();
  const phone = document.getElementById("editPhone").value.trim();
  const job = document.getElementById("editJob").value.trim();
  const nid = document.getElementById("editNid").value.trim();
  let imgSrc = document.getElementById("currentImg").src;

  const fileInput = document.getElementById("editImage");

  try{
    if(fileInput.files && fileInput.files[0]){
      imgSrc = await uploadToImgBB(fileInput.files[0]);
    }

    await updateDoc(doc(db,"workers",currentEditId), { name, company, phone, job, nid, imgSrc });
    alert("โ ุชู ุญูุธ ุงูุชุนุฏููุงุช");
    currentEditId = null;
    bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
    loadWorkers();
  }catch(err){
    console.error(err);
    alert("โ ุญุตู ุฎุทุฃ ุฃุซูุงุก ุงูุญูุธ");
  }
});

/* ===== ุนุฑุถ ุงูุตูุฑุฉ ูู ููุฏุงู ===== */
window.showImage = function(src){
  document.getElementById("modalImage").src = src;
  const modal = new bootstrap.Modal(document.getElementById('imageModal'));
  modal.show();
}

/* ===== ุงูุจุญุซ + ุงูุชุตููุฉ (ุฒู ูุง ูู) ===== */
document.getElementById("search").addEventListener("input", filterWorkers);
document.getElementById("companyFilter").addEventListener("change", filterWorkers);

function filterWorkers(){
  const searchVal = document.getElementById("search").value.toLowerCase();
  const companyVal = document.getElementById("companyFilter").value;

  document.querySelectorAll("#workersGrid .worker-card").forEach(card=>{
    const text = card.innerText.toLowerCase();
    const company = card.querySelector(".mb-1").innerText.replace("๐","").trim();
    let show = true;

    if(searchVal && !text.includes(searchVal)) show = false;
    if(companyVal && company !== companyVal) show = false;

    card.style.display = show ? "" : "none";
  });
}
</script>
</body>
</html>

