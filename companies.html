<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ø¥Ø¯Ø§Ø±Ø© Ø¹Ù…Ø§Ù„Ø© Ø§Ù„Ø´Ø±ÙƒØ§Øª</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
<style>
body {
  font-family: 'Tajawal', sans-serif;
  background: linear-gradient(135deg, #e3f2fd, #bbdefb, #90caf9);
  background-attachment: fixed;
  min-height: 100vh;
}
h2 { text-align: center; color: #0d6efd; margin: 20px 0; }
.card { border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
input, select { border-radius: 10px; padding: 10px; font-weight: bold; font-size: 1rem; }
#search { width:100%; padding:12px; font-size:1rem; margin-bottom:10px; border-radius:12px; border:2px solid #0d6efd; }
.adminOnly { display:none; }
#logoutBtn { display:none; }
</style>
</head>
<body>
<div class="container py-4">

  <!-- ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
  <div id="loginSection" class="mb-4">
    <h2>ğŸ” Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£Ø¯Ù…Ù†</h2>
    <input type="text" id="username" class="form-control mb-2" placeholder="Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„">
    <input type="password" id="password" class="form-control mb-2" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±">
    <button id="loginBtn" class="btn btn-primary w-100 mb-3">Ø¯Ø®ÙˆÙ„</button>
  </div>

  <!-- Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ -->
  <button id="logoutBtn" class="btn btn-warning w-100 mb-3">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>

  <!-- Ø¥Ø¶Ø§ÙØ© Ø¹Ø§Ù…Ù„ Ø¬Ø¯ÙŠØ¯ -->
  <div id="addWorkerSection" class="adminOnly mb-4 card p-3 shadow">
    <h4 class="text-center text-success">â• Ø¥Ø¶Ø§ÙØ© Ø¹Ø§Ù…Ù„ Ø¬Ø¯ÙŠØ¯</h4>
    <input id="name" class="form-control mb-2" placeholder="Ø§Ù„Ø§Ø³Ù…">

    <select id="company" class="form-select mb-2">
      <option value="">Ø§Ø®ØªØ± Ø¬Ù‡Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„</option>
      <option>Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠÙ‡</option>
      <option>Ø³Ø§Ø´ÙŠÙƒÙˆ</option>
      <option>Ø§ÙŠÙ…Ø§Ùƒ</option>
      <option>Ø§ÙŠÙ…ÙƒÙˆ</option>
      <option>Ø§Ø¨Ùˆ Ø´Ù„ÙˆØ¹</option>
      <option>ÙƒÙˆÙ„ÙŠØªÙŠ</option>
      <option>ØªÙ„ÙŠÙƒÙˆÙ…</option>
      <option>Ø§Ù„ÙˆØ§Ø¯ÙŠ</option>
      <option>Ø§Ù„Ø­Ù†Ø§ÙˆÙŠ</option>
      <option>ÙØ±Ù†Ø¯Ø³</option>
      <option>ÙƒÙŠØ±</option>
      <option>Ø´Ø±ÙƒÙ‡ ØªØ§ÙˆÙ† Ø¬Ø§Ø²</option>
      <option>ØµÙŠØ§Ù†Ù‡ ÙƒØ§ÙØªØ±ÙŠØ§</option>
    </select>

    <input id="phone" class="form-control mb-2" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
    <input id="job" class="form-control mb-2" placeholder="Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„">
    <input id="nid" class="form-control mb-2" placeholder="Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ">

    <label class="form-label">ğŸ“· ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</label>
    <input id="idImage" type="file" class="form-control mb-2" accept="image/*">

    <button onclick="addWorker()" class="btn btn-success w-100">Ø¥Ø¶Ø§ÙØ©</button>
  </div>

  <!-- Ø§Ù„Ø¨Ø­Ø« + Ø§Ù„ÙÙ„ØªØ± -->
  <div class="row mb-3">
    <div class="col-md-8">
      <input type="text" id="search" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠØŒ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙØŒ Ø¬Ù‡Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ØŒ Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„">
    </div>
    <div class="col-md-4">
      <select id="companyFilter" class="form-select">
        <option value="">â¬‡ï¸ ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø¬Ù‡Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„</option>
        <option value="">Ø§Ù„ÙƒÙ„</option>
        <option>Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠÙ‡</option>
        <option>Ø³Ø§Ø´ÙŠÙƒÙˆ</option>
        <option>Ø§ÙŠÙ…Ø§Ùƒ</option>
        <option>Ø§ÙŠÙ…ÙƒÙˆ</option>
        <option>Ø§Ø¨Ùˆ Ø´Ù„ÙˆØ¹</option>
        <option>ÙƒÙˆÙ„ÙŠØªÙŠ</option>
        <option>ØªÙ„ÙŠÙƒÙˆÙ…</option>
        <option>Ø§Ù„ÙˆØ§Ø¯ÙŠ</option>
        <option>Ø§Ù„Ø­Ù†Ø§ÙˆÙŠ</option>
        <option>ÙØ±Ù†Ø¯Ø³</option>
        <option>ÙƒÙŠØ±</option>
        <option>Ø´Ø±ÙƒÙ‡ ØªØ§ÙˆÙ† Ø¬Ø§Ø²</option>
        <option>ØµÙŠØ§Ù†Ù‡ ÙƒØ§ÙØªØ±ÙŠØ§</option>
      </select>
    </div>
  </div>

  <!-- Ø´Ø¨ÙƒØ© Ø§Ù„Ø¹Ù…Ø§Ù„ -->
  <div id="workersGrid" class="row g-3"></div>

</div>

<!-- Popup Ù„Ø¹Ø±Ø¶ ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© -->
<div class="modal fade" id="imageModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body text-center">
        <img id="modalImage" src="" class="img-fluid rounded shadow">
      </div>
    </div>
  </div>
</div>

<!-- Modal Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ -->
<div class="modal fade" id="editModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ù„</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input id="editName" class="form-control mb-2" placeholder="Ø§Ù„Ø§Ø³Ù…">
        <select id="editCompany" class="form-select mb-2">
          <option>Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠÙ‡</option><option>Ø³Ø§Ø´ÙŠÙƒÙˆ</option><option>Ø§ÙŠÙ…Ø§Ùƒ</option>
          <option>Ø§ÙŠÙ…ÙƒÙˆ</option><option>Ø§Ø¨Ùˆ Ø´Ù„ÙˆØ¹</option><option>ÙƒÙˆÙ„ÙŠØªÙŠ</option>
          <option>ØªÙ„ÙŠÙƒÙˆÙ…</option><option>Ø§Ù„ÙˆØ§Ø¯ÙŠ</option><option>Ø§Ù„Ø­Ù†Ø§ÙˆÙŠ</option>
          <option>ÙØ±Ù†Ø¯Ø³</option><option>ÙƒÙŠØ±</option><option>Ø´Ø±ÙƒÙ‡ ØªØ§ÙˆÙ† Ø¬Ø§Ø²</option>
          <option>ØµÙŠØ§Ù†Ù‡ ÙƒØ§ÙØªØ±ÙŠØ§</option>
        </select>
        <input id="editPhone" class="form-control mb-2" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
        <input id="editJob" class="form-control mb-2" placeholder="Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„">
        <input id="editNid" class="form-control mb-2" placeholder="Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙˆÙ…ÙŠ">
        <label class="form-label">ğŸ“· ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</label>
        <input id="editImage" type="file" class="form-control mb-2" accept="image/*">
        <img id="currentImg" src="" class="img-fluid rounded mt-2">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
        <button type="button" id="saveEditBtn" class="btn btn-primary">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script type="module">
/* ===== Firebase - Firestore (CDN) ===== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, updateDoc, doc, getDoc } from "https://www.gstatic.com/firebasejs/12.2.0/firebase-firestore.js";

/* ===== Firebase Config ===== */
const firebaseConfig = {
  apiKey: "AIzaSyDxZnTzssVZWtGR5iD6feE5d3BUFX3T5E0",
  authDomain: "companies-4bcc8.firebaseapp.com",
  projectId: "companies-4bcc8",
  storageBucket: "companies-4bcc8.firebasestorage.app",
  messagingSenderId: "688630422572",
  appId: "1:688630422572:web:580391a664b0193383c589",
  measurementId: "G-KPHEF2BY6M"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ===== ImgBB API Key ===== */
const imgbbAPI = "50278cd2ec1f082d34009398b27e0096";

/* ===== Ø§Ù„Ø£Ø¯Ù…Ù† ===== */
const ADMIN_USER = "omido3069@gmail.com";
const ADMIN_PASS = "12345600";
let isAdmin = false;
let currentEditId = null;

/* ===== ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ===== */
document.getElementById("loginBtn").addEventListener("click", ()=>{
  const user = document.getElementById("username").value;
  const pass = document.getElementById("password").value;
  if(user===ADMIN_USER && pass===ADMIN_PASS){
    isAdmin = true;
    document.querySelectorAll(".adminOnly").forEach(el=>el.style.display="inline-block");
    document.getElementById("addWorkerSection").style.display="block";
    document.getElementById("loginSection").style.display="none";
    document.getElementById("logoutBtn").style.display="block";
    alert("âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒØ£Ø¯Ù…Ù†");
  } else {
    alert("âŒ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ØºÙŠØ± ØµØ­ÙŠØ­Ø©");
  }
});

/* ===== ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ ===== */
document.getElementById("logoutBtn").addEventListener("click", ()=>{
  isAdmin = false;
  document.querySelectorAll(".adminOnly").forEach(el=>el.style.display="none");
  document.getElementById("addWorkerSection").style.display="none";
  document.getElementById("loginSection").style.display="block";
  document.getElementById("logoutBtn").style.display="none";
  alert("ğŸšª ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬");
});

/* ===== Ø±ÙØ¹ ØµÙˆØ±Ø© Ø¥Ù„Ù‰ ImgBB ===== */
async function uploadToImgBB(file){
  const formData = new FormData();
  formData.append("image", file);
  const res = await fetch(`https://api.imgbb.com/1/upload?key=${imgbbAPI}`, {
    method: "POST",
    body: formData
  });
  const data = await res.json();
  if(!res.ok || !data.success){
    console.error("ImgBB Error:", data);
    throw new Error("ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©");
  }
  return data.data.url;
}

/* ===== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù…Ø§Ù„ Ù…Ù† Firestore ===== */
async function loadWorkers(){
  const workersGrid = document.getElementById("workersGrid");
  workersGrid.innerHTML = "";
  const querySnapshot = await getDocs(collection(db, "workers"));
  querySnapshot.forEach((docSnap)=>{
    renderWorker(docSnap.id, docSnap.data());
  });
}
loadWorkers();

/* ===== Ø±Ø³Ù… Ø§Ù„ÙƒØ§Ø±Øª ===== */
function renderWorker(id, worker){
  const grid = document.getElementById("workersGrid");
  const div = document.createElement("div");
  div.className = "col-md-4 worker-card";
  div.innerHTML = `
    <div class="card p-3 text-center">
      <h5 class="fw-bold text-primary"><i class="bi bi-person-badge"></i> ${worker.name}</h5>
      <p class="mb-1 text-secondary"><i class="bi bi-building"></i> ${worker.company}</p>
      <p class="mb-1 text-success"><i class="bi bi-telephone"></i> ${worker.phone}</p>
      <p class="mb-1 text-warning"><i class="bi bi-briefcase"></i> ${worker.job}</p>
      <p class="mb-1 text-danger"><i class="bi bi-credit-card-2-front"></i> ${worker.nid}</p>

      <img src="${worker.imgSrc || 'https://via.placeholder.com/150'}" 
           class="img-fluid rounded mb-2 shadow-sm" 
           style="max-height:150px;object-fit:cover;">

      <button class="btn btn-info btn-sm mb-1" onclick="showImage('${worker.imgSrc || 'https://via.placeholder.com/150'}')">
        <i class="bi bi-eye"></i> Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
      </button>
      <button class="btn btn-warning btn-sm adminOnly" onclick="editWorker('${id}')">
        <i class="bi bi-pencil-square"></i> ØªØ¹Ø¯ÙŠÙ„
      </button>
      <button class="btn btn-danger btn-sm adminOnly" onclick="deleteWorker('${id}', this)">
        <i class="bi bi-trash"></i> Ø­Ø°Ù
      </button>
    </div>
  `;
  grid.appendChild(div);
  if(isAdmin){
    div.querySelectorAll(".adminOnly").forEach(el=>el.style.display="inline-block");
  }
}

/* ===== Ø¥Ø¶Ø§ÙØ© Ø¹Ø§Ù…Ù„ ===== */
window.addWorker = async function(){
  const name = document.getElementById("name").value.trim();
  const company = document.getElementById("company").value.trim();
  const phone = document.getElementById("phone").value.trim();
  const job = document.getElementById("job").value.trim();
  const nid = document.getElementById("nid").value.trim();
  const fileInput = document.getElementById("idImage");

  if(!name || !company || !phone || !job || !nid){
    alert("âš ï¸ Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ù…Ù„Ø£ ÙƒÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„");
    return;
  }

  let imgSrc = "https://via.placeholder.com/150";

  try{
    if(fileInput.files && fileInput.files[0]){
      imgSrc = await uploadToImgBB(fileInput.files[0]);
    }

    await addDoc(collection(db, "workers"), { name, company, phone, job, nid, imgSrc });
    alert("âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ø§Ù…Ù„");
    document.getElementById("name").value = "";
    document.getElementById("company").value = "";
    document.getElementById("phone").value = "";
    document.getElementById("job").value = "";
    document.getElementById("nid").value = "";
    document.getElementById("idImage").value = "";
    loadWorkers();
  }catch(err){
    console.error(err);
    alert("âŒ Ø­ØµÙ„ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø¶Ø§ÙØ©");
  }
}

/* ===== Ø­Ø°Ù Ø¹Ø§Ù…Ù„ ===== */
window.deleteWorker = async function(id, btn){
  if(!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø§Ù…Ù„ØŸ")) return;
  await deleteDoc(doc(db, "workers", id));
  btn.closest(".worker-card").remove();
}

/* ===== ÙØªØ­ Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ===== */
window.editWorker = async function(id){
  currentEditId = id;
  const docSnap = await getDoc(doc(db,"workers",id));
  if(docSnap.exists()){
    const w = docSnap.data();
    document.getElementById("editName").value = w.name || "";
    document.getElementById("editCompany").value = w.company || "";
    document.getElementById("editPhone").value = w.phone || "";
    document.getElementById("editJob").value = w.job || "";
    document.getElementById("editNid").value = w.nid || "";
    document.getElementById("currentImg").src = w.imgSrc || "https://via.placeholder.com/150";
  }
  const modal = new bootstrap.Modal(document.getElementById('editModal'));
  modal.show();
}

/* ===== Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª ===== */
document.getElementById("saveEditBtn").addEventListener("click", async ()=>{
  if(!currentEditId) return;

  const name = document.getElementById("editName").value.trim();
  const company = document.getElementById("editCompany").value.trim();
  const phone = document.getElementById("editPhone").value.trim();
  const job = document.getElementById("editJob").value.trim();
  const nid = document.getElementById("editNid").value.trim();
  let imgSrc = document.getElementById("currentImg").src;

  const fileInput = document.getElementById("editImage");

  try{
    if(fileInput.files && fileInput.files[0]){
      imgSrc = await uploadToImgBB(fileInput.files[0]);
    }

    await updateDoc(doc(db,"workers",currentEditId), { name, company, phone, job, nid, imgSrc });
    alert("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª");
    currentEditId = null;
    bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
    loadWorkers();
  }catch(err){
    console.error(err);
    alert("âŒ Ø­ØµÙ„ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸");
  }
});

/* ===== Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© ===== */
window.showImage = function(src){
  document.getElementById("modalImage").src = src;
  const modal = new bootstrap.Modal(document.getElementById('imageModal'));
  modal.show();
}

/* ===== Ø§Ù„Ø¨Ø­Ø« + Ø§Ù„ØªØµÙÙŠØ© ===== */
document.getElementById("search").addEventListener("input", filterWorkers);
document.getElementById("companyFilter").addEventListener("change", filterWorkers);

function filterWorkers(){
  const searchVal = document.getElementById("search").value.toLowerCase();
  const companyVal = document.getElementById("companyFilter").value;

  document.querySelectorAll("#workersGrid .worker-card").forEach(card=>{
    const text = card.innerText.toLowerCase();
    const company = card.querySelector(".text-secondary").innerText.replace("ğŸ“Œ","").trim();
    let show = true;

    if(searchVal && !text.includes(searchVal)) show = false;
    if(companyVal && company !== companyVal) show = false;

    card.style.display = show ? "" : "none";
  });
}
</script>
</body>
</html>
