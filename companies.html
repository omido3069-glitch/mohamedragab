<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>إدارة عمالة الشركات</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
<style>
body {
  font-family: 'Tajawal', sans-serif;
  background: linear-gradient(135deg, #e3f2fd, #bbdefb, #90caf9);
  background-attachment: fixed;
  min-height: 100vh;
}
h2 { text-align: center; color: #0d6efd; margin: 20px 0; }
.card { border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
input, select { border-radius: 10px; padding: 10px; font-weight: bold; font-size: 1rem; }
#search { width:100%; padding:12px; font-size:1rem; margin-bottom:10px; border-radius:12px; border:2px solid #0d6efd; }
.adminOnly { display:none; }
#logoutBtn { display:none; }
</style>
</head>
<body>
<div class="container py-4">

  <!-- تسجيل الدخول -->
  <div id="loginSection" class="mb-4">
    <h2>🔐 دخول الأدمن</h2>
    <input type="text" id="username" class="form-control mb-2" placeholder="الإيميل">
    <input type="password" id="password" class="form-control mb-2" placeholder="كلمة السر">
    <button id="loginBtn" class="btn btn-primary w-100 mb-3">دخول</button>
  </div>

  <!-- زر تسجيل الخروج -->
  <button id="logoutBtn" class="btn btn-warning w-100 mb-3">🚪 تسجيل الخروج</button>

  <!-- إضافة عامل جديد -->
  <div id="addWorkerSection" class="adminOnly mb-4 card p-3 shadow">
    <h4 class="text-center text-success">➕ إضافة عامل جديد</h4>
    <input id="name" class="form-control mb-2" placeholder="الاسم">

    <select id="company" class="form-select mb-2">
      <option value="">اختر جهة الدخول</option>
      <option>العالميه</option>
      <option>ساشيكو</option>
      <option>ايماك</option>
      <option>ايمكو</option>
      <option>ابو شلوع</option>
      <option>كوليتي</option>
      <option>تليكوم</option>
      <option>الوادي</option>
      <option>الحناوي</option>
      <option>فرندس</option>
      <option>كير</option>
      <option>شركه تاون جاز</option>
      <option>صيانه كافتريا</option>
    </select>

    <input id="phone" class="form-control mb-2" placeholder="رقم الهاتف">
    <input id="job" class="form-control mb-2" placeholder="نوع العمل">
    <input id="nid" class="form-control mb-2" placeholder="الرقم القومي">

    <label class="form-label">📷 صورة البطاقة</label>
    <input id="idImage" type="file" class="form-control mb-2" accept="image/*">

    <button onclick="addWorker()" class="btn btn-success w-100">إضافة</button>
  </div>

  <!-- البحث + الفلتر -->
  <div class="row mb-3">
    <div class="col-md-8">
      <input type="text" id="search" placeholder="🔍 ابحث بالاسم، الرقم القومي، رقم الهاتف، جهة الدخول، نوع العمل">
    </div>
    <div class="col-md-4">
      <select id="companyFilter" class="form-select">
        <option value="">⬇️ تصفية حسب جهة الدخول</option>
        <option value="">الكل</option>
        <option>العالميه</option>
        <option>ساشيكو</option>
        <option>ايماك</option>
        <option>ايمكو</option>
        <option>ابو شلوع</option>
        <option>كوليتي</option>
        <option>تليكوم</option>
        <option>الوادي</option>
        <option>الحناوي</option>
        <option>فرندس</option>
        <option>كير</option>
        <option>شركه تاون جاز</option>
        <option>صيانه كافتريا</option>
      </select>
    </div>
  </div>

  <!-- شبكة العمال -->
  <div id="workersGrid" class="row g-3"></div>

</div>

<!-- Popup لعرض صورة البطاقة -->
<div class="modal fade" id="imageModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body text-center">
        <img id="modalImage" src="" class="img-fluid rounded shadow">
      </div>
    </div>
  </div>
</div>

<!-- Modal التعديل -->
<div class="modal fade" id="editModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">✏️ تعديل بيانات العامل</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input id="editName" class="form-control mb-2" placeholder="الاسم">
        <select id="editCompany" class="form-select mb-2">
          <option>العالميه</option><option>ساشيكو</option><option>ايماك</option>
          <option>ايمكو</option><option>ابو شلوع</option><option>كوليتي</option>
          <option>تليكوم</option><option>الوادي</option><option>الحناوي</option>
          <option>فرندس</option><option>كير</option><option>شركه تاون جاز</option>
          <option>صيانه كافتريا</option>
        </select>
        <input id="editPhone" class="form-control mb-2" placeholder="رقم الهاتف">
        <input id="editJob" class="form-control mb-2" placeholder="نوع العمل">
        <input id="editNid" class="form-control mb-2" placeholder="الرقم القومي">
        <label class="form-label">📷 صورة البطاقة</label>
        <input id="editImage" type="file" class="form-control mb-2" accept="image/*">
        <img id="currentImg" src="" class="img-fluid rounded mt-2">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
        <button type="button" id="saveEditBtn" class="btn btn-primary">💾 حفظ التغييرات</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script type="module">
/* ===== Firebase - Firestore (CDN) ===== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, updateDoc, doc, getDoc } from "https://www.gstatic.com/firebasejs/12.2.0/firebase-firestore.js";

/* ===== Firebase Config ===== */
const firebaseConfig = {
  apiKey: "AIzaSyDxZnTzssVZWtGR5iD6feE5d3BUFX3T5E0",
  authDomain: "companies-4bcc8.firebaseapp.com",
  projectId: "companies-4bcc8",
  storageBucket: "companies-4bcc8.firebasestorage.app",
  messagingSenderId: "688630422572",
  appId: "1:688630422572:web:580391a664b0193383c589",
  measurementId: "G-KPHEF2BY6M"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ===== ImgBB API Key ===== */
const imgbbAPI = "50278cd2ec1f082d34009398b27e0096";

/* ===== الأدمن ===== */
const ADMIN_USER = "omido3069@gmail.com";
const ADMIN_PASS = "12345600";
let isAdmin = false;
let currentEditId = null;

/* ===== تسجيل الدخول ===== */
document.getElementById("loginBtn").addEventListener("click", ()=>{
  const user = document.getElementById("username").value;
  const pass = document.getElementById("password").value;
  if(user===ADMIN_USER && pass===ADMIN_PASS){
    isAdmin = true;
    document.querySelectorAll(".adminOnly").forEach(el=>el.style.display="inline-block");
    document.getElementById("addWorkerSection").style.display="block";
    document.getElementById("loginSection").style.display="none";
    document.getElementById("logoutBtn").style.display="block";
    alert("✅ تم تسجيل الدخول كأدمن");
  } else {
    alert("❌ اسم المستخدم أو كلمة السر غير صحيحة");
  }
});

/* ===== تسجيل الخروج ===== */
document.getElementById("logoutBtn").addEventListener("click", ()=>{
  isAdmin = false;
  document.querySelectorAll(".adminOnly").forEach(el=>el.style.display="none");
  document.getElementById("addWorkerSection").style.display="none";
  document.getElementById("loginSection").style.display="block";
  document.getElementById("logoutBtn").style.display="none";
  alert("🚪 تم تسجيل الخروج");
});

/* ===== رفع صورة إلى ImgBB ===== */
async function uploadToImgBB(file){
  const formData = new FormData();
  formData.append("image", file);
  const res = await fetch(`https://api.imgbb.com/1/upload?key=${imgbbAPI}`, {
    method: "POST",
    body: formData
  });
  const data = await res.json();
  if(!res.ok || !data.success){
    console.error("ImgBB Error:", data);
    throw new Error("فشل رفع الصورة");
  }
  return data.data.url;
}

/* ===== تحميل العمال من Firestore ===== */
async function loadWorkers(){
  const workersGrid = document.getElementById("workersGrid");
  workersGrid.innerHTML = "";
  const querySnapshot = await getDocs(collection(db, "workers"));
  querySnapshot.forEach((docSnap)=>{
    renderWorker(docSnap.id, docSnap.data());
  });
}
loadWorkers();

/* ===== رسم الكارت ===== */
function renderWorker(id, worker){
  const grid = document.getElementById("workersGrid");
  const div = document.createElement("div");
  div.className = "col-md-4 worker-card";
  div.innerHTML = `
    <div class="card p-3 text-center">
      <h5 class="fw-bold text-primary"><i class="bi bi-person-badge"></i> ${worker.name}</h5>
      <p class="mb-1 text-secondary"><i class="bi bi-building"></i> ${worker.company}</p>
      <p class="mb-1 text-success"><i class="bi bi-telephone"></i> ${worker.phone}</p>
      <p class="mb-1 text-warning"><i class="bi bi-briefcase"></i> ${worker.job}</p>
      <p class="mb-1 text-danger"><i class="bi bi-credit-card-2-front"></i> ${worker.nid}</p>

      <img src="${worker.imgSrc || 'https://via.placeholder.com/150'}" 
           class="img-fluid rounded mb-2 shadow-sm" 
           style="max-height:150px;object-fit:cover;">

      <button class="btn btn-info btn-sm mb-1" onclick="showImage('${worker.imgSrc || 'https://via.placeholder.com/150'}')">
        <i class="bi bi-eye"></i> عرض البطاقة
      </button>
      <button class="btn btn-warning btn-sm adminOnly" onclick="editWorker('${id}')">
        <i class="bi bi-pencil-square"></i> تعديل
      </button>
      <button class="btn btn-danger btn-sm adminOnly" onclick="deleteWorker('${id}', this)">
        <i class="bi bi-trash"></i> حذف
      </button>
    </div>
  `;
  grid.appendChild(div);
  if(isAdmin){
    div.querySelectorAll(".adminOnly").forEach(el=>el.style.display="inline-block");
  }
}

/* ===== إضافة عامل ===== */
window.addWorker = async function(){
  const name = document.getElementById("name").value.trim();
  const company = document.getElementById("company").value.trim();
  const phone = document.getElementById("phone").value.trim();
  const job = document.getElementById("job").value.trim();
  const nid = document.getElementById("nid").value.trim();
  const fileInput = document.getElementById("idImage");

  if(!name || !company || !phone || !job || !nid){
    alert("⚠️ من فضلك املأ كل الحقول");
    return;
  }

  let imgSrc = "https://via.placeholder.com/150";

  try{
    if(fileInput.files && fileInput.files[0]){
      imgSrc = await uploadToImgBB(fileInput.files[0]);
    }

    await addDoc(collection(db, "workers"), { name, company, phone, job, nid, imgSrc });
    alert("✅ تم إضافة العامل");
    document.getElementById("name").value = "";
    document.getElementById("company").value = "";
    document.getElementById("phone").value = "";
    document.getElementById("job").value = "";
    document.getElementById("nid").value = "";
    document.getElementById("idImage").value = "";
    loadWorkers();
  }catch(err){
    console.error(err);
    alert("❌ حصل خطأ أثناء الإضافة");
  }
}

/* ===== حذف عامل ===== */
window.deleteWorker = async function(id, btn){
  if(!confirm("هل تريد حذف هذا العامل؟")) return;
  await deleteDoc(doc(db, "workers", id));
  btn.closest(".worker-card").remove();
}

/* ===== فتح مودال التعديل ===== */
window.editWorker = async function(id){
  currentEditId = id;
  const docSnap = await getDoc(doc(db,"workers",id));
  if(docSnap.exists()){
    const w = docSnap.data();
    document.getElementById("editName").value = w.name || "";
    document.getElementById("editCompany").value = w.company || "";
    document.getElementById("editPhone").value = w.phone || "";
    document.getElementById("editJob").value = w.job || "";
    document.getElementById("editNid").value = w.nid || "";
    document.getElementById("currentImg").src = w.imgSrc || "https://via.placeholder.com/150";
  }
  const modal = new bootstrap.Modal(document.getElementById('editModal'));
  modal.show();
}

/* ===== حفظ التعديلات ===== */
document.getElementById("saveEditBtn").addEventListener("click", async ()=>{
  if(!currentEditId) return;

  const name = document.getElementById("editName").value.trim();
  const company = document.getElementById("editCompany").value.trim();
  const phone = document.getElementById("editPhone").value.trim();
  const job = document.getElementById("editJob").value.trim();
  const nid = document.getElementById("editNid").value.trim();
  let imgSrc = document.getElementById("currentImg").src;

  const fileInput = document.getElementById("editImage");

  try{
    if(fileInput.files && fileInput.files[0]){
      imgSrc = await uploadToImgBB(fileInput.files[0]);
    }

    await updateDoc(doc(db,"workers",currentEditId), { name, company, phone, job, nid, imgSrc });
    alert("✅ تم حفظ التعديلات");
    currentEditId = null;
    bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
    loadWorkers();
  }catch(err){
    console.error(err);
    alert("❌ حصل خطأ أثناء الحفظ");
  }
});

/* ===== عرض الصورة ===== */
window.showImage = function(src){
  document.getElementById("modalImage").src = src;
  const modal = new bootstrap.Modal(document.getElementById('imageModal'));
  modal.show();
}

/* ===== البحث + التصفية ===== */
document.getElementById("search").addEventListener("input", filterWorkers);
document.getElementById("companyFilter").addEventListener("change", filterWorkers);

function filterWorkers(){
  const searchVal = document.getElementById("search").value.toLowerCase();
  const companyVal = document.getElementById("companyFilter").value;

  document.querySelectorAll("#workersGrid .worker-card").forEach(card=>{
    const text = card.innerText.toLowerCase();
    const company = card.querySelector(".text-secondary").innerText.replace("📌","").trim();
    let show = true;

    if(searchVal && !text.includes(searchVal)) show = false;
    if(companyVal && company !== companyVal) show = false;

    card.style.display = show ? "" : "none";
  });
}
</script>
</body>
</html>
